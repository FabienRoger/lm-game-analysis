["Each", " build", " and", " release", " definition", " in", " T", "FS", " has", " a", " set", " of", " custom", " variables", " assigned", " to", " it", ".", " Those", " variables", " are", " later", " used", " as", " parameters", " to", " PowerShell", "/", "batch", " scripts", ",", " configuration", " file", " transformations", ",", " or", " other", " tasks", " being", " part", " of", " the", " build", "/", "release", " pipeline", ".", " Access", "ing", " them", " from", " a", " task", " resembles", " accessing", " process", " environment", " variables", ".", " Because", " of", " T", "FS", " detailed", " logging", ",", " it", " is", " quite", " common", " that", " values", " saved", " in", " variables", " end", " up", " in", " the", " build", " log", " in", " a", " plain", " text", " form", ".", " That", " is", " one", " of", " the", " reasons", " why", " Microsoft", " implemented", " secret", " variables", ".", "\n", "\n", "The", " screenshot", " below", " presents", " a", " T", "FS", " build", " configuration", " panel", ",", " with", " a", " sample", " secret", " variable", " am", "ip", "rot", "ected", " set", " (", "notice", " the", " highlighted", " pad", "lock", " icon", " on", " the", " right", " side", " of", " the", " text", " box", "):", "\n", "\n", "Once", " the", " secret", " variable", " is", " saved", ",", " it", " is", " no", " longer", " possible", " to", " read", " its", " value", " from", " the", " web", " panel", " (", "when", " you", " click", " on", " the", " pad", "lock", ",", " the", " text", " box", " will", " be", " cleared", ").", "\n", "\n", "And", " this", " is", " how", " the", " output", " log", " looks", " like", " if", " we", " pass", " the", " secret", " variable", " to", " a", " PowerShell", " script", " and", " print", " it", ":", "\n", "\n", "Let", "\ufffd", "\ufffd", "s", " now", " have", " a", " look", " where", " and", " how", " the", " secret", " variables", " are", " stored", ".", "\n", "\n", "How", " secret", " variables", " are", " stored", "\n", "\n", "I", " started", " the", " search", " by", " examining", " the", " T", "FS", " database", " server", ".", " There", " are", " separate", " databases", " for", " each", " team", " collection", ".", " Each", " database", " groups", " tables", " into", " sche", "mas", " with", " easily", " understandable", " names", ",", " such", " as", " Build", ",", " Release", ",", " or", " T", "fs", "Work", "Item", "Tr", "acking", ".", " There", " are", " also", " few", " tables", " in", " the", " default", " d", "bo", " schema", ".", " Our", " secret", " variable", " was", " a", " part", " of", " a", " build", " definition", ",", " thus", " checking", " the", " [", "Build", "]", ".[", "t", "bl", "_", "Definition", "]", " seemed", " like", " a", " valid", " approach", ".", " Here", " is", " the", " screenshot", " of", " the", " first", " few", " columns", " of", " this", " table", ":", "\n", "\n", "The", " Vari", "ables", " column", " lists", " all", " the", " variables", " in", " JSON", " format", ".", " Unfortunately", ",", " I", " didn", "\ufffd", "\ufffd", "t", " learn", " much", " about", " our", " secret", " variable", " (", "except", " that", " it", " is", " secret", " :)", ").", " So", ",", " I", " started", " looking", " for", " a", " table", " named", " \ufffd", "\ufffd", "t", "bl", "_", "Vari", "ables", "\ufffd", "\ufffd", " or", " \ufffd", "\ufffd", "t", "bl", "_", "Sec", "rets", "\ufffd", "\ufffd", ",", " but", " with", " no", " success", ".", " As", " a", " last", " resort", ",", " I", " switched", " to", " the", " tool", " I", " always", " use", " when", " I", " don", "\ufffd", "\ufffd", "t", " know", " what", " is", " going", " on", ":", " proc", "mon", ".", " I", " recorded", " the", " trace", " while", " saving", " the", " secret", " variable", " value", " and", " found", " some", " interesting", " events", " in", " the", " trace", ":", "\n", "\n", "I", " picked", " one", " of", " them", " and", " checked", " its", " call", " stack", ":", "\n", "\n", "Then", " I", " needed", " a", " little", " trick", " to", " decode", " managed", " frames", " in", " proc", "mon", " trace", ".", " The", " last", " frame", " pointed", " to", " the", " Team", "Found", "ation", "Strong", "Box", "Service", ".", "Add", "Stream", " method", ".", " The", " name", " of", " the", " class", " is", " quite", " peculiar", " and", " made", " me", " look", " again", " at", " the", " database", ".", " I", " quickly", " found", " the", " interesting", " tables", ":", " t", "bl", "_", "Strong", "Box", "Draw", "er", ",", "\n", "\n", "t", "bl", "_", "Strong", "Box", "Item", ",", "\n", "\n", "and", " t", "bl", "_", "Sign", "ing", "Key", ".", "\n", "\n", "As", " you", " can", " see", " the", " row", " in", " the", " t", "bl", "_", "Strong", "Box", "Draw", "er", " table", " references", " the", " build", " definition", " and", " groups", " the", " secret", " variables", ".", " The", " t", "bl", "_", "Strong", "Box", "Item", " table", " holds", " all", " the", " values", " the", " secret", " variable", " had", " (", "including", " the", " current", " one", ")", " in", " an", " encrypted", " form", ".", " Finally", ",", " the", " row", " in", " the", " t", "bl", "_", "Sign", "ing", "Key", " table", " stores", " some", " private", " key", ",", " which", " is", " probably", " used", " during", " the", " encryption", " process", ".", "\n", "\n", "It", " was", " time", " to", " fire", " up", " d", "n", "sp", "y", " and", " start", " a", " more", " meticulous", " analysis", ".", " The", " Add", "Stream", " method", " contains", " logic", " for", " adding", " sensitive", " data", " to", " the", " T", "FS", " database", ".", " Firstly", ",", " the", " secret", " value", " is", " encrypted", " using", " AES", " (", "with", " auto", "-", "generated", " key", " and", " a", " random", " initialization", " vector", ")", " and", " saved", " in", " a", " byte", " array", ".", " Secondly", ",", " the", " AES", " key", " is", " encrypted", " using", " the", " signing", " key", " and", " saved", " in", " another", " byte", " array", ".", " Finally", ",", " those", " two", " tables", " and", " the", " initialization", " vector", " are", " saved", " as", " the", " encrypted", " value", " of", " the", " secret", " variable", ".", " In", " our", " case", ",", " the", " value", " looked", " as", " follows", ":", "\n", "\n", "The", " signing", " key", " is", " saved", " in", " a", " form", " of", " a", " RSA", " C", "SP", " blob", ";", " in", " our", " case", ":", "\n", "\n", "After", " retrieving", " the", " data", " from", " the", " database", ",", " you", " may", " use", " this", " sample", " code", " to", " decrypt", " it", ":", "\n", "\n", "byte", "[]", " a", "es", "Key", ";", " using", " (", "RS", "AC", "rypt", "o", "Service", "Provider", " r", "sa", "Crypt", "o", "Service", "Provider", " =", " new", " RS", "AC", "rypt", "o", "Service", "Provider", "(", "20", "48", ",", " new", " C", "sp", "Parameters", " {", " Flags", " =", " C", "sp", "Provider", "Flags", ".", "Use", "Machine", "Key", "Store", " }", "))", " {", " var", " c", "sp", "Bl", "ob", " =", " \"...", "hex", " string", "...\"", ";", " r", "sa", "Crypt", "o", "Service", "Provider", ".", "Import", "C", "sp", "Bl", "ob", "(", "H", "ex", ".", "From", "H", "ex", "String", "(", "c", "sp", "Bl", "ob", "));", " var", " encrypted", "A", "es", "Key", " =", " \"...", "hex", " string", "...\"", ";", " a", "es", "Key", " =", " r", "sa", "Crypt", "o", "Service", "Provider", ".", "Dec", "rypt", "(", "H", "ex", ".", "From", "H", "ex", "String", "(", "encrypted", "A", "es", "Key", "),", " true", ");", " }", " var", " iv", " =", " Hex", ".", "From", "H", "ex", "String", "(\"", "...", "hex", " string", "...\"", ");", " var", " cipher", " =", " Hex", ".", "From", "H", "ex", "String", "(\"", "...", "hex", " string", "...\"", ");", " using", " (", "var", " a", "es", " =", " A", "es", ".", "Create", "())", " {", " var", " transform", " =", " a", "es", ".", "Create", "Dec", "rypt", "or", "(", "a", "es", "Key", ",", " iv", ");", " using", " (", "var", " encrypted", "Stream", " =", " new", " Memory", "Stream", "(", "c", "ipher", "))", " {", " using", " (", "var", " crypto", "Stream", " =", " new", " Crypto", "Stream", "(", "encrypted", "Stream", ",", " transform", ",", " Crypto", "Stream", "Mode", ".", "Read", "))", " {", " using", " (", "var", " dec", "rypted", "Stream", " =", " new", " Memory", "Stream", "())", " {", " crypto", "Stream", ".", "Copy", "To", "(", "dec", "rypted", "Stream", ");", " Console", ".", "Write", "Line", "(", "H", "ex", ".", "Pretty", "Print", "(", "dec", "rypted", "Stream", ".", "To", "Array", "()", "));", " }", " }", " }", " }", "\n", "\n", "As", " you", " can", " see", " the", " t", "bl", "_", "Sign", "ing", "Key", " table", " contains", " really", " sensitive", " data", " and", " you", " should", " make", " sure", " that", " only", " authorized", " users", " can", " access", " it", ".", " I", " am", " a", " bit", " surprised", " that", " no", " DP", "API", " or", " other", " encryption", " mechanism", " is", " used", " here", ".", "\n", "\n", "When", " secret", " variables", " are", " not", " so", " secret", "\n", "\n", "In", " the", " previous", " paragraph", ",", " we", " dec", "rypted", " the", " variables", " using", " the", " data", " stored", " in", " the", " database", ",", " but", " there", " is", " a", " much", " easier", " way", ".", " If", " you", " are", " allowed", " to", " modify", " the", " build", "/", "release", " pipeline", ",", " you", " may", " simply", " create", " a", " PowerShell", " task", " such", " as", " the", " one", " below", ":", "\n", "\n", "As", " there", " is", " a", " space", " between", " the", " first", " letter", " and", " the", " rest", " of", " the", " string", ",", " the", " output", " won", "\ufffd", "\ufffd", "t", " be", " masked", " and", " you", " will", " see", " the", " password", " in", " the", " log", " in", " plain", " text", ":", "\n", "\n", "Thus", ",", " you", " may", " assume", " that", " people", " who", " can", " modify", " the", " build", "/", "release", " pipeline", " or", " who", " can", " edit", " the", " content", " of", " the", " script", " used", " in", " the", " pipeline", " are", " able", " to", " read", " the", " secret", " variables", ".", "\n", "\n", "Ext", "ract", "ing", " secret", " variables", " from", " the", " T", "FS", " memory", "\n", "\n", "Finally", ",", " let", "\ufffd", "\ufffd", "s", " have", " a", " look", " at", " the", " memory", " of", " the", " T", "FS", " server", " process", " (", "w", "3", "wp", ".", "exe", ")", " to", " find", " out", " what", " we", " can", " reveal", " from", " it", ".", " I", " created", " a", " full", " memory", " dump", " of", " the", " process", " and", " opened", " it", " in", " Win", "D", "bg", " (", "with", " SOS", "EX", " and", " SOS", " loaded", ").", " We", " may", " start", " by", " listing", " all", " the", " instances", " of", " the", " Strong", "Box", "Item", "Info", ":", "\n", "\n", "0", ":", "000", ">", "!", "mx", " *.", "Strong", "Box", "Item", "Info", " App", "Domain", " 00000000", "01", "eb", "8", "b", "50", " (/", "LM", "/", "W", "3", "S", "VC", "/", "2", "/", "RO", "OT", "/", "t", "fs", "-", "1", "-", "13", "15", "555", "14", "12", "36", "25", "000", ")", " --------------------------------", "------------------------", "-", " module", ":", " Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", " class", ":", " Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", ".", "Strong", "Box", "Item", "Info", " module", ":", " Microsoft", ".", "Team", "Found", "ation", ".", "Client", " class", ":", " Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Client", ".", "Strong", "Box", "Item", "Info", " \u2026", " 0", ":", "000", ">", ".", "fore", "ach", " (", "addr", " {", "!", "D", "ump", "He", "ap", " -", "short", " -", "mt", " 00", "000", "7", "fe", "925", "60", "f", "80", "})", " {", "!", "md", "t", " addr", " }", "...", " 0000", "000", "20", "34", "19", "dc", "8", " (", "Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", ".", "Strong", "Box", "Item", "Info", ")", " <", "draw", "er", "id", ">", "k", "__", "B", "acking", "Field", ":(", "System", ".", "Gu", "id", ")", " {", "c", "280", "8", "c", "4", "d", "-", "0", "c", "0", "d", "-", "43", "e", "5", "-", "b", "4", "b", "2", "-", "e", "7", "43", "f", "5", "121", "c", "dd", "}", " VAL", "TYPE", " (", "MT", "=", "00000", "7", "fe", "ef", "467", "350", ",", " AD", "DR", "=", "0000000", "20", "34", "19", "df", "8", ")", " <", "item", "kind", ">", "k", "__", "B", "acking", "Field", ":", "0", "x", "00", " (", "String", ")", " (", "Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", ".", "Strong", "Box", "Item", "Kind", ")", " <", "look", "up", "key", ">", "k", "__", "B", "acking", "Field", ":", "0000000", "20", "341", "a", "1", "f", "8", " (", "System", ".", "String", ")", " Length", "=", "24", ",", " String", "=\"", "9", "/", "vari", "ables", "/", "am", "ip", "rot", "ected", "\"", " <", "sign", "ing", "key", "id", ">", "k", "__", "B", "acking", "Field", ":(", "System", ".", "Gu", "id", ")", " {", "c", "280", "8", "c", "4", "d", "-", "0", "c", "0", "d", "-", "43", "e", "5", "-", "b", "4", "b", "2", "-", "e", "7", "43", "f", "5", "121", "c", "dd", "}", " VAL", "TYPE", " (", "MT", "=", "00000", "7", "fe", "ef", "467", "350", ",", " AD", "DR", "=", "0000000", "20", "34", "19", "e", "08", ")", " <", "ex", "piration", "date", ">", "k", "__", "B", "acking", "Field", ":(", "System", ".", "Null", "able", "`", "1", "[[", "System", ".", "Date", "Time", ",", " m", "sc", "or", "lib", "]]", ")", " VAL", "TYPE", " (", "MT", "=", "00000", "7", "fe", "ef", "4", "c", "13", "b", "8", ",", " AD", "DR", "=", "0000000", "20", "34", "19", "e", "18", ")", " <", "c", "red", "ential", "name", ">", "k", "__", "B", "acking", "Field", ":", "NULL", " (", "System", ".", "String", ")", " <", "encrypted", "content", ">", "k", "__", "B", "acking", "Field", ":", "0000000", "20", "341", "a", "3", "f", "0", " (", "System", ".", "Byte", "[", "],", " Elements", ":", " 312", ")", " <", "value", ">", "k", "__", "B", "acking", "Field", ":", "NULL", " (", "System", ".", "String", ")", " <", "file", "id", ">", "k", "__", "B", "acking", "Field", ":", "0", "x", "ffff", "ffff", " (", "System", ".", "Int", "32", ")", " \u2026", "\n", "\n", "The", " Look", "up", "Key", " field", " contains", " the", " name", " of", " the", " variable", ".", " To", " combine", " it", " with", " a", " build", "/", "release", " definition", " we", " would", " need", " to", " find", " an", " instance", " of", " the", " Strong", "Box", "Draw", "er", "Name", " with", " Id", " equal", " to", " c", "280", "8", "c", "4", "d", "-", "0", "c", "0", "d", "-", "43", "e", "5", "-", "b", "4", "b", "2", "-", "e", "7", "43", "f", "5", "121", "c", "dd", ".", " But", " our", " main", " point", " is", " to", " decrypt", " the", " value", " of", " the", " Enc", "rypted", "Content", " field", ".", " For", " that", " we", " need", " to", " have", " the", " Sign", "ing", " Key", " (", "id", ":", " c", "280", "8", "c", "4", "d", "-", "0", "c", "0", "d", "-", "43", "e", "5", "-", "b", "4", "b", "2", "-", "e", "7", "43", "f", "5", "121", "c", "dd", ").", " T", "FS", " keeps", " the", " recently", " used", " Sign", "ing", " Keys", " in", " the", " cache", ",", " so", " if", " we", " are", " lucky", ",", " we", " may", " still", " find", " them", " there", ".", " It", " is", " a", " bit", " longer", " process", " \u2013", " we", " start", " by", " listing", " instances", " of", " the", " Team", "Found", "ation", "Sign", "ing", "Service", "+", "Sign", "ing", "Service", "Cache", " class", ":", "\n", "\n", "0", ":", "000", ">", "!", "mx", " *.", "Team", "Found", "ation", "Sign", "ing", "Service", "+", "Sign", "ing", "Service", "Cache", " module", ":", " Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", " class", ":", " Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", ".", "Team", "Found", "ation", "Sign", "ing", "Service", "+", "Sign", "ing", "Service", "Cache", " 0", ":", "000", ">", "!", "D", "ump", "He", "ap", " -", "mt", " 00", "000", "7", "fe", "9", "32", "d", "99", "e", "0", " Address", " MT", " Size", "...", " 0000", "000", "20", "36", "45", "ce", "0", " 00", "000", "7", "fe", "9", "32", "d", "99", "e", "0", " 96", "\n", "\n", "And", " then", " go", " down", " the", " object", " tree", " to", " our", " precious", " private", " key", ":", "\n", "\n", "Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", ".", "Team", "Found", "ation", "Sign", "ing", "Service", "+", "Sign", "ing", "Service", "Cache", " |", "-", "m", "_", "cache", "Data", " (", "0000000", "203", "64", "60", "a", "0", ")", " |", "-", "m", "_", "cache", " (", "0000000", "203", "646", "368", ")", " |", "-", "m", "_", "d", "ictionary", " (", "0000000", "203", "646", "398", ")", " 0", ":", "000", ">", "!", "md", "t", " 0000", "000", "203", "646", "398", " -", "e", ":", "2", " -", "start", ":", "0", " -", "count", ":", "2", " \u2026", " [", "1", "]", " (", "\u2026)", " VAL", "TYPE", " (", "MT", "=", "00000", "7", "fe", "969", "d", "7", "160", ",", " AD", "DR", "=", "000000", "0100", "d", "6", "d", "510", ")", " key", ":(", "System", ".", "Gu", "id", ")", " {", "c", "280", "8", "c", "4", "d", "-", "0", "c", "0", "d", "-", "43", "e", "5", "-", "b", "4", "b", "2", "-", "e", "7", "43", "f", "5", "121", "c", "dd", "}", " VAL", "TYPE", " (", "MT", "=", "00000", "7", "fe", "ef", "dc", "73", "50", ",", " AD", "DR", "=", "000000", "0100", "d", "6", "d", "520", ")", " value", ":", "0000000", "20", "390", "d", "440", " |", "-", "Value", " (", "0000000", "20", "390", "d", "410", ")", " |", "-", "<", "Value", ">", "k", "__", "B", "acking", "Field", " (", "0000000", "20", "390", "d", "3", "f", "0", ")", " |", "-", "m", "_", "Item", "1", " (", "0000000", "20", "390", "d", "2", "b", "0", ")", " 0", ":", "000", ">", "!", "md", "t", " 0000", "000", "20", "390", "d", "2", "b", "0", " 0000", "000", "20", "390", "d", "2", "b", "0", " (", "Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", ".", "Sign", "ing", "Service", "Key", ")", " <", "key", "data", ">", "k", "__", "B", "acking", "Field", ":", "0000000", "20", "390", "ce", "00", " (", "System", ".", "Byte", "[", "],", " Elements", ":", " 11", "72", ")", " <", "key", "type", ">", "k", "__", "B", "acking", "Field", ":", "0", "x", "0", " (", "R", "SA", "St", "ored", ")", " (", "Microsoft", ".", "Team", "Found", "ation", ".", "Fram", "ework", ".", "Server", ".", "Sign", "ing", "Key", "Type", ")", "\n", "\n", "We", " could", " have", " started", " by", " searching", " instances", " of", " the", " Sign", "ing", "Service", "Key", " class", ",", " but", " then", " we", " would", " need", " to", " print", " the", " GC", " Roots", " for", " each", " of", " them", " to", " check", " if", " its", " Id", " is", " the", " one", " we", " are", " looking", " for", ".", " I", " just", " find", " the", " top", "-", "down", " approach", " easier", " (", "still", " quite", " tedious", " though", ").", "\n", "\n", "Conclusion", "\n", "\n", "I", " hope", " you", " find", " this", " post", " informative", ".", " Based", " on", " what", " we", " have", " analyzed", ",", " we", " can", " say", " that", " it", " is", " possible", " to", " store", " sensitive", " data", " in", " T", "FS", " secret", " variables", " securely", ",", " but", " one", " needs", " to", " make", " sure", " that", ":", "\n", "\n", "only", " authorized", " users", " can", " modify", " build", "/", "release", " pipeline", " (", "including", " the", " content", " of", " the", " tasks", " which", " use", " the", " secret", " variables", ")", "\n", "\n", "only", " authorized", " users", " can", " access", " the", " t", "bl", "_", "Sign", "ing", "Key", " table", " in", " the", " T", "FS", " database", "\n", "\n", "Alternatively", ",", " a", " carefully", " configured", " T", "FS", " agent", " may", " perform", " all", " the", " sensitive", " tasks", ",", " using", " a", " Key", " Vault", " or", " some", " local", " DP", "API", " encrypted", " blob", " as", " a", " secret", " store", "."]