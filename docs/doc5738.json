["B", "illing", "\n", "\n", "require", " \"", "not", "_", "active", "record", "\"", " require", " \"", "depend", "or", "/", "short", "y", "\"", " #", "rem", "oved", " configuration", " options", " for", " clarity", " create", "_", "table", " :", "school", "_", "b", "illing", "_", "lic", "enses", ",", " id", ":", " false", " do", " |", "t", "|", " t", ".", "string", " :", "id", " t", ".", "integer", " :", "school", "_", "id", " t", ".", "integer", " :", "p", "up", "il", "_", "id", " t", ".", "dat", "etime", " :", "activated", "_", "at", " t", ".", "string", " :", "native", "_", "language", " t", ".", "string", " :", "learning", "_", "language", " t", ".", "string", " :", "school", "_", "year", "_", "id", " t", ".", "dat", "etime", " :", "de", "activated", "_", "at", " end", " create", "_", "table", " :", "school", "_", "b", "illing", "_", "sub", "script", "ions", ",", " id", ":", " false", " do", " |", "t", "|", " t", ".", "string", " :", "id", " t", ".", "integer", " :", "school", "_", "id", " t", ".", "string", " :", "native", "_", "language", " t", ".", "string", " :", "learning", "_", "language", " t", ".", "string", " :", "school", "_", "year", "_", "id", " t", ".", "integer", " :", "b", "ought", "_", "lic", "enses", " t", ".", "integer", " :", "used", "_", "lic", "enses", " t", ".", "dec", "imal", " :", "price", " end", " create", "_", "table", " :", "school", "_", "b", "illing", "_", "p", "urch", "ases", ",", " id", ":", " false", " do", " |", "t", "|", " t", ".", "string", " :", "id", " t", ".", "integer", " :", "school", "_", "id", " t", ".", "string", " :", "native", "_", "language", " t", ".", "string", " :", "learning", "_", "language", " t", ".", "string", " :", "school", "_", "year", "_", "id", " t", ".", "integer", " :", "b", "ought", "_", "lic", "enses", " t", ".", "dec", "imal", " :", "price", " t", ".", "dat", "etime", " :", "p", "urch", "ased", "_", "at", " end", " class", " Bill", "ing", " <", " Active", "Record", "::", "Base", " class", " Sub", "scription", " <", " Active", "Record", "::", "Base", " include", " School", "Year", "Serial", "izer", " extend", " Not", "Active", "Record", " does", "_", "not", "_", "bel", "ong", "_", "to", " :", "school", " def", " dictionary", "_", "name", " s", "_", "(\"", "School", "|", "lang", "_", "\"", " +", " learning", "_", "language", ")", " end", " def", " over", "used", "?", " used", "_", "lic", "enses", " >", " bought", "_", "lic", "enses", " end", " def", " cancel", "able", "?", " bought", "_", "lic", "enses", ".", "non", "zero", "?", " end", " end", " class", " License", " <", " Active", "Record", "::", "Base", " include", " School", "Year", "Serial", "izer", " extend", " Not", "Active", "Record", " does", "_", "not", "_", "bel", "ong", "_", "to", " :", "school", " does", "_", "not", "_", "bel", "ong", "_", "to", " :", "p", "up", "il", " end", " class", " Purchase", " <", " Active", "Record", "::", "Base", " include", " School", "Year", "Serial", "izer", " extend", " Not", "Active", "Record", " does", "_", "not", "_", "bel", "ong", "_", "to", " :", "school", " end", " class", " Sub", "scription", "Price", "Cal", "cul", "ator", " takes", " :", "school", "_", "year", ",", " :", "b", "ought", "_", "lic", "enses", ",", " :", "now", " def", " price", " raise", " Argument", "Error", " if", " months", "_", "to", "_", "pay", " >=", " 13", " raise", " Argument", "Error", " if", " months", "_", "to", "_", "pay", " <=", " 0", " price", " =", " price", "_", "per", "_", "license", " *", " bought", "_", "lic", "enses", " *", " Big", "Dec", "imal", ".", "new", "(", "months", "_", "to", "_", "pay", ")", " /", " Big", "Dec", "imal", ".", "new", "(", "12", ")", " price", ".", "round", "(", "2", ",", " Big", "Dec", "imal", "::", "R", "OUND", "_", "H", "AL", "F", "_", "UP", ")", " end", " private", " def", " months", "_", "to", "_", "pay", " if", " now", " <", " school", "_", "year", ".", "st", "arts", "_", "at", " 12", " else", " (", "school", "_", "year", ".", "ends", "_", "at", ".", "year", " *", " 12", " +", " school", "_", "year", ".", "ends", "_", "at", ".", "month", ")", " -", " (", "now", ".", "year", " *", " 12", " +", " now", ".", "month", ")", " +", " 1", " end", " end", " def", " price", "_", "per", "_", "license", " Big", "Dec", "imal", ".", "new", "(\"", "2", ".", "5", "\")", " end", " end", " self", ".", "table", "_", "name", " =", " \"", "school", "s", "\"", " has", "_", "many", " :", "sub", "script", "ions", ",", " class", "_", "name", ":", " \"", "::", "School", "::", "B", "illing", "::", "Sub", "scription", "\",", " foreign", "_", "key", ":", " \"", "school", "_", "id", "\",", " autos", "ave", ":", " true", " has", "_", "many", " :", "lic", "enses", ",", " class", "_", "name", ":", " \"", "::", "School", "::", "B", "illing", "::", "License", "\",", " foreign", "_", "key", ":", " \"", "school", "_", "id", "\",", " autos", "ave", ":", " true", " has", "_", "many", " :", "p", "urch", "ases", ",", " class", "_", "name", ":", " \"", "::", "School", "::", "B", "illing", "::", "Purchase", "\",", " foreign", "_", "key", ":", " \"", "school", "_", "id", "\",", " autos", "ave", ":", " true", " def", " used", "_", "lic", "enses", "(", "p", "up", "il", "_", "ids", ",", " native", "_", "language", ",", " learning", "_", "l", "anguages", ",", " school", "_", "year", ",", " at", "_", "time", ")", " pupil", "_", "ids", " =", " Array", ".", "wrap", "(", "p", "up", "il", "_", "ids", ")", " Array", ".", "wrap", "(", "learning", "_", "l", "anguages", ").", "each", " do", " |", "learning", "_", "language", "|", " s", " =", " subscription", "_", "for", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ")", " s", ".", "used", "_", "lic", "enses", " +=", " pupil", "_", "ids", ".", "size", " pupil", "_", "ids", ".", "each", " do", " |", "p", "up", "il", "_", "id", "|", " licenses", ".", "build", " do", " |", "l", "|", " l", ".", "id", " =", " Secure", "Random", ".", "uu", "id", " l", ".", "p", "up", "il", "_", "id", " =", " pupil", "_", "id", " l", ".", "activated", "_", "at", " =", " at", "_", "time", " l", ".", "native", "_", "language", " =", " native", "_", "language", " l", ".", "learning", "_", "language", " =", " learning", "_", "language", " l", ".", "school", "_", "year", " =", " school", "_", "year", " end", " end", " end", " end", " def", " terminated", "_", "lic", "enses", "(", "p", "up", "il", "_", "ids", ",", " native", "_", "language", ",", " learning", "_", "l", "anguages", ",", " school", "_", "year", ",", " at", "_", "time", ")", " pupil", "_", "ids", " =", " Array", ".", "wrap", "(", "p", "up", "il", "_", "ids", ")", " Array", ".", "wrap", "(", "learning", "_", "l", "anguages", ").", "each", " do", " |", "learning", "_", "language", "|", " s", " =", " subscription", "_", "for", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ")", " s", ".", "used", "_", "lic", "enses", " -=", " pupil", "_", "ids", ".", "size", " pupil", "_", "ids", ".", "each", " do", " |", "p", "up", "il", "_", "id", "|", " license", " =", " licenses", ".", "find", " do", " |", "l", "|", " l", ".", "p", "up", "il", "_", "id", " ==", " pupil", "_", "id", " &&", " l", ".", "native", "_", "language", " ==", " native", "_", "language", " &&", " l", ".", "learning", "_", "language", " ==", " learning", "_", "language", " &&", " l", ".", "school", "_", "year", " ==", " school", "_", "year", " &&", " l", ".", "de", "activated", "_", "at", ".", "nil", "?", " end", " license", ".", "de", "activated", "_", "at", " =", " at", "_", "time", " end", " end", " end", " def", " subscriptions", "_", "for", "(", "native", "_", "language", ",", " learning", "_", "l", "anguages", ",", " school", "_", "years", ")", " Array", ".", "wrap", "(", "learning", "_", "l", "anguages", ").", "map", " do", " |", "ll", "|", " Array", ".", "wrap", "(", "school", "_", "years", ").", "map", " do", " |", "sy", "|", " subscriptions", ".", "find", " do", " |", "s", "|", " s", ".", "native", "_", "language", " ==", " native", "_", "language", " &&", " s", ".", "learning", "_", "language", " ==", " ll", " &&", " s", ".", "school", "_", "year", " ==", " sy", " end", " ||", " subscriptions", ".", "build", " do", " |", "s", "|", " s", ".", "id", " =", " Secure", "Random", ".", "uu", "id", " s", ".", "native", "_", "language", " =", " native", "_", "language", " s", ".", "learning", "_", "language", " =", " ll", " s", ".", "school", "_", "year", " =", " sy", " s", ".", "used", "_", "lic", "enses", " =", " 0", " s", ".", "b", "ought", "_", "lic", "enses", " =", " 0", " s", ".", "price", " =", " 0", " end", " end", " end", ".", "fl", "atten", " end", " def", " subscription", "_", "for", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ")", " subscriptions", "_", "for", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ").", "first", " end", " Purch", "asing", "Not", "Enough", "Lic", "enses", " =", " Class", ".", "new", "(", "Standard", "Error", ")", " def", " buy", "_", "sub", "scription", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ",", " bought", "_", "lic", "enses", ",", " at", ")", " s", " =", " subscription", "_", "for", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ")", " raise", " Purch", "asing", "Not", "Enough", "Lic", "enses", " if", " s", ".", "b", "ought", "_", "lic", "enses", " +", " bought", "_", "lic", "enses", " <", " 40", " price", " =", " Sub", "scription", "Price", "Cal", "cul", "ator", ".", "new", "(", "school", "_", "year", ",", " bought", "_", "lic", "enses", ",", " at", ").", "price", " purchase", " =", " purchases", ".", "build", " do", " |", "p", "|", " p", ".", "id", " =", " Secure", "Random", ".", "uu", "id", " p", ".", "native", "_", "language", " =", " native", "_", "language", " p", ".", "learning", "_", "language", " =", " learning", "_", "language", " p", ".", "school", "_", "year", " =", " school", "_", "year", " p", ".", "b", "ought", "_", "lic", "enses", " =", " bought", "_", "lic", "enses", " p", ".", "price", " =", " price", " p", ".", "p", "urch", "ased", "_", "at", " =", " at", " end", " s", ".", "b", "ought", "_", "lic", "enses", " +=", " purchase", ".", "b", "ought", "_", "lic", "enses", " s", ".", "price", " +=", " purchase", ".", "price", " s", " end", " def", " cancel", "_", "sub", "scription", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ",", " at", ")", " s", " =", " subscription", "_", "for", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ")", " purchases", ".", "build", " do", " |", "p", "|", " p", ".", "id", " =", " Secure", "Random", ".", "uu", "id", " p", ".", "native", "_", "language", " =", " native", "_", "language", " p", ".", "learning", "_", "language", " =", " learning", "_", "language", " p", ".", "school", "_", "year", " =", " school", "_", "year", " p", ".", "b", "ought", "_", "lic", "enses", " =", " -", "s", ".", "b", "ought", "_", "lic", "enses", " p", ".", "price", " =", " s", ".", "price", " *", " Big", "Dec", "imal", ".", "new", "(-", "1", ")", " p", ".", "p", "urch", "ased", "_", "at", " =", " at", " end", " s", " =", " subscription", "_", "for", "(", "native", "_", "language", ",", " learning", "_", "language", ",", " school", "_", "year", ")", " s", ".", "b", "ought", "_", "lic", "enses", " =", " 0", " s", ".", "price", " =", " 0", " s", " end", " #", " some", " domain", " methods", " removed", " end"]