["F", "ib", "ers", " &", " Cooperative", " Sched", "uling", " in", " Ruby", "\n", "\n", "Contin", "uations", " have", " been", " a", " part", " of", " the", " Ruby", " API", " for", " quite", " some", " time", ",", " but", " for", " a", " variety", " of", " reasons", " have", " not", " seen", " much", " practical", " use", ":", " early", " Ruby", " 1", ".", "8", " implementations", " suffered", " from", " serious", " memory", " leak", " problems", ",", " which", " were", " consequently", " mostly", " resolved", ",", " and", " the", " somewhat", " academic", " nature", " of", " the", " concept", " didn", "'t", " help", " either", ".", " However", ",", " with", " the", " production", " versions", " of", " Ruby", " 1", ".", "9", " out", " in", " the", " wild", ",", " contin", "uations", " (", "now", " known", " as", " Fib", "ers", ")", " deserve", " a", " second", " look", ".", "\n", "\n", "Unlike", " a", " function", ",", " which", " has", " a", " defined", " entry", " and", " exit", " point", ",", " a", " continuation", " can", " return", " (", "y", "ield", ")", " many", " times", " over", ",", " which", " means", " that", " the", " execution", " of", " a", " Fiber", " can", " be", " arbitrarily", " suspended", " and", " then", " resumed", " from", " the", " same", " point", ".", " While", " somewhat", " subtle", ",", " this", " is", " actually", " a", " very", " practical", " feature", ":", " contin", "uations", " implicitly", " preserve", " state", " without", " having", " the", " programmer", " to", " worry", " about", " it", ".", "\n", "\n", "F", "iber", " Performance", " in", " Ruby", "\n", "\n", "Contin", "uations", " in", " Ruby", " 1", ".", "8", " (", "MRI", ")", " suffered", " from", " a", " number", " of", " serious", " performance", " problems", ",", " but", " the", " introduction", " of", " Fib", "ers", " in", " Ruby", " 1", ".", "9", " warrants", " that", " we", " revisit", " the", " concept", ".", " First", " of", " all", ",", " Fib", "ers", " are", " now", " cheaper", " to", " create", " and", " perform", " better", " than", " threads", " due", " to", " their", " nature", " as", " a", " lightweight", " context", ".", " And", " even", " better", ",", " they", " give", " us", " the", " ability", " to", " do", " cooperative", " scheduling", " -", " instead", " of", " using", " the", " preempt", "ive", " context", " switch", " model", " we", "'re", " all", " used", " to", " with", " thread", "ing", ",", " we", " can", " manually", " schedule", " Fib", "ers", " to", " pass", " control", " back", " and", " forth", " whenever", " we", " want", " to", ".", "\n", "\n", "Let", "'s", " take", " a", " look", " at", " an", " admittedly", " cont", "rived", ",", " but", " also", " a", " realistic", " scenario", ":", " two", " execution", " threads", ";", " one", " thread", " blocks", " for", " 40", "ms", " on", " an", " IO", " call", " and", " then", " takes", " 10", "ms", " to", " post", "-", "process", " the", " data", ";", " second", " thread", " needs", " 50", "ms", " of", " pure", " CPU", " time", ";", " vs", " same", " scenario", " implemented", " with", " Fib", "ers", " and", " cooperative", " scheduling", ".", "\n", "\n", "By", " default", ",", " Ruby", " MRI", " uses", " a", " fair", " sched", "uler", ",", " which", " means", " that", " each", " thread", " is", " given", " an", " equal", " time", " to", " run", " (", "10", "ms", " quantum", ")", " before", " it", " is", " suspended", " and", " the", " next", " thread", " is", " put", " in", " control", ".", " If", " one", " of", " your", " threads", " is", " inside", " a", " blocking", " call", " during", " those", " 10", "ms", ",", " think", " of", " it", " as", " time", " wasted", " -", " everyone", " is", " sleeping", "!", " By", " contrast", ",", " Fib", "ers", " force", " the", " programmer", " to", " do", " explicit", " scheduling", " which", " can", " certainly", " add", " to", " the", " complexity", " of", " the", " program", ",", " but", " offer", " us", " the", " full", " flexibility", " of", " determining", " how", " our", " CPU", " resources", " are", " used", " and", " also", " help", " us", " avoid", " the", " need", " for", " locks", " in", " mut", "ex", "es", " in", " our", " code", "!", "\n", "\n", "F", "ib", "ers", " and", " Cooperative", " IO", " Sched", "uling", "\n", "\n", "Event", "-", "driven", " and", " asynchronous", " programming", " models", " are", " great", " candidates", " for", " application", " of", " Fib", "ers", ".", " Ruby", " Event", "Machine", " allows", " us", " to", " as", "ynchron", "ously", " defer", " blocks", " of", " code", " to", " be", " executed", " when", " the", " resource", " (", "socket", ",", " file", " descriptor", ",", " etc", ")", " responds", ",", " which", " means", " that", " unlike", " a", " regular", " Net", "::", "HTTP", " call", ",", " we", " don", "'t", " have", " to", " spin", "-", "wait", " indefinitely", " for", " the", " response", ".", " However", ",", " this", " model", " comes", " at", " a", " cost", ":", " it", " is", " often", " hard", " to", " retro", "fit", " code", " with", " asynchronous", " libraries", " because", " the", " call", "backs", " have", " to", " be", " nested", " and", " the", " abstraction", " often", " breaks", " down", " (", "comp", "are", " em", "-", "http", "-", "request", " to", " net", "/", "http", " API", ").", "\n", "\n", "F", "ib", "ers", " solve", " this", " problem", " for", " us", " by", " allowing", " us", " to", " turn", " an", " asynchronous", " library", " into", " what", " looks", " like", " a", " synchron", "ous", " API", " without", " losing", " the", " advantages", " of", " IO", "-", "sc", "hed", "uling", " of", " the", " asynchronous", " execution", ":", "\n", "\n", "require", " '", "event", "machine", "'", " require", " '", "em", "-", "http", "'", " require", " '", "f", "iber", "'", " def", " async", "_", "f", "etch", " (", " url", " )", " f", " =", " Fiber", ".", " current", " http", " =", " Event", "Machine", " ::", " H", "ttp", "Request", ".", " new", " (", " url", " )", ".", " get", " :", "timeout", " =>", " 10", " http", ".", " callback", " {", " f", ".", " resume", " (", " http", " )", " }", " http", ".", " err", "back", " {", " f", ".", " resume", " (", " http", " )", " }", " return", " Fiber", ".", " yield", " end", " Event", "Machine", ".", " run", " do", " Fiber", ".", " new", " {", " puts", " \"", "Setting", " up", " HTTP", " request", " #", "1", "\"", " data", " =", " async", "_", "f", "etch", " (", " '", "http", "://", "www", ".", "google", ".", "com", "/", "'", " )", " puts", " \"", "F", "et", "ched", " page", " #", "1", ":", " #", "{", " data", ".", " response", "_", "header", ".", " status", " }", " \"", " Event", "Machine", ".", " stop", " }", ".", " resume", " end", " #", " Setting", " up", " HTTP", " request", " #", "1", " #", " Fet", "ched", " page", " #", "1", ":", " 302", "\n", "\n", "Running", " the", " following", " code", " shows", " in", "-", "order", " output", ",", " which", " means", " that", " we", "'ve", " simulated", " a", " synchron", "ous", " API", " while", " using", " an", " asynchronous", " library", "!", " Now", " imagine", " running", " multiple", " fibers", " in", " parallel", " while", " repeating", " this", " pattern", ":", " you", " will", " have", " inter", "le", "aved", " execution", " which", " will", " be", " scheduled", " via", " IO", " interrupts", " -", " no", " extra", " context", " switches", ",", " no", " locks", "!", "\n", "\n", "Joe", " Dam", "ato", " and", " Aman", " Gupta", " ported", " the", " functionality", " of", " Fib", "ers", " to", " Ruby", " 1", ".", "8", ".(", "6", "|", "7", "),", " and", " also", " provide", " a", " great", " example", " of", " converting", " the", " asynchronous", " MySQL", " driver", " to", " work", " in", " synchron", "ous", " fashion", ".", " Looking", " for", " more", "?", " Take", " a", " look", " at", " an", " implementation", " of", " Fut", "ures", " in", " Ruby", " and", " the", " Never", "block", " library", ".", "\n", "\n", "Co", "operative", " Sched", "uling", ":", " M", " Thread", "s", " +", " N", " Fib", "ers", " Model", "\n", "\n", "While", " manual", " scheduling", " of", " Fib", "ers", " may", " seem", " like", " a", " high", " cost", ",", " much", " of", " it", " can", " be", " abstract", "ed", " into", " the", " underlying", " libraries", " and", " the", " potential", " benefits", " are", " enormous", ":", " cooperative", " scheduling", " is", " the", " optimal", " scheduling", " model", " and", " it", " does", " not", " incur", " the", " complexity", " inherent", " with", " thread", "ing", ".", " Having", " said", " that", ",", " there", " is", " still", " a", " place", " for", " threads", "!", "\n", "\n", "F", "ib", "ers", " will", " not", " give", " you", " conc", "urrency", " on", " multi", "-", "core", " systems", " and", " they", " can", " only", " be", " resumed", " in", " the", " thread", " that", " created", " them", ".", " Hence", ",", " if", " we", " were", " aiming", " for", " the", " optimal", " resource", " utilization", ":", " run", " M", " threads", ",", " where", " M", " corresponds", " to", " number", " of", " cores", ",", " and", " optimize", " the", " number", " of", " Fib", "ers", " (", "N", ")", " which", " can", " run", " within", " each", " thread", ".", " This", " way", " we", " can", " utilize", " all", " the", " available", " cores", ",", " and", " also", " take", " advantage", " of", " the", " IO", " scheduling", " model", "!", "\n", "\n", "F", "ib", "ers", " in", " J", "Ruby", ",", " Rubin", "ius", " and", " Other", " Applications", "\n", "\n", "Unlike", " the", " MRI", " Ruby", " VM", ",", " both", " J", "Ruby", " and", " Rubin", "ius", " implement", " \"", "Poor", " Man", "'s", " Fib", "ers", "\"", " where", " each", " Fiber", " is", " in", " fact", ",", " mapped", " to", " a", " native", " thread", ".", " This", " of", " course", " lo", "oses", " on", " the", " conceptual", " efficiency", " side", " when", " compared", " to", " MRI", ",", " but", " it", " still", " remains", " a", " viable", " and", " a", " more", " efficient", " option", " than", " the", " pure", " preempt", "ive", " scheduling", ".", "\n", "\n", "In", " fact", ",", " while", " Fib", "ers", " are", " great", " tool", " for", " abstract", "ing", " asynchronous", " execution", ",", " they", " are", " also", " great", " for", " lazy", " evaluation", " patterns", " (", "such", " as", " Gener", "ators", ")", " and", " can", " even", " be", " used", " to", " add", " state", "/", "session", " persistence", " to", " the", " HTTP", " protocol", "!", " Wee", " is", " a", " Ruby", " contin", "uations", " based", " web", " framework", ",", " which", " is", " likely", " inspired", " by", " some", " of", " Paul", " Graham", "s", " work", " at", " Via", "web", " (", "great", " read", ").", " Get", " Ruby", " 1", ".", "9", " on", " your", " system", ",", " give", " Fib", "ers", " a", " try", "!"]