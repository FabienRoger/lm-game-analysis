["Opt", "im", "izing", " Lever", " PNG", " loading", "\n", "\n", "The", " following", " code", " took", " over", " 9", ".", "4", " seconds", " to", " run", ":", "\n", "\n", "import", " p", "ng", " for", " i", " in", " range", "(", "10", ")", " image", " =", " p", "ng", ".", "read", "_", "file", "(", "dir", " ++", " \"", "fr", "ants", "_", "bo", "e", "_", "vill", "ender", "_", "test", ".", "png", "\")", "\n", "\n", "The", " image", " to", " load", " was", " a", " 640", "x", "480", " RG", "BA", " image", " from", " a", " painting", " of", " Fr", "ants", " D", "ider", "ik", " B", "\u00f8", "e", ",", " who", " specialized", " in", " still", " life", " and", " landscapes", ".", "\n", "\n", "The", " program", " became", " slow", " when", " I", " added", " the", " scan", "line", " filtering", ",", " so", " I", " would", " expect", " to", " know", " what", " slows", " it", " down", ".", " But", " I", " am", " really", " not", " on", " the", " mood", " of", " guessing", " wrong", ",", " so", " let", "'s", " run", " the", " code", " through", " a", " prof", "iler", " like", " this", ":", "\n", "\n", "import", " p", "ng", ",", " fs", ",", " vm", "prof", " vm", "prof", "_", "fd", " =", " fs", ".", "open", "(", "dir", " ++", " \"", "png", ".", "vm", "prof", "\",", " fs", ".", "WR", "ON", "LY", " |", " fs", ".", "TR", "UN", "C", " |", " fs", ".", "CRE", "AT", ")", " vm", "prof", ".", "enable", "(", "vm", "prof", "_", "fd", ",", " 0", ".", "0001", ")", " for", " i", " in", " range", "(", "10", ")", " image", " =", " p", "ng", ".", "read", "_", "file", "(", "dir", " ++", " \"", "fr", "ants", "_", "bo", "e", "_", "vill", "ender", "_", "test", ".", "png", "\")", " vm", "prof", ".", "disable", "()", " vm", "prof", "_", "fd", ".", "close", "()", "\n", "\n", "The", " prof", "iler", " output", ":", "\n", "\n", "100", ".", "0", "%", " L", "3", "_", "16", " 100", ".", "0", "%", " p", "ng", "_", "load", ".", "lc", ":", "3", " (", "line", " 5", " at", " this", " post", ")", " 100", ".", "0", "%", "..", " L", "5", "_", "39", " 100", ".", "0", "%", " p", "ng", ".", "lc", ":", "5", " 99", ".", "6", "%", "....", " L", "53", "_", "82", " 99", ".", "6", "%", " p", "ng", ".", "lc", ":", "53", " 0", ".", "1", "%", "......", " L", "87", "_", "90", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "87", " 0", ".", "1", "%", "......", " L", "90", "_", "96", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "90", " 49", ".", "4", "%", "......", " L", "99", "_", "101", " 49", ".", "6", "%", " p", "ng", ".", "lc", ":", "99", " 35", ".", "4", "%", "........", " L", "104", "_", "117", " 71", ".", "6", "%", " p", "ng", ".", "lc", ":", "104", " 16", ".", "9", "%", "..........", " L", "117", "_", "131", " 47", ".", "9", "%", " p", "ng", ".", "lc", ":", "117", " 0", ".", "6", "%", "......", " L", "96", "_", "99", " 0", ".", "6", "%", " p", "ng", ".", "lc", ":", "96", " 0", ".", "3", "%", "....", " L", "142", "_", "159", " 0", ".", "3", "%", " p", "ng", ".", "lc", ":", "142", " 0", ".", "1", "%", "......", " L", "159", "_", "161", " 37", ".", "5", "%", " p", "ng", ".", "lc", ":", "159", "\n", "\n", "At", " the", " p", "ng", ".", "lc", ":", "53", " we", " have", " the", " code", " that", " runs", " a", " decoding", " loop", ":", "\n", "\n", "read", " =", " (", "self", ",", " data", "):", " data", " =", " self", ".", "z", ".", "dec", "omp", "ress", "(", "data", ")", " for", " byte", " in", " data", " if", " self", ".", "new", "_", "scan", "line", " self", ".", "filter", " =", " decode", "_", "fil", "ters", "[", "byte", "]", " self", ".", "new", "_", "scan", "line", " =", " false", " continue", " if", " self", ".", "l", " ==", " 0", " u", " =", " 0", " c", " =", " 0", " if", " self", ".", "x", " -", " self", ".", "str", "ide", " >=", " self", ".", "l", " l", " =", " self", ".", "data", "[", "self", ".", "x", " -", " self", ".", "str", "ide", "]", " else", " l", " =", " 0", " else", " u", " =", " self", ".", "data", "[", "self", ".", "x", " -", " self", ".", "y", "_", "str", "ide", "]", " if", " self", ".", "x", " -", " self", ".", "str", "ide", " >=", " self", ".", "l", " l", " =", " self", ".", "data", "[", "self", ".", "x", " -", " self", ".", "str", "ide", "]", " c", " =", " self", ".", "data", "[", "self", ".", "x", " -", " self", ".", "y", "_", "str", "ide", " -", " self", ".", "str", "ide", "]", " else", " l", " =", " 0", " c", " =", " 0", " self", ".", "data", "[", "self", ".", "x", "]", " =", " self", ".", "filter", "(", "byte", ",", " l", ",", " u", ",", " c", ")", " self", ".", "x", " +=", " 1", " if", " self", ".", "x", " >=", " self", ".", "r", " self", ".", "l", " +=", " self", ".", "y", "_", "str", "ide", " self", ".", "r", " +=", " self", ".", "y", "_", "str", "ide", " self", ".", "new", "_", "scan", "line", " =", " true", "\n", "\n", "It", " tells", " that", " almost", " half", " of", " the", " time", " is", " spent", " in", " the", " p", "ng", ".", "lc", ":", "99", ".", "\n", "\n", "dec", "ode", "_", "fil", "ters", " =", " {", " 4", ":", " (", "byte", ",", " l", ",", " u", ",", " c", "):", " return", " byte", " +", " pa", "eth", "_", "p", "redict", "or", "(", "l", ",", " u", ",", " c", ")", " }", " pa", "eth", "_", "p", "redict", "or", " =", " (", "a", ",", " b", ",", " c", "):", " p", " =", " a", " +", " b", " -", " c", " pa", " =", " abs", "_", "int", "(", "p", " -", " a", ")", " p", "b", " =", " abs", "_", "int", "(", "p", " -", " b", ")", " pc", " =", " abs", "_", "int", "(", "p", " -", " c", ")", " if", " pa", " <=", " p", "b", " and", " pa", " <=", " pc", " return", " a", " el", "if", " p", "b", " <=", " pc", " return", " b", " else", " return", " c", " #", " TOD", "O", ":", " make", " them", " into", " mult", "imet", "hod", "s", " abs", "_", "int", " =", " (", "a", "):", " if", " a", " <", " 0", " return", " -", "a", " return", " a", "\n", "\n", "The", " Line", " 60", " is", " the", " pa", "eth", "_", "p", "redict", "or", ".", " And", " 73", " is", " the", " abs", "_", "int", ".", "\n", "\n", "M", "otive", "\n", "\n", "There", " are", " many", " C", " libraries", " meant", " for", " loading", " PNG", " images", ",", " that", " I", " could", " have", " integrated", " into", " my", " runtime", ".", "\n", "\n", "L", "ever", " is", " a", " gradually", " designed", " programming", " language", ".", " The", " observations", " made", " about", " the", " behavior", " of", " the", " language", " are", " used", " to", " improve", " it", " even", " further", ".", " The", " intention", " is", " to", " leave", " in", " the", " possibility", " for", " changing", " the", " language", ",", " so", " that", " the", " language", " can", " refine", " over", " time", " to", " meet", " on", " newly", " made", " discoveries", ".", "\n", "\n", "One", " of", " my", " objectives", " with", " Lever", " is", " to", " make", " it", " into", " a", " high", " level", " programming", " language", " that", " ob", "tains", " good", " runtime", " performance", " own", " its", " own", ",", " and", " then", " supply", " it", " with", " utilities", " to", " optimize", " those", " implementations", " to", " match", " the", " performance", " that", " is", " obtain", "able", " with", " the", " C", " language", ".", "\n", "\n", "To", " do", " this", " anywhere", " else", ",", " we", " need", " to", " get", " started", " with", " something", " simple", ",", " and", " it", " would", " be", " preferable", " to", " be", " practical", ".", " Therefore", " I", " decided", " to", " write", " my", " own", " PNG", " implementation", " in", " Lever", ".", "\n", "\n", "First", " the", " abs", " mult", "imet", "hod", "\n", "\n", "The", " abs", "_", "int", " is", " a", " cr", "utch", " that", " I", " made", " because", " Lever", "'s", " abs", " -", "function", " only", " operates", " on", " floats", ".", " The", " limitation", " isn", "'t", " very", " elegant", " though", ".", " I", "'ve", " intended", " to", " remove", " it", " when", " it", " becomes", " more", " relevant", ".", "\n", "\n", "When", " you", "'re", " optimizing", " code", ",", " it", " would", " be", " preferable", " to", " start", " with", " a", " version", " that", " doesn", "'t", " have", " any", " cr", "ut", "ches", " originating", " from", " unim", "ple", "mented", " features", " in", " the", " programming", " language", "'s", " runtime", ",", " so", " the", " first", " obvious", " thing", " here", " is", " to", " remove", " the", " abs", "_", "int", " and", " replace", " it", " with", " properly", " implemented", " abs", " mult", "imet", "hod", ".", "\n", "\n", "The", " implementation", " of", " abs", " is", " in", " the", " runtime", "/", "ve", "ct", "orm", "ath", ".", "py", ".", " As", " pointed", " out", " by", " the", " documentation", " for", " abs", "().", " We", " replace", " it", " with", " the", " mult", "imet", "hod", " implementation", ":", "\n", "\n", "abs", "_", " =", " Mult", "imet", "hod", "(", "1", ")", " @", "abs", "_.", "mult", "imet", "hod", "_", "s", "(", "Float", ")", " def", " abs", "_", "float", "(", "f", "):", " return", " Float", "(-", "f", ".", "number", ")", " if", " f", ".", "number", " <", " 0", ".", "0", " else", " f", ".", "number", " @", "abs", "_.", "mult", "imet", "hod", "_", "s", "(", "Integer", ")", " def", " abs", "_", "int", "(", "i", "):", " return", " Integer", "(-", "i", ".", "value", ")", " if", " i", ".", "value", " <", " 0", " else", " i", "\n", "\n", "The", " Lever", " runtime", " needs", " to", " be", " ret", "rans", "lated", " for", " the", " changes", " to", " take", " effect", ".", " We", " can", " remove", " the", " abs", "_", "int", " and", " replace", " it", " with", " abs", " in", " the", " pa", "eth", "_", "p", "redict", "or", ".", "\n", "\n", "Meanwhile", " we", " have", " time", " to", " think", " about", " the", " pa", "eth", " predictor", ".", " When", " you", " look", " at", " the", " variable", " flow", ",", " every", " math", " operation", " appears", " to", " require", " the", " previous", " value", ".", " This", " is", " an", " important", " observation", " because", " we", " are", " running", " on", " a", " supers", "cal", "ar", " processor", ".", "\n", "\n", "Although", " we", " are", " still", " somewhere", " on", " the", " dark", " side", " of", " the", " moon", " when", " it", " comes", " to", " the", " instruction", "-", "level", " optimizations", ".", " When", " I", " run", " the", " program", " again", ",", " it", " now", " takes", " 8", " seconds", " to", " run", ".", "\n", "\n", "100", ".", "0", "%", " L", "3", "_", "16", " 100", ".", "0", "%", " p", "ng", "_", "load", ".", "lc", ":", "3", " (", "line", " 5", ")", " 100", ".", "0", "%", "..", " L", "5", "_", "39", " 100", ".", "0", "%", " p", "ng", ".", "lc", ":", "5", " 99", ".", "4", "%", "....", " L", "53", "_", "82", " 99", ".", "4", "%", " p", "ng", ".", "lc", ":", "53", " (", "line", " 27", ")", " 0", ".", "9", "%", "......", " L", "96", "_", "99", " 0", ".", "9", "%", " p", "ng", ".", "lc", ":", "96", " 0", ".", "2", "%", "......", " L", "90", "_", "96", " 0", ".", "2", "%", " p", "ng", ".", "lc", ":", "90", " 32", ".", "4", "%", "......", " L", "99", "_", "101", " 32", ".", "6", "%", " p", "ng", ".", "lc", ":", "99", " (", "line", " 56", ")", " 15", ".", "3", "%", "........", " L", "104", "_", "125", " 47", ".", "1", "%", " p", "ng", ".", "lc", ":", "104", " (", "line", " 60", ")", " 0", ".", "1", "%", "......", " L", "87", "_", "90", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "87", " 0", ".", "4", "%", "....", " L", "136", "_", "153", " 0", ".", "4", "%", " p", "ng", ".", "lc", ":", "136", " 0", ".", "3", "%", "......", " L", "153", "_", "155", " 62", ".", "5", "%", " p", "ng", ".", "lc", ":", "153", " 0", ".", "1", "%", "....", " L", "125", "_", "136", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "125", " 0", ".", "1", "%", "......", " L", "153", "_", "155", " 100", ".", "0", "%", " p", "ng", ".", "lc", ":", "153", "\n", "\n", "So", " in", " total", " we", " shaved", " 17", "%", " with", " that", " small", " change", ".", " But", " it", " is", " still", " the", " pa", "eth", " predictor", " and", " the", " PNG", " decoding", " loop", " that", "'s", " slowing", " us", " down", ".", "\n", "\n", "Check", "ing", " the", " J", "IT", " traces", "\n", "\n", "The", " J", "IT", " trace", " is", " perhaps", " showing", " us", " something", " interesting", ".", " The", " following", " command", " extracts", " it", " for", " us", " and", " places", " it", " into", " the", " p", "ng", "log", " :", "\n", "\n", "P", "YP", "Y", "LOG", "=", "jit", "-", "log", "-", "opt", ":", "png", "log", " lever", " samples", "/", "png", "/", "png", "_", "load", ".", "lc", "\n", "\n", "This", " is", " the", " first", " time", " when", " I", " am", " using", " the", " J", "IT", " trace", " to", " optimize", " a", " program", ",", " so", " my", " function", " for", " the", " print", "able", " location", " only", " returned", " the", " program", " counter", ":", "\n", "\n", "debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "25", " set", "loc", " module", "=", "<", "module", " p", "ng", ">", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "29", " get", "gl", "ob", " module", "=", "<", "module", " p", "ng", ">", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "32", " get", "loc", " module", "=", "<", "module", " p", "ng", ">", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "35", " get", "loc", " module", "=", "<", "module", " p", "ng", ">", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "38", " get", "gl", "ob", " module", "=", "<", "module", " p", "ng", ">", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "41", " call", " module", "=", "<", "module", " p", "ng", ">", "')", " +", "11", "19", ":", " i", "119", " =", " int", "_", "sub", "(", "i", "118", ",", " i", "110", ")", "\n", "\n", "I", " adjusted", " it", " to", " provide", " line", " counts", " too", ".", " I", "'m", " sure", " it", " needs", " something", " better", " later", " on", ":", "\n", "\n", "debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "25", " set", "loc", " module", "=", "<", "module", " p", "ng", ">:", "105", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "29", " get", "gl", "ob", " module", "=", "<", "module", " p", "ng", ">:", "105", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "32", " get", "loc", " module", "=", "<", "module", " p", "ng", ">:", "106", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "35", " get", "loc", " module", "=", "<", "module", " p", "ng", ">:", "106", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "38", " get", "gl", "ob", " module", "=", "<", "module", " p", "ng", ">:", "106", "')", " debug", "_", "mer", "ge", "_", "point", "(", "0", ",", " 0", ",", " '", "pc", "=", "41", " call", " module", "=", "<", "module", " p", "ng", ">:", "106", "')", " +", "11", "19", ":", " i", "119", " =", " int", "_", "sub", "(", "i", "118", ",", " i", "110", ")", "\n", "\n", "After", " dropping", " out", " lots", " of", " debug", "_", "mer", "ge", "_", "points", ",", " I", " see", " that", " the", " pa", "eth", " predictor", " ends", " up", " like", " this", ":", "\n", "\n", "+", "916", ":", " guard", "_", "non", "null", "_", "class", "(", "p", "3", ",", " Const", "Class", "(", "Integer", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "4", "a", "9", "db", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "9", "41", ":", " guard", "_", "non", "null", "_", "class", "(", "p", "5", ",", " Const", "Class", "(", "Integer", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "4", "a", "9", "e", "08", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "9", "66", ":", " guard", "_", "not", "_", "in", "valid", "ated", "(", "desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "e", "20", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "980", ":", " p", "108", " =", " get", "field", "_", "gc", "_", "r", "(", "Const", "Ptr", "(", "ptr", "107", "),", " desc", "r", "=", "<", "Field", "P", " space", ".", "mult", "imet", "hod", ".", "Mult", "imet", "hod", ".", "inst", "_", "version", " 48", ">)", " +", "99", "1", ":", " guard", "_", "value", "(", "p", "108", ",", " Const", "Ptr", "(", "ptr", "109", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "e", "60", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "1000", ":", " i", "110", " =", " get", "field", "_", "gc", "_", "i", "(", "p", "3", ",", " desc", "r", "=", "<", "Field", "S", " space", ".", "n", "umbers", ".", "Integer", ".", "inst", "_", "value", " 8", " pure", ">)", " +", "101", "1", ":", " i", "111", " =", " get", "field", "_", "gc", "_", "i", "(", "p", "5", ",", " desc", "r", "=", "<", "Field", "S", " space", ".", "n", "umbers", ".", "Integer", ".", "inst", "_", "value", " 8", " pure", ">)", " +", "10", "22", ":", " i", "112", " =", " int", "_", "add", "(", "i", "110", ",", " i", "111", ")", " +", "10", "32", ":", " guard", "_", "non", "null", "_", "class", "(", "p", "7", ",", " Const", "Class", "(", "Integer", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "4", "a", "9", "e", "60", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "10", "71", ":", " p", "115", " =", " get", "field", "_", "gc", "_", "r", "(", "Const", "Ptr", "(", "ptr", "114", "),", " desc", "r", "=", "<", "Field", "P", " space", ".", "mult", "imet", "hod", ".", "Mult", "imet", "hod", ".", "inst", "_", "version", " 48", ">)", " +", "10", "89", ":", " guard", "_", "value", "(", "p", "115", ",", " Const", "Ptr", "(", "ptr", "116", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "ea", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "10", "98", ":", " i", "117", " =", " get", "field", "_", "gc", "_", "i", "(", "p", "7", ",", " desc", "r", "=", "<", "Field", "S", " space", ".", "n", "umbers", ".", "Integer", ".", "inst", "_", "value", " 8", " pure", ">)", " +", "110", "9", ":", " i", "118", " =", " int", "_", "sub", "(", "i", "112", ",", " i", "117", ")", " +", "11", "19", ":", " i", "119", " =", " int", "_", "sub", "(", "i", "118", ",", " i", "110", ")", " +", "11", "47", ":", " p", "121", " =", " get", "field", "_", "gc", "_", "r", "(", "Const", "Ptr", "(", "ptr", "120", "),", " desc", "r", "=", "<", "Field", "P", " space", ".", "mult", "imet", "hod", ".", "Mult", "imet", "hod", ".", "inst", "_", "version", " 48", ">)", " +", "11", "65", ":", " guard", "_", "value", "(", "p", "121", ",", " Const", "Ptr", "(", "ptr", "122", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "ee", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "11", "74", ":", " i", "124", " =", " int", "_", "lt", "(", "i", "119", ",", " 0", ")", " +", "11", "82", ":", " guard", "_", "false", "(", "i", "124", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "f", "20", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "11", "88", ":", " i", "125", " =", " int", "_", "sub", "(", "i", "118", ",", " i", "111", ")", " +", "119", "8", ":", " i", "127", " =", " int", "_", "lt", "(", "i", "125", ",", " 0", ")", " +", "12", "02", ":", " guard", "_", "false", "(", "i", "127", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "f", "60", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "12", "08", ":", " i", "128", " =", " int", "_", "sub", "(", "i", "118", ",", " i", "117", ")", " +", "12", "18", ":", " i", "130", " =", " int", "_", "lt", "(", "i", "128", ",", " 0", ")", " +", "12", "22", ":", " guard", "_", "false", "(", "i", "130", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "fa", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "12", "35", ":", " p", "132", " =", " get", "field", "_", "gc", "_", "r", "(", "Const", "Ptr", "(", "ptr", "131", "),", " desc", "r", "=", "<", "Field", "P", " space", ".", "mult", "imet", "hod", ".", "Mult", "imet", "hod", ".", "inst", "_", "version", " 48", ">)", " +", "12", "46", ":", " guard", "_", "value", "(", "p", "132", ",", " Const", "Ptr", "(", "ptr", "133", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "4", "c", "00", "20", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "12", "55", ":", " i", "134", " =", " int", "_", "le", "(", "i", "119", ",", " i", "125", ")", " +", "12", "62", ":", " guard", "_", "true", "(", "i", "134", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "4", "c", "00", "60", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "12", "68", ":", " i", "135", " =", " int", "_", "le", "(", "i", "119", ",", " i", "128", ")", " +", "12", "75", ":", " guard", "_", "true", "(", "i", "135", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "4", "c", "00", "a", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "12", "81", ":", " leave", "_", "port", "al", "_", "frame", "(", "0", ")", "\n", "\n", "Super", "flu", "ous", " guards", "\n", "\n", "I", " even", " found", " something", " I", " should", " no", " longer", " have", " there", ":", "\n", "\n", "+", "980", ":", " p", "108", " =", " get", "field", "_", "gc", "_", "r", "(", "Const", "Ptr", "(", "ptr", "107", "),", " desc", "r", "=", "<", "Field", "P", " space", ".", "mult", "imet", "hod", ".", "Mult", "imet", "hod", ".", "inst", "_", "version", " 48", ">)", " +", "99", "1", ":", " guard", "_", "value", "(", "p", "108", ",", " Const", "Ptr", "(", "ptr", "109", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "e", "60", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "10", "71", ":", " p", "115", " =", " get", "field", "_", "gc", "_", "r", "(", "Const", "Ptr", "(", "ptr", "114", "),", " desc", "r", "=", "<", "Field", "P", " space", ".", "mult", "imet", "hod", ".", "Mult", "imet", "hod", ".", "inst", "_", "version", " 48", ">)", " +", "10", "89", ":", " guard", "_", "value", "(", "p", "115", ",", " Const", "Ptr", "(", "ptr", "116", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "ea", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "11", "47", ":", " p", "121", " =", " get", "field", "_", "gc", "_", "r", "(", "Const", "Ptr", "(", "ptr", "120", "),", " desc", "r", "=", "<", "Field", "P", " space", ".", "mult", "imet", "hod", ".", "Mult", "imet", "hod", ".", "inst", "_", "version", " 48", ">)", " +", "11", "65", ":", " guard", "_", "value", "(", "p", "121", ",", " Const", "Ptr", "(", "ptr", "122", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "475", "ee", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "12", "35", ":", " p", "132", " =", " get", "field", "_", "gc", "_", "r", "(", "Const", "Ptr", "(", "ptr", "131", "),", " desc", "r", "=", "<", "Field", "P", " space", ".", "mult", "imet", "hod", ".", "Mult", "imet", "hod", ".", "inst", "_", "version", " 48", ">)", " +", "12", "46", ":", " guard", "_", "value", "(", "p", "132", ",", " Const", "Ptr", "(", "ptr", "133", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "eff", "cc", "4", "c", "00", "20", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", "\n", "\n", "Every", " guard", " in", " J", "IT", " converts", " into", " a", " conditional", " and", " a", " conditional", " branch", ".", " They", " ensure", " that", " the", " program", " diver", "ges", " from", " the", " fast", " path", " if", " it", "'s", " not", " applicable", ".", " Making", " the", " version", " number", " pseudo", "imm", "utable", " should", " help", " a", " bit", " here", ":", "\n", "\n", "class", " Mult", "imet", "hod", "(", "Object", "):", " _", "imm", "utable", "_", "fields", "_", " =", " ['", "arity", "',", " '", "mult", "imet", "hod", "_", "table", "',", " '", "interface", "_", "table", "',", " '", "default", "?", "',", " '", "version", "?'", "]", "\n", "\n", "The", " pseudo", "imm", "ut", "ability", " is", " marked", " when", " we", " expect", " that", " a", " value", " does", " not", " change", " often", ".", " The", " version", " number", " changes", " when", " the", " mult", "imet", "hod", " is", " updated", ".", " From", " the", " perspective", " of", " hot", " loops", " it", " is", " never", " changed", ".", "\n", "\n", "We", " still", " have", " lots", " of", " guards", " here", ".", "\n", "\n", "+", "820", ":", " guard", "_", "non", "null", "_", "class", "(", "p", "3", ",", " Const", "Class", "(", "Integer", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "d", "1", "a", "1", "d", "8", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "8", "45", ":", " guard", "_", "non", "null", "_", "class", "(", "p", "5", ",", " Const", "Class", "(", "Integer", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "d", "1", "a", "230", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "870", ":", " guard", "_", "not", "_", "in", "valid", "ated", "(", "desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "cc", "bf", "60", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "870", ":", " i", "107", " =", " get", "field", "_", "gc", "_", "i", "(", "p", "3", ",", " desc", "r", "=", "<", "Field", "S", " space", ".", "n", "umbers", ".", "Integer", ".", "inst", "_", "value", " 8", " pure", ">)", " +", "888", ":", " i", "108", " =", " get", "field", "_", "gc", "_", "i", "(", "p", "5", ",", " desc", "r", "=", "<", "Field", "S", " space", ".", "n", "umbers", ".", "Integer", ".", "inst", "_", "value", " 8", " pure", ">)", " +", "89", "2", ":", " i", "109", " =", " int", "_", "add", "(", "i", "107", ",", " i", "108", ")", " +", "9", "02", ":", " guard", "_", "non", "null", "_", "class", "(", "p", "7", ",", " Const", "Class", "(", "Integer", "),", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "d", "1", "a", "288", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "9", "35", ":", " i", "111", " =", " get", "field", "_", "gc", "_", "i", "(", "p", "7", ",", " desc", "r", "=", "<", "Field", "S", " space", ".", "n", "umbers", ".", "Integer", ".", "inst", "_", "value", " 8", " pure", ">)", " +", "9", "39", ":", " i", "112", " =", " int", "_", "sub", "(", "i", "109", ",", " i", "111", ")", " +", "956", ":", " i", "113", " =", " int", "_", "sub", "(", "i", "112", ",", " i", "107", ")", " +", "970", ":", " i", "115", " =", " int", "_", "lt", "(", "i", "113", ",", " 0", ")", " +", "9", "74", ":", " guard", "_", "false", "(", "i", "115", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "cc", "b", "fa", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "980", ":", " i", "116", " =", " int", "_", "sub", "(", "i", "112", ",", " i", "108", ")", " +", "997", ":", " i", "118", " =", " int", "_", "lt", "(", "i", "116", ",", " 0", ")", " +", "1001", ":", " guard", "_", "false", "(", "i", "118", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "d", "200", "20", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "1007", ":", " i", "119", " =", " int", "_", "sub", "(", "i", "112", ",", " i", "111", ")", " +", "101", "7", ":", " i", "121", " =", " int", "_", "lt", "(", "i", "119", ",", " 0", ")", " +", "10", "21", ":", " guard", "_", "false", "(", "i", "121", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "d", "200", "60", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "1027", ":", " i", "122", " =", " int", "_", "le", "(", "i", "113", ",", " i", "116", ")", " +", "10", "34", ":", " guard", "_", "true", "(", "i", "122", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "d", "200", "a", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "10", "40", ":", " i", "123", " =", " int", "_", "le", "(", "i", "113", ",", " i", "119", ")", " +", "10", "47", ":", " guard", "_", "true", "(", "i", "123", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "9", "c", "21", "d", "200", "e", "0", ">)", " [", "p", "0", ",", " p", "3", ",", " p", "5", ",", " p", "7", ",", " p", "9", ",", " p", "11", ",", " p", "13", ",", " p", "15", ",", " p", "18", ",", " p", "20", ",", " p", "22", ",", " p", "24", ",", " p", "26", ",", " p", "28", ",", " p", "30", ",", " p", "32", ",", " p", "34", ",", " p", "36", ",", " p", "38", ",", " p", "40", ",", " p", "42", ",", " p", "44", ",", " p", "46", ",", " p", "48", ",", " p", "50", ",", " p", "52", ",", " p", "54", ",", " p", "56", ",", " p", "58", ",", " p", "60", ",", " p", "62", ",", " p", "64", ",", " p", "66", ",", " p", "68", ",", " p", "70", ",", " p", "72", ",", " p", "74", ",", " p", "76", ",", " p", "78", ",", " p", "80", ",", " p", "82", ",", " p", "84", ",", " p", "86", ",", " p", "88", ",", " p", "90", ",", " p", "92", ",", " p", "94", ",", " p", "96", ",", " p", "98", ",", " p", "100", ",", " p", "102", ",", " p", "104", "]", " +", "10", "53", ":", " leave", "_", "port", "al", "_", "frame", "(", "0", ")", "\n", "\n", "And", " we", " are", " down", " to", " 7", ".", "1", " seconds", ":", "\n", "\n", "100", ".", "0", "%", " L", "3", "_", "16", " 100", ".", "0", "%", " p", "ng", "_", "load", ".", "lc", ":", "3", " (", "line", " 5", ")", " 100", ".", "0", "%", "..", " L", "5", "_", "39", " 100", ".", "0", "%", " p", "ng", ".", "lc", ":", "5", " 99", ".", "5", "%", "....", " L", "53", "_", "82", " 99", ".", "5", "%", " p", "ng", ".", "lc", ":", "53", " (", "line", " 27", ")", " 0", ".", "7", "%", "......", " L", "96", "_", "99", " 0", ".", "7", "%", " p", "ng", ".", "lc", ":", "96", " 0", ".", "1", "%", "......", " L", "87", "_", "90", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "87", " 29", ".", "9", "%", "......", " L", "99", "_", "101", " 30", ".", "0", "%", " p", "ng", ".", "lc", ":", "99", " (", "line", " 56", ")", " 12", ".", "3", "%", "........", " L", "104", "_", "128", " 41", ".", "2", "%", " p", "ng", ".", "lc", ":", "104", " (", "line", " 60", ")", " 0", ".", "1", "%", "......", " L", "90", "_", "96", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "90", " 0", ".", "2", "%", "....", " L", "139", "_", "156", " 0", ".", "2", "%", " p", "ng", ".", "lc", ":", "139", " 0", ".", "1", "%", "......", " L", "156", "_", "158", " 25", ".", "0", "%", " p", "ng", ".", "lc", ":", "156", " 0", ".", "1", "%", "....", " L", "40", "_", "53", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "40", "\n", "\n", "S", "omew", "hat", " ill", "og", "ically", ",", " the", " time", " spent", " in", " the", " pa", "eth", " predictor", " increased", "!", "\n", "\n", "Cond", "itional", " branching", "\n", "\n", "Another", " trick", " to", " try", " would", " be", " to", " remove", " the", " unnecessary", " branching", " by", " coales", "cing", " the", " condition", "als", ".", " To", " do", " it", " we", " need", " a", " tool", " to", " do", " it", ".", " A", " select", "()", " function", " does", " fine", ".", "\n", "\n", "@", "built", "in", " @", "sign", "ature", "(", "Boo", "lean", ",", " Object", ",", " Object", ")", " def", " select", "(", "cond", ",", " a", ",", " b", "):", " return", " a", " if", " cond", " ==", " true", " else", " b", "\n", "\n", "The", " optim", "izer", " will", " likely", " convert", " this", " thing", " into", " a", " conditional", " move", ",", " or", " so", " I", " hope", ".", " In", " every", " case", " it", " should", " eliminate", " additional", " branches", " that", " would", " turn", " into", " guards", ".", " The", " pa", "eth", "_", "p", "redict", "or", " looks", " like", " this", " now", ":", "\n", "\n", "pa", "eth", "_", "p", "redict", "or", " =", " (", "a", ",", " b", ",", " c", "):", " p", " =", " a", " +", " b", " -", " c", " pa", " =", " abs", "(", "p", " -", " a", ")", " p", "b", " =", " abs", "(", "p", " -", " b", ")", " pc", " =", " abs", "(", "p", " -", " c", ")", " return", " select", "(", "pa", " <=", " p", "b", " and", " pa", " <=", " pc", ",", " a", ",", " select", "(", "pb", " <=", " pc", ",", " b", ",", " c", "))", "\n", "\n", "The", " results", " were", " perhaps", " ill", "ogical", ".", " This", " was", " not", " any", " faster", ".", " When", " I", " looked", " into", " the", " trace", ",", " the", " guards", " are", " still", " there", ".", " Maybe", " our", " implementation", " has", " the", " wrong", " shape", "?", " Lets", " do", " it", " in", " a", " way", " that", " cannot", " be", " interpreted", " wrong", ":", "\n", "\n", "@", "built", "in", " @", "sign", "ature", "(", "Boo", "lean", ",", " Object", ",", " Object", ")", " def", " select", "(", "cond", ",", " a", ",", " b", "):", " return", " [", "b", ",", " a", "][", "cond", " ==", " true", "]", "\n", "\n", "Even", " then", " it", " does", " not", " have", " the", " desired", " effect", ".", " Form", "ing", " a", " new", " byte", "code", " instruction", " that", " does", " this", " shouldn", "'t", " have", " any", " effect", " either", " because", " the", " call", " is", " constant", " folded", " away", " anyway", ".", "\n", "\n", "Reader", " loop", "\n", "\n", "One", " problem", " in", " our", " reader", " loop", " is", " that", " we", " are", " doing", " whole", " lot", " of", " work", " inside", " it", ".", " We", " are", " checking", " bounds", " and", " fetch", "ing", " stuff", " for", " the", " filter", ":", "\n", "\n", "data", " =", " self", ".", "z", ".", "dec", "omp", "ress", "(", "data", ")", " for", " byte", " in", " data", " if", " self", ".", "new", "_", "scan", "line", " self", ".", "filter", " =", " decode", "_", "fil", "ters", "[", "byte", "]", " self", ".", "new", "_", "scan", "line", " =", " false", " continue", " if", " self", ".", "l", " ==", " 0", " u", " =", " 0", " c", " =", " 0", " if", " self", ".", "x", " -", " self", ".", "str", "ide", " >=", " self", ".", "l", " l", " =", " self", ".", "data", "[", "self", ".", "x", " -", " self", ".", "str", "ide", "]", " else", " l", " =", " 0", " else", " u", " =", " self", ".", "data", "[", "self", ".", "x", " -", " self", ".", "y", "_", "str", "ide", "]", " if", " self", ".", "x", " -", " self", ".", "str", "ide", " >=", " self", ".", "l", " l", " =", " self", ".", "data", "[", "self", ".", "x", " -", " self", ".", "str", "ide", "]", " c", " =", " self", ".", "data", "[", "self", ".", "x", " -", " self", ".", "y", "_", "str", "ide", " -", " self", ".", "str", "ide", "]", " else", " l", " =", " 0", " c", " =", " 0", " #", " run", " the", " filter", " and", " update", " the", " bounds", " self", ".", "data", "[", "self", ".", "x", "]", " =", " self", ".", "filter", "(", "byte", ",", " l", ",", " u", ",", " c", ")", " self", ".", "x", " +=", " 1", " if", " self", ".", "x", " >=", " self", ".", "r", " self", ".", "l", " +=", " self", ".", "y", "_", "str", "ide", " self", ".", "r", " +=", " self", ".", "y", "_", "str", "ide", " self", ".", "new", "_", "scan", "line", " =", " true", "\n", "\n", "We", " are", " doing", " that", " for", " every", " 1", " 228", " 800", " bytes", ".", " Yet", " we", " only", " have", " 480", " scan", "lines", "!", "\n", "\n", "We", " could", " instead", " do", ":", "\n", "\n", "pri", "or", " =", " self", ".", "pri", "or", " scan", "line", " =", " self", ".", "scan", "line", " index", " =", " self", ".", "index", " data", " =", " self", ".", "z", ".", "dec", "omp", "ress", "(", "data", ")", " while", " data", ".", "length", " >", " 0", " if", " index", " ==", " 0", " self", ".", "filter", " =", " decode", "_", "fil", "ters", "[", "data", "[", "0", "]]", " data", " =", " data", "[", "1", ".", ":]", " L", " =", " min", "(", "self", ".", "y", "_", "str", "ide", " -", " index", ",", " data", ".", "length", ")", " for", " i", " in", " range", "(", "index", ",", " index", "+", "L", ")", " if", " i", " <", " self", ".", "str", "ide", " l", " =", " 0", " c", " =", " 0", " else", " l", " =", " scan", "line", "[", "i", " -", " self", ".", "str", "ide", "]", " c", " =", " prior", "[", "i", " -", " self", ".", "str", "ide", "]", " u", " =", " prior", "[", "i", "]", " scan", "line", "[", "i", "]", " =", " data", "[", "i", "-", "index", "]", " +", " self", ".", "filter", "(", "l", ",", " u", ",", " c", ")", " if", " index", " +", " L", " >=", " self", ".", "y", "_", "str", "ide", " prior", " =", " scan", "line", " scan", "line", " =", " self", ".", "data", "[", "self", ".", "next", "_", "scan", "line", ".", ":", " self", ".", "next", "_", "scan", "line", " +", " self", ".", "y", "_", "str", "ide", "]", " index", " =", " 0", " self", ".", "next", "_", "scan", "line", " +=", " self", ".", "y", "_", "str", "ide", " else", " index", " +=", " L", " data", " =", " data", "[", "L", ".", ":]", " assert", " index", " <", " self", ".", "y", "_", "str", "ide", " self", ".", "pri", "or", " =", " prior", " self", ".", "scan", "line", " =", " scan", "line", " self", ".", "index", " =", " index", "\n", "\n", "To", " always", " have", " an", " empty", " prior", " scan", "line", ",", " we", " initialize", " it", " to", " point", " to", " the", " second", " scan", "line", ".", " I", " also", " flip", " the", " addition", " out", " of", " the", " filter", " that", " helps", " a", " little", " bit", ".", "\n", "\n", "It", " now", " takes", " 3", ".", "6", " seconds", " at", " loading", " those", " 10", " images", ".", "\n", "\n", "100", ".", "0", "%", " L", "3", "_", "17", " 100", ".", "0", "%", " p", "ng", "_", "load", ".", "lc", ":", "3", " (", "line", " 5", ")", " 100", ".", "0", "%", "..", " L", "5", "_", "39", " 100", ".", "0", "%", " p", "ng", ".", "lc", ":", "5", " 99", ".", "2", "%", "....", " L", "53", "_", "85", " 99", ".", "2", "%", " p", "ng", ".", "lc", ":", "53", " (", "line", " 231", ")", " 0", ".", "2", "%", "......", " L", "90", "_", "91", " 0", ".", "2", "%", " p", "ng", ".", "lc", ":", "90", " 1", ".", "5", "%", "......", " L", "96", "_", "97", " 1", ".", "5", "%", " p", "ng", ".", "lc", ":", "96", " 27", ".", "2", "%", "......", " L", "99", "_", "110", " 27", ".", "4", "%", " p", "ng", ".", "lc", ":", "99", " (", "line", " 192", ")", " 0", ".", "5", "%", "......", " L", "93", "_", "94", " 0", ".", "5", "%", " p", "ng", ".", "lc", ":", "93", " 0", ".", "3", "%", "....", " L", "133", "_", "150", " 0", ".", "3", "%", " p", "ng", ".", "lc", ":", "133", "\n", "\n", "Image", "Mag", "ick", " as", " comparison", "\n", "\n", "To", " compare", ",", " if", " I", " run", " copy", " the", " image", " 10", " times", " and", " then", " run", ":", "\n", "\n", "time", " convert", " *.", "png", " converted", ".", "jpg", "\n", "\n", "It", " shows", " me", " that", " it", "'s", " taking", " 0", ".", "225", "s", " to", " do", " the", " job", " and", " it", "'s", " not", " only", " reading", " the", " p", "ng", " but", " also", " converting", " it", " into", " j", "pg", ".", " We", " are", " at", " least", " 10", " to", " 20", " times", " slower", " than", " the", " C", " program", " and", " it", " is", " a", " bit", " unacceptable", ".", "\n", "\n", "Opt", "im", "ization", " of", " method", " lookup", "\n", "\n", "We", " looked", " at", " the", " trace", " again", " with", " p", "yp", "y", " channel", " and", " found", " yet", " a", " lookup", "_", "method", " that", " was", " un", "el", "ided", ".", " The", " likely", " reason", " was", " that", " the", " method", " table", " was", " not", " perceived", " as", " immutable", ".", " This", " resulted", " in", " the", " following", " silly", " pair", " of", " guards", ":", "\n", "\n", "+", "600", ":", " p", "172", " =", " get", "field", "_", "gc", "_", "r", "(", "p", "1", ",", " desc", "r", "=", "<", "Field", "P", " space", ".", "custom", "object", ".", "Custom", "Object", ".", "inst", "_", "custom", "_", "interface", " 8", " pure", ">)", " +", "618", ":", " p", "175", " =", " call", "_", "r", "(", "Const", "Class", "(", "Interface", ".", "look", "up", "_", "method", "),", " p", "172", ",", " Const", "Ptr", "(", "ptr", "174", "),", " desc", "r", "=", "<", "Call", "r", " 8", " r", "r", " EF", "=", "4", ">)", " +", "710", ":", " guard", "_", "no", "_", "ex", "ception", "(", "desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "7", "b", "2", "d", "3", "a", "7", "d", "00", ">)", " [", "p", "0", ",", " p", "1", ",", " p", "2", ",", " p", "3", ",", " p", "4", ",", " p", "5", ",", " p", "6", ",", " p", "7", ",", " p", "8", ",", " p", "9", ",", " p", "10", ",", " p", "11", ",", " p", "12", ",", " p", "13", ",", " p", "14", ",", " p", "15", ",", " p", "16", ",", " p", "17", ",", " p", "18", ",", " p", "19", ",", " p", "20", ",", " p", "21", ",", " p", "22", ",", " p", "23", ",", " p", "24", ",", " p", "25", ",", " p", "26", ",", " p", "27", ",", " p", "28", ",", " p", "29", ",", " p", "30", ",", " p", "31", ",", " p", "32", ",", " p", "33", ",", " p", "34", ",", " p", "35", ",", " p", "36", ",", " p", "37", ",", " p", "38", ",", " p", "39", ",", " p", "40", ",", " p", "41", ",", " p", "42", ",", " p", "43", ",", " p", "44", ",", " p", "45", ",", " p", "46", ",", " p", "47", ",", " p", "48", ",", " p", "49", ",", " p", "50", ",", " p", "51", ",", " p", "52", ",", " p", "53", ",", " p", "54", ",", " p", "55", ",", " p", "56", ",", " p", "57", ",", " p", "58", ",", " p", "59", ",", " p", "60", ",", " p", "61", ",", " p", "62", ",", " p", "63", ",", " p", "64", ",", " p", "65", ",", " p", "66", ",", " p", "67", ",", " p", "68", ",", " p", "69", ",", " p", "70", ",", " p", "71", ",", " p", "72", ",", " p", "73", ",", " p", "74", ",", " p", "75", ",", " p", "76", ",", " p", "77", ",", " p", "78", ",", " p", "79", ",", " p", "80", ",", " p", "81", ",", " p", "82", ",", " p", "83", ",", " p", "84", ",", " p", "85", ",", " p", "86", ",", " p", "87", ",", " p", "88", ",", " p", "89", ",", " p", "90", ",", " p", "91", ",", " p", "92", ",", " p", "93", ",", " p", "94", ",", " p", "95", ",", " p", "96", ",", " p", "97", ",", " p", "98", ",", " p", "99", ",", " p", "100", ",", " p", "101", ",", " p", "102", ",", " p", "103", ",", " p", "104", ",", " p", "105", ",", " p", "106", ",", " p", "107", ",", " p", "114", ",", " p", "115", ",", " p", "116", ",", " p", "117", ",", " p", "118", ",", " p", "119", ",", " p", "120", ",", " p", "121", ",", " p", "122", ",", " p", "123", ",", " p", "124", ",", " p", "125", ",", " p", "126", ",", " p", "127", ",", " p", "128", ",", " p", "129", ",", " p", "130", ",", " p", "131", ",", " p", "132", ",", " p", "133", ",", " p", "134", ",", " p", "135", ",", " p", "136", ",", " p", "137", ",", " p", "138", ",", " p", "139", ",", " p", "140", ",", " p", "141", ",", " p", "142", ",", " p", "143", ",", " p", "144", ",", " p", "145", ",", " p", "146", ",", " p", "147", ",", " p", "148", ",", " p", "149", ",", " p", "150", ",", " p", "151", ",", " p", "152", ",", " p", "153", ",", " p", "154", ",", " p", "155", ",", " p", "156", ",", " p", "157", ",", " p", "158", ",", " p", "159", ",", " p", "160", ",", " p", "161", ",", " p", "162", ",", " p", "175", ",", " i", "171", ",", " i", "166", "]", " +", "725", ":", " guard", "_", "is", "null", "(", "p", "175", ",", " desc", "r", "=", "<", "Guard", "0", "x", "7", "f", "7", "b", "2", "d", "3", "ac", "020", ">)", " [", "p", "0", ",", " p", "1", ",", " p", "2", ",", " p", "3", ",", " p", "4", ",", " p", "5", ",", " p", "6", ",", " p", "7", ",", " p", "8", ",", " p", "9", ",", " p", "10", ",", " p", "11", ",", " p", "12", ",", " p", "13", ",", " p", "14", ",", " p", "15", ",", " p", "16", ",", " p", "17", ",", " p", "18", ",", " p", "19", ",", " p", "20", ",", " p", "21", ",", " p", "22", ",", " p", "23", ",", " p", "24", ",", " p", "25", ",", " p", "26", ",", " p", "27", ",", " p", "28", ",", " p", "29", ",", " p", "30", ",", " p", "31", ",", " p", "32", ",", " p", "33", ",", " p", "34", ",", " p", "35", ",", " p", "36", ",", " p", "37", ",", " p", "38", ",", " p", "39", ",", " p", "40", ",", " p", "41", ",", " p", "42", ",", " p", "43", ",", " p", "44", ",", " p", "45", ",", " p", "46", ",", " p", "47", ",", " p", "48", ",", " p", "49", ",", " p", "50", ",", " p", "51", ",", " p", "52", ",", " p", "53", ",", " p", "54", ",", " p", "55", ",", " p", "56", ",", " p", "57", ",", " p", "58", ",", " p", "59", ",", " p", "60", ",", " p", "61", ",", " p", "62", ",", " p", "63", ",", " p", "64", ",", " p", "65", ",", " p", "66", ",", " p", "67", ",", " p", "68", ",", " p", "69", ",", " p", "70", ",", " p", "71", ",", " p", "72", ",", " p", "73", ",", " p", "74", ",", " p", "75", ",", " p", "76", ",", " p", "77", ",", " p", "78", ",", " p", "79", ",", " p", "80", ",", " p", "81", ",", " p", "82", ",", " p", "83", ",", " p", "84", ",", " p", "85", ",", " p", "86", ",", " p", "87", ",", " p", "88", ",", " p", "89", ",", " p", "90", ",", " p", "91", ",", " p", "92", ",", " p", "93", ",", " p", "94", ",", " p", "95", ",", " p", "96", ",", " p", "97", ",", " p", "98", ",", " p", "99", ",", " p", "100", ",", " p", "101", ",", " p", "102", ",", " p", "103", ",", " p", "104", ",", " p", "105", ",", " p", "106", ",", " p", "107", ",", " p", "114", ",", " p", "115", ",", " p", "116", ",", " p", "117", ",", " p", "118", ",", " p", "119", ",", " p", "120", ",", " p", "121", ",", " p", "122", ",", " p", "123", ",", " p", "124", ",", " p", "125", ",", " p", "126", ",", " p", "127", ",", " p", "128", ",", " p", "129", ",", " p", "130", ",", " p", "131", ",", " p", "132", ",", " p", "133", ",", " p", "134", ",", " p", "135", ",", " p", "136", ",", " p", "137", ",", " p", "138", ",", " p", "139", ",", " p", "140", ",", " p", "141", ",", " p", "142", ",", " p", "143", ",", " p", "144", ",", " p", "145", ",", " p", "146", ",", " p", "147", ",", " p", "148", ",", " p", "149", ",", " p", "150", ",", " p", "151", ",", " p", "152", ",", " p", "153", ",", " p", "154", ",", " p", "155", ",", " p", "156", ",", " p", "157", ",", " p", "158", ",", " p", "159", ",", " p", "160", ",", " p", "161", ",", " p", "162", ",", " p", "175", ",", " i", "171", ",", " i", "166", "]", "\n", "\n", "Giving", " the", " J", "IT", " a", " hint", " to", " promote", " the", " custom", "_", "interface", " into", " a", " constant", " solves", " this", " problem", ".", " It", " means", " that", " the", " lookup", "_", "method", " can", " be", " then", " el", "ided", " and", " the", " J", "IT", " can", " figure", " out", " that", " it", " never", " returns", " anything", " other", " than", " null", " and", " instead", " it", " just", " retrie", "ves", " the", " value", " from", " a", " storage", " object", ".", "\n", "\n", "After", " the", " improvement", " the", " program", " has", " shaved", " down", " to", " 2", ".", "7", " seconds", " and", " the", " pa", "eth", " filter", " appears", " to", " start", " becoming", " a", " bottleneck", " again", ".", "\n", "\n", "100", ".", "0", "%", " L", "3", "_", "17", " 100", ".", "0", "%", " p", "ng", "_", "load", ".", "lc", ":", "3", " (", "line", " 5", ")", " 100", ".", "0", "%", "..", " L", "5", "_", "39", " 100", ".", "0", "%", " p", "ng", ".", "lc", ":", "5", " 98", ".", "7", "%", "....", " L", "53", "_", "86", " 98", ".", "7", "%", " p", "ng", ".", "lc", ":", "53", " (", "line", " 231", ")", " 0", ".", "1", "%", "......", " L", "91", "_", "92", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "91", " 1", ".", "9", "%", "......", " L", "97", "_", "98", " 1", ".", "9", "%", " p", "ng", ".", "lc", ":", "97", " 31", ".", "8", "%", "......", " L", "100", "_", "111", " 32", ".", "2", "%", " p", "ng", ".", "lc", ":", "100", " (", "line", " 192", ")", " 0", ".", "1", "%", "......", " L", "94", "_", "95", " 0", ".", "1", "%", " p", "ng", ".", "lc", ":", "94", " 1", ".", "0", "%", "....", " L", "134", "_", "151", " 1", ".", "0", "%", " p", "ng", ".", "lc", ":", "134", " 0", ".", "1", "%", "......", " L", "151", "_", "153", " 14", ".", "3", "%", " p", "ng", ".", "lc", ":", "151", "\n", "\n", "An", " insight", " into", " J", "IT", "\n", "\n", "It", " is", " perhaps", " that", " I", " got", " some", " intuition", " about", " the", " behavior", " of", " the", " met", "at", "r", "acing", " J", "IT", " when", " I", " found", " out", " about", " the", " above", " problem", ".", "\n", "\n", "At", " the", " start", " of", " installing", " a", " J", "IT", " driver", " I", " have", " to", " tell", " it", " the", " color", " of", " certain", " variables", ":", "\n", "\n", "jit", "driver", " =", " j", "it", ".", "J", "it", "Driver", "(", " greens", "=", "['", "pc", "',", " '", "block", "',", " '", "module", "',", " '", "unit", "',", " '", "ex", "cs", "',", " '", "function", "'", "],", " #", ",", " '", "ec", "'", "],", " red", "s", "=", "['", "frame", "'", "],", " #", " '", "reg", "v", "',", " virtual", "iz", "ables", " =", " ['", "frame", "'", "],", " get", "_", "print", "able", "_", "location", "=", "get", "_", "print", "able", "_", "location", ",", " get", "_", "unique", "_", "id", "=", "get", "_", "unique", "_", "id", ",", " is", "_", "rec", "ursive", "=", "True", ")", "\n", "\n", "The", " need", " to", " specify", " red", " variables", " is", " an", " implementation", " detail", " here", ",", " but", " the", " green", " variables", " are", " needed", " by", " the", " J", "IT", ".", " The", " greens", " tell", " which", " variables", " are", " supposed", " to", " stay", " constant", " during", " the", " J", "IT", " translation", ".", "\n", "\n", "When", " a", " trace", " meets", " a", " green", " variable", ",", " it", " puts", " a", " guard", " for", " it", " and", " treats", " the", " program", " as", " if", " it", " that", " variable", " remained", " constant", " in", " the", " program", ".", " The", " information", " allows", " the", " tracing", " J", "IT", " to", " do", " deduction", " and", " optimize", " the", " trace", ".", "\n", "\n", "Vari", "ables", " that", " can", " be", " ded", "uced", " to", " be", " constants", ",", " such", " as", " the", " constants", " inside", " constants", " can", " be", " implicitly", " marked", " green", " without", " a", " guard", ".", " In", " other", " hand", " if", " the", " guard", " fails", ",", " then", " the", " program", " needs", " to", " branch", " and", " has", " to", " trace", " again", ".", "\n", "\n", "In", " a", " well", "-", "tun", "ed", " J", "IT", ",", " methods", " that", " are", " not", " dynamically", " used", " are", " promoted", " into", " constants", ".", "\n", "\n", "Sh", "ifting", " filter", " call", " out", " of", " the", " loop", "\n", "\n", "It", " turns", " out", " that", " we", " can", " still", " squeeze", " some", " juice", " by", " restructuring", " the", " program", ".", " Lets", " take", " this", " loop", " inside", " the", " reader", " loop", ":", "\n", "\n", "for", " i", " in", " range", "(", "index", ",", " index", "+", "L", ")", " if", " i", " <", " self", ".", "str", "ide", " l", " =", " 0", " c", " =", " 0", " else", " l", " =", " scan", "line", "[", "i", " -", " self", ".", "str", "ide", "]", " c", " =", " prior", "[", "i", " -", " self", ".", "str", "ide", "]", " u", " =", " prior", "[", "i", "]", " scan", "line", "[", "i", "]", " =", " data", "[", "i", "-", "index", "]", " +", " self", ".", "filter", "(", "l", ",", " u", ",", " c", ")", "\n", "\n", "And", " replace", " it", " with", " this", ":", "\n", "\n", "self", ".", "filter", "(", "pri", "or", ",", " scan", "line", ",", " data", "[", ".:", " L", "],", " self", ".", "str", "ide", ",", " index", ")", "\n", "\n", "Then", " we", " write", " several", " smaller", " loops", " like", " this", ":", "\n", "\n", "#", " average", " ((", "pri", "or", ",", " scan", "line", ",", " data", ",", " stride", ",", " offset", "):", " for", " i", " in", " range", "(", "offset", ",", " offset", "+", "data", ".", "length", ")", " u", " =", " prior", "[", "i", "]", " if", " i", " >=", " stride", " u", " =", " scan", "line", "[", "i", " -", " stride", "]", " +", " u", " scan", "line", "[", "i", "]", " =", " data", "[", "i", " -", " offset", "]", " +", " u", " //", " 2", " ),", "\n", "\n", "This", " sh", "aves", " the", " runtime", " speed", " down", " to", " 1", ".", "9", " seconds", ".", " It", " means", " that", " one", " image", " takes", " 200", "ms", " to", " load", ".", "\n", "\n", "100", ".", "0", "%", " L", "3", "_", "17", " 100", ".", "0", "%", " p", "ng", "_", "load", ".", "lc", ":", "3", " (", "line", " 5", ")", " 100", ".", "0", "%", "..", " L", "5", "_", "39", " 100", ".", "0", "%", " p", "ng", ".", "lc", ":", "5", " 98", ".", "7", "%", "....", " L", "53", "_", "78", " 98", ".", "7", "%", " p", "ng", ".", "lc", ":", "53", " (", "line", " 231", ",", " with", " 289", ")", " 0", ".", "8", "%", "......", " L", "85", "_", "91", " 0", ".", "9", "%", " p", "ng", ".", "lc", ":", "85", " 4", ".", "4", "%", "......", " L", "98", "_", "104", " 4", ".", "5", "%", " p", "ng", ".", "lc", ":", "98", " 84", ".", "6", "%", "......", " L", "106", "_", "126", " 85", ".", "7", "%", " p", "ng", ".", "lc", ":", "106", " (", "line", " 300", ")", " 0", ".", "8", "%", "......", " L", "93", "_", "96", " 0", ".", "9", "%", " p", "ng", ".", "lc", ":", "93", " 0", ".", "6", "%", "....", " L", "149", "_", "166", " 0", ".", "6", "%", " p", "ng", ".", "lc", ":", "149", " 0", ".", "2", "%", "......", " L", "166", "_", "168", " 33", ".", "3", "%", " p", "ng", ".", "lc", ":", "166", "\n", "\n", "The", " statistics", " show", " out", ",", " perhaps", " reassuring", "ly", ",", " that", " the", " pa", "eth", " filter", " constitutes", " 80", "%", " of", " the", " runtime", ".", " If", " we", " would", " somehow", " manage", " to", " shave", " it", " to", " tenth", " of", " its", " time", " then", " it", " would", " take", " only", " 550", "ms", " from", " the", " program", " to", " run", " the", " benchmark", ".", "\n", "\n", "How", " much", " faster", " could", " it", " run", "?", "\n", "\n", "Now", " there", "'s", " an", " interesting", " question", ":", " If", " I", " optimized", " just", " the", " pa", "eth", "-", "p", "redict", "or", " loop", ",", " how", " fast", " could", " this", " program", " run", "?", "\n", "\n", "If", " I", " temporarily", " disable", " the", " pa", "eth", " loop", ",", " the", " app", " then", " takes", " 0", ".", "3", "s", " to", " run", ".", " So", " if", " that", " part", " of", " the", " program", " didn", "'t", " run", " at", " all", ",", " that", " would", " be", " the", " limit", " that", " we", " cannot", " exceed", " by", " optimizing", " that", " only", " function", " in", " the", " program", ".", "\n", "\n", "If", " we", " managed", " to", " optimize", " all", " of", " the", " inner", " loops", ",", " the", " vm", "profile", " would", " then", " start", " to", " look", " like", " this", ":", "\n", "\n", "100", ".", "0", "%", " L", "3", "_", "17", " 100", ".", "0", "%", " p", "ng", "_", "load", ".", "lc", ":", "3", " (", "line", " 5", ")", " 10", ".", "0", "%", "..", " L", "30", "_", "41", " 10", ".", "0", "%", " p", "ng", "_", "load", ".", "lc", ":", "30", " 86", ".", "0", "%", "..", " L", "5", "_", "39", " 86", ".", "0", "%", " p", "ng", ".", "lc", ":", "5", " 6", ".", "0", "%", "....", " L", "154", "_", "171", " 7", ".", "0", "%", " p", "ng", ".", "lc", ":", "154", " 76", ".", "0", "%", "....", " L", "53", "_", "78", " 88", ".", "4", "%", " p", "ng", ".", "lc", ":", "53", " (", "line", " 231", ",", " with", " 289", ")", "\n", "\n", "The", " assemb", "ler", "\n", "\n", "Mot", "ivated", " from", " the", " fast", " pa", "eth", " filter", ",", " I", " decided", " to", " pick", " up", " the", " google", "/", "CPU", "-", "in", "struct", "ions", " dataset", " and", " implement", " an", " assemb", "ler", " that", " uses", " those", " tables", ".", "\n", "\n", "If", " you", " are", " ever", " building", " an", " assemb", "ler", " remember", " that", " it", " helps", " a", " whole", " lot", " if", " you", " have", " a", " machine", "-", "readable", " table", " that", " tells", " the", " encoding", " and", " oper", "ands", " for", " every", " instruction", ".", "\n", "\n", "While", " writing", " my", " own", " I", " also", " noticed", " that", " the", " encoding", " task", " is", " easy", " if", " you", " break", " it", " into", " two", " stages", ".", " In", " the", " first", " stage", " you", " fill", " up", " the", " parameters", " such", " as", ":", "\n", "\n", "rex", " byte", "\n", "\n", "oper", "and", "_", "op", " field", " (", "for", " oper", "ands", " that", " embed", " into", " the", " op", "code", " fields", ")", "\n", "\n", "mod", "rm", " byte", "\n", "\n", "s", "ib", " byte", "\n", "\n", "dis", "pl", "acement", " offset", "\n", "\n", "im", "mediate", " values", " passed", " in", "\n", "\n", "Do", "ing", " this", " kind", " of", " scanning", " through", " the", " oper", "ands", " makes", " it", " easier", " to", " determine", " what", " is", " the", " size", " of", " the", " displacement", " field", " or", " where", " the", " S", "IB", " byte", " belongs", " to", ".", "\n", "\n", "The", " CPU", "-", "in", "struct", "ions", " also", " contains", " S", "SE", " and", " AV", "X", " instructions", ".", " And", " I", " expected", " they", " would", " require", " encoding", " of", " V", "EX", " or", " EVE", "X", " prefix", ".", " I", " didn", "'t", " do", " it", " right", " yet", ",", " but", " I", " am", " sure", " to", " return", " on", " the", " subject", " sometime", " soon", ".", " In", " any", " case", " the", " proper", " use", " of", " those", " instructions", " requires", " feature", " detection", " code", ".", "\n", "\n", "After", " looking", " at", " the", " m", "n", "emon", "ics", " for", " a", " while", ",", " I", " decided", " to", " not", " use", " them", " and", " instead", " treat", " them", " as", " a", " form", " of", " documentation", " that", " describes", " what", " semantic", " the", " instruction", " follows", ".", "\n", "\n", "Returns", " and", " branches", " that", " have", " far", " and", " near", " versions", " share", " the", " same", " m", "n", "emonic", ",", " so", " I", " found", " it", " a", " bit", " risky", " to", " just", " let", " a", " program", " select", " a", " certain", " instruction", " from", " the", " list", " and", " run", " with", " it", ".", " To", " work", " around", " this", " problem", ",", " I", " gave", " an", " unique", " identifier", " for", " every", " instruction", " in", " the", " list", ":", "\n", "\n", "59", "31", " X", "CH", "G", " AX", " r", "16", " [", "64", "]", " [", "L", "]", " Exchange", " r", "16", " with", " AX", ".", " 59", "32", " X", "CH", "G", " EA", "X", " r", "32", " [", "64", "]", " [", "L", "]", " Exchange", " r", "32", " with", " EA", "X", ".", " 59", "33", " X", "CH", "G", " RA", "X", " r", "64", " [", "64", "]", " Exchange", " r", "64", " with", " RA", "X", ".", " 59", "34", " X", "CH", "G", " m", "16", " r", "16", " [", "64", "]", " [", "L", "]", " Exchange", " r", "16", " with", " word", " from", " r", "/", "m", "16", ".", " 59", "35", " X", "CH", "G", " m", "32", " r", "32", " [", "64", "]", " [", "L", "]", " Exchange", " r", "32", " with", " double", "word", " from", " r", "/", "m", "32", ".", " 59", "36", " X", "CH", "G", " m", "64", " r", "64", " [", "64", "]", " Exchange", " r", "64", " with", " quad", "word", " from", " r", "/", "m", "64", ".", " 59", "37", " X", "CH", "G", " m", "8", " r", "8", " [", "64", "]", " [", "L", "]", " Exchange", " r", "8", " (", "byte", " register", ")", " with", " byte", " from", " r", "/", "m", "8", ".", " 59", "38", " X", "CH", "G", " m", "8", " r", "8", " [", "64", "]", " Exchange", " r", "8", " (", "byte", " register", ")", " with", " byte", " from", " r", "/", "m", "8", ".", " 59", "39", " X", "CH", "G", " r", "16", " AX", " [", "64", "]", " [", "L", "]", " Exchange", " AX", " with", " r", "16", ".", " 59", "40", " X", "CH", "G", " r", "16", " m", "16", " [", "64", "]", " [", "L", "]", " Exchange", " word", " from", " r", "/", "m", "16", " with", " r", "16", ".", " 59", "41", " X", "CH", "G", " r", "16", " r", "16", " [", "64", "]", " [", "L", "]", " Exchange", " word", " from", " r", "/", "m", "16", " with", " r", "16", ".", " 59", "42", " X", "CH", "G", " r", "16", " r", "16", " [", "64", "]", " [", "L", "]", " Exchange", " r", "16", " with", " word", " from", " r", "/", "m", "16", ".", " 59", "43", " X", "CH", "G", " r", "32", " EA", "X", " [", "64", "]", " [", "L", "]", " Exchange", " EA", "X", " with", " r", "32", ".", " 59", "44", " X", "CH", "G", " r", "32", " m", "32", " [", "64", "]", " [", "L", "]", " Exchange", " double", "word", " from", " r", "/", "m", "32", " with", " r", "32", ".", " 59", "45", " X", "CH", "G", " r", "32", " r", "32", " [", "64", "]", " [", "L", "]", " Exchange", " double", "word", " from", " r", "/", "m", "32", " with", " r", "32", ".", " 59", "46", " X", "CH", "G", " r", "32", " r", "32", " [", "64", "]", " [", "L", "]", " Exchange", " r", "32", " with", " double", "word", " from", " r", "/", "m", "32", ".", " 59", "47", " X", "CH", "G", " r", "64", " RA", "X", " [", "64", "]", " Exchange", " RA", "X", " with", " r", "64", ".", " 59", "48", " X", "CH", "G", " r", "64", " m", "64", " [", "64", "]", " Exchange", " quad", "word", " from", " r", "/", "m", "64", " with", " r", "64", ".", " 59", "49", " X", "CH", "G", " r", "64", " r", "64", " [", "64", "]", " Exchange", " r", "64", " with", " quad", "word", " from", " r", "/", "m", "64", ".", " 59", "50", " X", "CH", "G", " r", "64", " r", "64", " [", "64", "]", " Exchange", " quad", "word", " from", " r", "/", "m", "64", " with", " r", "64", ".", " 5", "951", " X", "CH", "G", " r", "8", " m", "8", " [", "64", "]", " [", "L", "]", " Exchange", " byte", " from", " r", "/", "m", "8", " with", " r", "8", " (", "byte", " register", ").", " 5", "952", " X", "CH", "G", " r", "8", " m", "8", " [", "64", "]", " Exchange", " byte", " from", " r", "/", "m", "8", " with", " r", "8", " (", "byte", " register", ").", " 5", "953", " X", "CH", "G", " r", "8", " r", "8", " [", "64", "]", " [", "L", "]", " Exchange", " r", "8", " (", "byte", " register", ")", " with", " byte", " from", " r", "/", "m", "8", ".", " 5", "954", " X", "CH", "G", " r", "8", " r", "8", " [", "64", "]", " [", "L", "]", " Exchange", " byte", " from", " r", "/", "m", "8", " with", " r", "8", " (", "byte", " register", ").", " 59", "55", " X", "CH", "G", " r", "8", " r", "8", " [", "64", "]", " Exchange", " r", "8", " (", "byte", " register", ")", " with", " byte", " from", " r", "/", "m", "8", ".", " 5", "956", " X", "CH", "G", " r", "8", " r", "8", " [", "64", "]", " Exchange", " byte", " from", " r", "/", "m", "8", " with", " r", "8", " (", "byte", " register", ").", "\n", "\n", "Many", " of", " these", " are", " the", " same", " op", "code", " but", " with", " different", " prefix", "es", " or", " flags", ".", " I", " don", "'t", " have", " a", " method", " to", " calculate", " the", " size", " of", " these", ",", " and", " I", " do", " not", " have", " a", " he", "uristic", " on", " selecting", " them", ".", "\n", "\n", "To", " represent", " Add", "resses", " in", " the", " memory", " oper", "ands", ",", " I", " picked", " the", " following", " format", ":", "\n", "\n", "Address", "(", "type", ",", " offset", ",", " base", "=-", "1", ",", " index", "=-", "1", ",", " scale", "=", "1", ")", "\n", "\n", "You", " can", " have", " the", " address", " without", " the", " base", " register", " if", " the", " additional", " 4", " bytes", " from", " offset", " is", " toler", "able", ".", "\n", "\n", "Now", " I", " finally", " can", " emit", " instructions", " like", " this", ":", "\n", "\n", "#", " 100", "6", " LE", "A", " r", "64", " m", " [", "64", "]", " Store", " effective", " address", " for", " m", " in", " register", " r", "64", ".", " emit", "(", "100", "6", ",", " Register", "(", "i", "64", ",", " 11", "),", " Address", "(", "i", "64", ",", " 0", ",", " 10", ",", " 13", "))", " #", " ABS", " on", " R", "11", " #", " 112", "7", " MOV", " r", "64", " r", "64", " [", "64", "]", " Move", " r", "/", "m", "64", " to", " r", "64", ".", " emit", "(", "112", "7", ",", " Register", "(", "i", "64", ",", " 13", "),", " Register", "(", "i", "64", ",", " 11", "))", " #", " 12", "89", " N", "EG", " r", "64", " [", "64", "]", " Two", "'s", " complement", " negate", " r", "/", "m", "64", ".", " emit", "(", "12", "89", ",", " Register", "(", "i", "64", ",", " 11", "))", " #", " 335", " CM", "OV", "L", " r", "64", " m", "64", " [", "64", "]", " Move", " if", " less", " (", "SF", "\ufffd", "\ufffd", " OF", ").", " emit", "(", " 335", ",", " Register", "(", "i", "64", ",", " 11", "),", " Register", "(", "i", "64", ",", " 13", "))", "\n", "\n", "I", " linked", " the", " loops", " by", " running", " the", " assemb", "ler", " twice", " and", " using", " ordinary", " variables", " for", " them", ":", "\n", "\n", "em", "it", "(", " 8", "78", ",", " Im", "mediate", "(", "i", "8", ",", " loop", "_", "label", " -", " j", "l", "1", "_", "label", "))", " j", "l", "1", "_", "label", " :=", " output", ".", "length", "\n", "\n", "As", " long", " as", " the", " instruction", " numbers", " and", " lengths", " do", " not", " change", ",", " the", " second", " run", " reaches", " the", " fixed", " point", ".", "\n", "\n", "The", " pa", "eth", " dec", "oder", " written", " in", " the", " assembly", " such", " as", " above", " looks", " like", " this", ":", "\n", "\n", "assert", " platform", ".", "arch", " ==", " \"", "x", "86", "_", "64", "\"", " \"", "It", " just", " might", " not", " work", " on", " x", "86", "\"", " assert", " platform", ".", "name", ".", "start", "sw", "ith", "(\"", "linux", "\")", " \"", "Also", " this", " depends", " on", " the", " System", "V", " calling", " conventions", ".\"", " arg", "_", "0", " =", " Register", "(", "i", "64", ",", " 7", ")", " #", " R", "DI", " arg", "_", "1", " =", " Register", "(", "i", "64", ",", " 6", ")", " #", " R", "SI", " arg", "_", "2", " =", " Register", "(", "i", "64", ",", " 2", ")", " #", " RD", "X", " arg", "_", "3", " =", " Register", "(", "i", "64", ",", " 1", ")", " #", " RC", "X", " arg", "_", "4", " =", " Register", "(", "i", "64", ",", " 8", ")", " arg", "_", "5", " =", " Register", "(", "i", "64", ",", " 9", ")", " loop", "_", "label", " =", " 0", " exit", "_", "label", " =", " 0", " ja", "_", "label", " =", " 0", " j", "l", "1", "_", "label", " =", " 0", " j", "l", "2", "_", "label", " =", " 0", " assemble", " =", " (", "):", " #", " 18", "11", " P", "USH", " r", "64", " [", "64", "]", " Push", " r", "64", ".", " #", " we", " need", " additional", " register", " to", " cl", "ob", "ber", ".", " emit", "(", "18", "11", ",", " Register", "(", "i", "64", ",", " 3", "))", " #", " x", ".", "r", "3", " emit", "(", "18", "11", ",", " Register", "(", "i", "64", ",", " 10", "))", " #", ".", "r", "10", " emit", "(", "18", "11", ",", " Register", "(", "i", "64", ",", " 11", "))", " #", ".", "r", "11", " emit", "(", "18", "11", ",", " Register", "(", "i", "64", ",", " 12", "))", " #", ".", "r", "12", " emit", "(", "18", "11", ",", " Register", "(", "i", "64", ",", " 13", "))", " #", " a", ".", "r", "13", " emit", "(", "18", "11", ",", " Register", "(", "i", "64", ",", " 14", "))", " #", " b", ".", "r", "14", " emit", "(", "18", "11", ",", " Register", "(", "i", "64", ",", " 15", "))", " #", " c", ".", "r", "15", " #", " i", " =", " 0", ".", "r", "0", " #", " 59", "73", " X", "OR", " m", "64", " r", "64", " [", "64", "]", " r", "/", "m", "64", " X", "OR", " r", "64", ".", " emit", "(", "59", "73", ",", " Register", "(", "i", "64", ",", " 0", "),", " Register", "(", "i", "64", ",", " 0", "))", " emit", "(", "59", "73", ",", " Register", "(", "i", "64", ",", " 13", "),", " Register", "(", "i", "64", ",", " 13", "))", " emit", "(", "59", "73", ",", " Register", "(", "i", "64", ",", " 15", "),", " Register", "(", "i", "64", ",", " 15", "))", " #", " j", " =", " offset", ".", "arg", "_", "4", "(", "8", ")", " #", " 12", "89", " N", "EG", " r", "64", " [", "64", "]", " Two", "'s", " complement", " negate", " r", "/", "m", "64", ".", " #", " 74", " ADD", " r", "64", " r", "64", " [", "64", "]", " Add", " r", "64", " to", " r", "/", "m", "64", ".", " #", " k", " =", " j", " -", " stride", ".", "r", "1", " emit", "(", "12", "89", ",", " Register", "(", "i", "64", ",", " 1", "))", " emit", "(", " 74", ",", " Register", "(", "i", "64", ",", " 1", "),", " Register", "(", "i", "64", ",", " 8", "))", " #", " 8", "78", " J", "L", " rel", "8", " [", "64", "]", " [", "L", "]", " Jump", " short", " if", " less", " (", "SF", "\ufffd", "\ufffd", " OF", ").", " emit", "(", " 8", "78", ",", " Im", "mediate", "(", "i", "8", ",", " loop", "_", "label", " -", " j", "l", "1", "_", "label", "))", " j", "l", "1", "_", "label", " :=", " output", ".", "length", " emit", "(", "12", "54", ",", " Register", "(", "i", "64", ",", " 13", "),", " Address", "(", "i", "8", ",", " 0", ",", " 7", ",", " 1", "))", " #", " [", "pri", "or", ".", "r", "7", " +", " k", ".", "r", "1", "]", " emit", "(", "12", "54", ",", " Register", "(", "i", "64", ",", " 15", "),", " Address", "(", "i", "8", ",", " 0", ",", " 6", ",", " 1", "))", " #", " [", "scan", "line", ".", "r", "6", " +", " k", ".", "r", "1", "]", " #", " loop", ":", " loop", "_", "label", " :=", " output", ".", "length", " #", " 04", "75", " C", "MP", " m", "64", " r", "64", " [", "64", "]", " Compare", " r", "64", " with", " r", "/", "m", "64", ".", " #", " if", " i", " >=", " length", " goto", " exit", " emit", "(", " 475", ",", " Register", "(", "i", "64", ",", " 0", "),", " arg", "_", "5", ")", " #", " 0", "86", "2", " J", "AE", " rel", "32", " [", "64", "]", " [", "L", "]", " Jump", " short", " if", " above", " or", " equal", " (", "CF", "=", "0", ").", " emit", "(", " 8", "62", ",", " Im", "mediate", "(", "i", "32", ",", " exit", "_", "label", " -", " ja", "_", "label", "))", " ja", "_", "label", " :=", " output", ".", "length", " ##", " Test", " #", " emit", "(", " 54", ",", " Address", "(", "i", "64", ",", " 0", ",", " arg", "_", "0", ".", "index", "),", " Im", "mediate", "(", "i", "32", ",", " 1", "))", " #", " 12", "54", " MOV", "ZX", " r", "64", " m", "8", " [", "64", "]", " Move", " byte", " to", " quad", "word", ",", " zero", "-", "ext", "ension", ".", " #", " x", " =", " input", "[", "i", "]", " emit", "(", "12", "54", ",", " Register", "(", "i", "64", ",", " 14", "),", " Address", "(", "i", "8", ",", " 0", ",", " 7", ",", " 8", "))", " #", " [", "pri", "or", ".", "r", "7", " +", " j", ".", "r", "8", "]", " #", " Starting", " pa", "eth", " predictor", " here", ".", " a", ".", "r", "13", ",", " b", ".", "r", "14", ",", " c", ".", "r", "15", " #", " 100", "6", " LE", "A", " r", "64", " m", " [", "64", "]", " Store", " effective", " address", " for", " m", " in", " register", " r", "64", ".", " #", " 23", "27", " SUB", " r", "64", " m", "64", " [", "64", "]", " Sub", "t", "ract", " r", "/", "m", "64", " from", " r", "64", ".", " #", "p", " =", " a", " +", " b", " -", " c", " p", ".", "r", "10", " emit", "(", "100", "6", ",", " Register", "(", "i", "64", ",", " 10", "),", " Address", "(", "i", "64", ",", " 0", ",", " 13", ",", " 14", "))", " emit", "(", "23", "27", ",", " Register", "(", "i", "64", ",", " 10", "),", " Register", "(", "i", "64", ",", " 15", "))", " emit", "(", "12", "89", ",", " Register", "(", "i", "64", ",", " 10", "))", " #", " negate", " to", " use", " LE", "A", " again", ".", " #", " 335", " CM", "OV", "L", " r", "64", " m", "64", " [", "64", "]", " Move", " if", " less", " (", "SF", "\ufffd", "\ufffd", " OF", ").", " #", " 112", "7", " MOV", " r", "64", " r", "64", " [", "64", "]", " Move", " r", "/", "m", "64", " to", " r", "64", ".", " #", "pa", " =", " abs", "(", "a", " -", " p", ")", " p", ".", "r", "10", " a", ".", "r", "13", " pa", ".", "r", "11", " emit", "(", "112", "7", ",", " Register", "(", "i", "64", ",", " 3", "),", " Register", "(", "i", "64", ",", " 13", "))", " emit", "(", "100", "6", ",", " Register", "(", "i", "64", ",", " 11", "),", " Address", "(", "i", "64", ",", " 0", ",", " 10", ",", " 13", "))", " #", " The", " a", ".", "r", "13", " is", " free", " now", ".", " #", " ABS", " on", " R", "11", " emit", "(", "112", "7", ",", " Register", "(", "i", "64", ",", " 13", "),", " Register", "(", "i", "64", ",", " 11", "))", " emit", "(", "12", "89", ",", " Register", "(", "i", "64", ",", " 11", "))", " #", " negate", " to", " use", " CM", "OV", "L", " emit", "(", " 335", ",", " Register", "(", "i", "64", ",", " 11", "),", " Register", "(", "i", "64", ",", " 13", "))", " #", "pb", " =", " abs", "(", "b", " -", " p", ")", " p", ".", "r", "10", " a", ".", "r", "13", " pa", ".", "r", "12", " emit", "(", "100", "6", ",", " Register", "(", "i", "64", ",", " 12", "),", " Address", "(", "i", "64", ",", " 0", ",", " 10", ",", " 14", "))", " #", " ABS", " on", " R", "12", " emit", "(", "112", "7", ",", " Register", "(", "i", "64", ",", " 13", "),", " Register", "(", "i", "64", ",", " 12", "))", " emit", "(", "12", "89", ",", " Register", "(", "i", "64", ",", " 12", "))", " #", " negate", " to", " use", " CM", "OV", "L", " emit", "(", " 335", ",", " Register", "(", "i", "64", ",", " 12", "),", " Register", "(", "i", "64", ",", " 13", "))", " #", " Now", " we", " want", " to", " compare", " and", " CM", "OV", "L", " if", " relevant", ".", " emit", "(", " 475", ",", " Register", "(", "i", "64", ",", " 12", "),", " Register", "(", "i", "64", ",", " 11", "))", " emit", "(", " 335", ",", " Register", "(", "i", "64", ",", " 11", "),", " Register", "(", "i", "64", ",", " 12", "))", " emit", "(", " 335", ",", " Register", "(", "i", "64", ",", " 3", "),", " Register", "(", "i", "64", ",", " 14", "))", " #", "pc", " =", " abs", "(", "c", " -", " p", ")", " p", ".", "r", "10", " a", ".", "r", "13", " pa", ".", "r", "11", " emit", "(", "100", "6", ",", " Register", "(", "i", "64", ",", " 12", "),", " Address", "(", "i", "64", ",", " 0", ",", " 10", ",", " 15", "))", " #", " ABS", " on", " R", "12", " emit", "(", "112", "7", ",", " Register", "(", "i", "64", ",", " 13", "),", " Register", "(", "i", "64", ",", " 12", "))", " emit", "(", "12", "89", ",", " Register", "(", "i", "64", ",", " 12", "))", " #", " negate", " to", " use", " CM", "OV", "L", " emit", "(", " 335", ",", " Register", "(", "i", "64", ",", " 12", "),", " Register", "(", "i", "64", ",", " 13", "))", " #", " Now", " we", " want", " to", " compare", " and", " CM", "OV", "L", " if", " relevant", ".", " emit", "(", " 475", ",", " Register", "(", "i", "64", ",", " 12", "),", " Register", "(", "i", "64", ",", " 11", "))", " emit", "(", " 335", ",", " Register", "(", "i", "64", ",", " 11", "),", " Register", "(", "i", "64", ",", " 12", "))", " emit", "(", " 335", ",", " Register", "(", "i", "64", ",", " 3", "),", " Register", "(", "i", "64", ",", " 15", "))", " #", " Done", " with", " pa", "eth", ",", " next", " we", " add", ".", " #", "em", "it", "(", "12", "54", ",", " Register", "(", "i", "64", ",", " 3", "),", " Address", "(", "i", "8", ",", " 0", ",", " 2", ",", " 0", "))", " #", " [", "input", ".", "r", "2", " +", " i", ".", "r", "0", "]", " #", " 78", " ADD", " r", "8", " m", "8", " [", "64", "]", " [", "L", "]", " Add", " r", "/", "m", "8", " to", " r", "8", ".", " emit", "(", " 78", ",", " Register", "(", "i", "8", ",", " 3", "),", " Address", "(", "i", "8", ",", " 0", ",", " 2", ",", " 0", "))", " #", " [", "input", ".", "r", "2", " +", " i", ".", "r", "0", "]", " #", " 10", "97", " MOV", " m", "8", " r", "8", " [", "64", "]", " [", "L", "]", " Move", " r", "8", " to", " r", "/", "m", "8", ".", " #", " scan", "line", "[", "j", "]", " =", " x", " emit", "(", "10", "97", ",", " Address", "(", "i", "8", ",", " 0", ",", " 6", ",", " 8", "),", " Register", "(", "i", "8", ",", " 3", "))", " #", " [", "scan", "line", ".", "r", "6", " +", " j", ".", "r", "8", "]", " #", " 00", "72", " ADD", " r", "64", " imm", "8", " [", "64", "]", " Add", " sign", "-", "ext", "ended", " imm", "8", " to", " r", "/", "m", "64", ".", " #", " i", " +=", " 1", " emit", "(", " 72", ",", " Register", "(", "i", "64", ",", " 0", "),", " Im", "mediate", "(", "i", "8", ",", " 1", "))", " #", " j", " +=", " 1", " emit", "(", " 72", ",", " Register", "(", "i", "64", ",", " 8", "),", " Im", "mediate", "(", "i", "8", ",", " 1", "))", " #", " clean", " a", " and", " c", " emit", "(", "59", "73", ",", " Register", "(", "i", "64", ",", " 13", "),", " Register", "(", "i", "64", ",", " 13", "))", " emit", "(", "59", "73", ",", " Register", "(", "i", "64", ",", " 15", "),", " Register", "(", "i", "64", ",", " 15", "))", " #", " k", " +=", " 1", " emit", "(", " 72", ",", " Register", "(", "i", "64", ",", " 1", "),", " Im", "mediate", "(", "i", "8", ",", " 1", "))", " #", " 8", "78", " J", "L", " rel", "8", " [", "64", "]", " [", "L", "]", " Jump", " short", " if", " less", " (", "SF", "\ufffd", "\ufffd", " OF", ").", " emit", "(", " 8", "78", ",", " Im", "mediate", "(", "i", "8", ",", " loop", "_", "label", " -", " j", "l", "2", "_", "label", "))", " j", "l", "2", "_", "label", " :=", " output", ".", "length", " emit", "(", "12", "54", ",", " Register", "(", "i", "64", ",", " 13", "),", " Address", "(", "i", "8", ",", " 0", ",", " 7", ",", " 1", "))", " #", " [", "pri", "or", ".", "r", "7", " +", " k", ".", "r", "1", "]", " emit", "(", "12", "54", ",", " Register", "(", "i", "64", ",", " 15", "),", " Address", "(", "i", "8", ",", " 0", ",", " 6", ",", " 1", "))", " #", " [", "scan", "line", ".", "r", "6", " +", " k", ".", "r", "1", "]", " #", " jump", " loop", " #", " 0", "886", " J", "MP", " rel", "32", " [", "64", "]", " [", "L", "]", " Jump", " short", ",", " RIP", " =", " RIP", " +", " 8", "-", "bit", " displacement", " sign", " extended", " to", " 64", "-", "bits", " emit", "(", " 8", "86", ",", " Im", "mediate", "(", "i", "32", ",", " loop", "_", "label", " -", " exit", "_", "label", "))", " #", " exit", ":", " exit", "_", "label", " :=", " output", ".", "length", " #", " Restore", ".", "r", "3", " we", " cl", "ob", "bered", ".", " #", " 16", "38", " POP", " r", "64", " [", "64", "]", " Pop", " top", " of", " stack", " into", " r", "64", ";", " increment", " stack", " pointer", ".", " Cannot", " encode", " 32", "-", "bit", " oper", "and", " size", ".", " emit", "(", "16", "38", ",", " Register", "(", "i", "64", ",", " 15", "))", " emit", "(", "16", "38", ",", " Register", "(", "i", "64", ",", " 14", "))", " emit", "(", "16", "38", ",", " Register", "(", "i", "64", ",", " 13", "))", " emit", "(", "16", "38", ",", " Register", "(", "i", "64", ",", " 12", "))", " emit", "(", "16", "38", ",", " Register", "(", "i", "64", ",", " 11", "))", " emit", "(", "16", "38", ",", " Register", "(", "i", "64", ",", " 10", "))", " emit", "(", "16", "38", ",", " Register", "(", "i", "64", ",", " 3", "))", " #", " return", " emit", "(", "19", "01", ")", " #", " RET", " NE", "AR", " emit", " =", " (", "uid", ",", " args", "...", "):", " output", ".", "ext", "end", "(", "asm", ".", "en", "code", "_", "ins", "(", "uid", ",", " args", "))", " output", " =", " []", " assemble", "()", " output", " =", " []", " assemble", "()", "\n", "\n", "At", " the", " point", " when", " I", " was", " going", " to", " write", " the", " actual", " algorithm", " the", " loop", " was", " supposed", " to", " run", ",", " I", " noticed", " that", " available", " registers", " almost", " ran", " out", ".", "\n", "\n", "From", " here", " it", "'s", " easy", " to", " run", " this", " in", " the", " place", " of", " the", " original", " pa", "eth", " filter", ".", " We", " copy", " the", " assemb", "ler", " output", " into", " executable", " memory", " region", " and", " W", "^", "X", " it", ".", " I", " already", " have", " an", " utility", " for", " that", ":", "\n", "\n", "buf", " =", " m", "man", ".", "As", "mb", "uf", "(", "40", "96", ")", " buf", ".", "mem", "c", "py", "(", "U", "int", "8", "Array", "(", "output", "))", " buf", ".", "final", "ize", "()", "\n", "\n", "Next", " we", " need", " a", " function", " handle", " that", " we", " can", " call", ".", " We", " get", " one", " from", " the", " F", "FI", ":", "\n", "\n", "c", "_", "type", " =", " f", "fi", ".", "c", "func", "(", "ff", "i", ".", "int", ",", " [", " f", "fi", ".", "void", "p", ",", " f", "fi", ".", "void", "p", ",", " f", "fi", ".", "void", "p", ",", " #", " prior", ",", " scan", "line", ",", " data", " f", "fi", ".", "size", "_", "t", ",", "ff", "i", ".", "size", "_", "t", ",", "ff", "i", ".", "size", "_", "t", "])", " #", " stride", ",", " offset", ",", " length", " c", "_", "func", " =", " f", "fi", ".", "cast", "(", "buf", ",", " c", "_", "type", ")", "\n", "\n", "The", " filter", " array", " requires", " a", " little", " rewrite", " so", " that", " the", " length", " -", "field", " is", " exposed", " like", " above", ",", " but", " otherwise", " this", " already", " works", " and", " we", " can", " hot", "-", "patch", " the", " assemb", "ler", " program", " into", " the", " p", "ng", " module", ":", "\n", "\n", "import", " p", "ng", " p", "ng", ".", "dec", "ode", "_", "fil", "ters", "[", "4", "]", " =", " c", "_", "func", " main", "_", "png", "()", "\n", "\n", "Now", " we", " can", " run", " the", " original", " benchmark", ".", "\n", "\n", "As", "semb", "ler", " results", "\n", "\n", "With", " the", " monkey", "-", "pat", "ched", " assembly", " module", ",", " our", " original", " benchmark", " now", " takes", " 0", ".", "6", " seconds", " to", " run", ",", " and", " the", " vm", "profile", " report", " is", " very", " closely", " resembling", " the", " removal", " of", " pa", "eth", " dec", "oder", ":", "\n", "\n", "100", ".", "0", "%", " L", "5", "_", "200", " 100", ".", "0", "%", " fast", "_", "pa", "eth", ".", "lc", ":", "5", " 100", ".", "0", "%", "..", " L", "203", "_", "217", " 100", ".", "0", "%", " fast", "_", "pa", "eth", ".", "lc", ":", "203", " 6", ".", "6", "%", "....", " L", "230", "_", "241", " 6", ".", "6", "%", " fast", "_", "pa", "eth", ".", "lc", ":", "230", " 92", ".", "3", "%", "....", " L", "5", "_", "39", " 92", ".", "3", "%", " p", "ng", ".", "lc", ":", "5", " 11", ".", "0", "%", "......", " L", "149", "_", "166", " 11", ".", "9", "%", " p", "ng", ".", "lc", ":", "149", " 3", ".", "3", "%", "........", " L", "166", "_", "168", " 30", ".", "0", "%", " p", "ng", ".", "lc", ":", "166", " 79", ".", "1", "%", "......", " L", "53", "_", "78", " 85", ".", "7", "%", " p", "ng", ".", "lc", ":", "53", " (", "line", " 231", ",", " with", " 289", ")", " 1", ".", "1", "%", "........", " L", "93", "_", "96", " 1", ".", "4", "%", " p", "ng", ".", "lc", ":", "93", " 24", ".", "2", "%", "........", " L", "98", "_", "104", " 30", ".", "6", "%", " p", "ng", ".", "lc", ":", "98", " 4", ".", "4", "%", "........", " L", "85", "_", "91", " 5", ".", "6", "%", " p", "ng", ".", "lc", ":", "85", "\n", "\n", "I", " did", " double", " check", " that", " the", " pa", "eth", " dec", "oder", " keeps", " working", ".", " I", " made", " a", " hex", "ade", "c", "imal", " dump", " from", " the", " image", " and", " compared", " the", " data", " with", " the", " optimized", " version", ".", " Both", " of", " them", " look", " like", " this", ":", "\n", "\n", "35", " 51", " 45", " ff", " 36", " 46", " 3", "b", " ff", " 1", "b", " 1", "e", " 19", " ff", " 18", " 1", "b", " 16", " ff", " 33", " 4", "f", " 43", " ff", " 27", " 3", "a", " 2", "f", " ff", " 1", "b", " 1", "e", " 19", " ff", " 18", " 1", "b", " 16", " ff", " 2", "c", " 4", "a", " 40", " ff", " 2", "e", " 4", "c", " 42", " ff", " 2", "f", " 4", "d", " 43", " ff", " 34", " 4", "f", " 46", " ff", " 27", " 45", " 3", "b", " ff", " 29", " 47", " 3", "d", " ff", " 2", "a", " 48", " 3", "e", " ff", " 28", " 48", " 3", "a", " ff", " 27", " 47", " 3", "c", " ff", " 26", " 44", " 3", "a", " ff", " 25", " 43", " 39", " ff", " 23", " 43", " 39", " ff", "\n", "\n", "You", " can", " tell", " that", " this", " data", " is", " at", " least", " plaus", "ibly", " correct", ",", " because", " of", " the", " full", " alpha", " channels", " separating", " the", " scan", "lines", " into", " columns", " of", " ff", " -", "sy", "mb", "ols", ".", "\n", "\n", "The", " closer", " inspection", " shows", " that", " the", " assembled", " version", " has", " some", " errors", ".", " It", " still", " runs", " through", " all", " the", " pixels", " so", " I", "'d", " believe", " the", " problem", " could", " be", " something", " subtle", ":", "\n", "\n", "I", " won", "'t", " use", " the", " assembled", " version", " right", " yet", ",", " so", " I", " leave", " the", " fix", " for", " later", " iterations", ".", "\n", "\n", "Finally", " I", " also", " made", " a", " Vulkan", " demo", " that", " uses", " the", " J", "IT", "-", "optim", "ized", " p", "ng", " module", ".", " Here", "'s", " the", " screenshot", ":", "\n", "\n", "Hand", "-", "written", " assembly", " is", " not", " practical", "\n", "\n", "The", " assemb", "ler", " optimization", " is", " very", " successful", " considering", " that", " we", " don", "'t", " even", " have", " to", " store", " any", " compiled", " execut", "ables", " here", " and", " we", " are", " still", " 4", " times", " faster", " than", " within", " the", " J", "IT", ".", "\n", "\n", "The", " problem", " is", " that", " the", " assembly", " module", " here", " cannot", " adjust", " for", " different", " calling", " conventions", ".", " It", " only", " works", " on", " Linux", " and", " on", " x", "86", "_", "64", ".", " There", " are", " other", " problems", ":", "\n", "\n", "We", " have", " two", " versions", " to", " maintain", ".", " And", " if", " we", " discard", " the", " old", " version", " then", " we", " cannot", " return", " to", " J", "IT", "-", "eval", "uating", " the", " code", " in", " the", " case", " it", " is", " more", " practical", " for", " some", " possible", " use", "case", ".", "\n", "\n", "We", " had", " to", " rewrite", " the", " assemb", "ler", " version", " from", " the", " scratch", " when", " trying", " to", " optimize", " the", " program", " that", " way", ".", "\n", "\n", "We", " cannot", " access", " all", " GC", " records", " from", " the", " assembly", ".", " Only", " the", " ones", " that", " we", " could", " naturally", " pass", " into", " C", " libraries", ".", "\n", "\n", "The", " produced", " assembly", " code", " is", " calling", "-", "con", "vention", " dependent", " and", " fixed", " to", " an", " operating", " system", ".", "\n", "\n", "The", " practical", " solution", " would", " be", " to", " run", " type", " inference", " into", " the", " original", " program", " and", " then", " compile", " it", " down", " to", " assembly", " codes", ".", " It", " is", " the", " reason", " why", " I", " wrote", " the", " assemb", "ler", " in", " the", " first", " place", ",", " but", " it", " is", " also", " a", " subject", " for", " a", " second", " blog", " post", ".", "\n", "\n", "Dri", "ving", " it", " through", " G", "LS", "L", " filter", " in", " Vulkan", "\n", "\n", "Finally", " I", " made", " a", " v", "ulkan", " application", " that", " uses", " the", " PNG", " loader", ".", " The", " full", " source", " code", " can", " be", " found", " at", " the", " samples", "/", "w", "arp", "gpu", "/", "2", "_", "images", ".", "lc", ".", "\n", "\n", "After", " the", " image", " has", " been", " loaded", ",", " we", " upload", " it", " to", " the", " GPU", " by", " mem", "cop", "ying", " into", " mapped", " location", " like", " this", ":", "\n", "\n", "image", ".", "mem", " =", " g", "pu", ".", "mem", ".", "ass", "ociate", "(", "image", ",", " [", " \"", "H", "OST", "_", "VIS", "IBLE", "_", "BIT", "\",", " \"", "H", "OST", "_", "CO", "HER", "ENT", "_", "BIT", "\"", " ])", " data", " =", " image", ".", "mem", ".", "map", "(", "ff", "i", ".", "byte", ",", " image", ".", "offset", ",", " image", ".", "size", ")", " f", "fi", ".", "mem", "c", "py", "(", "data", ",", " p", "ng", "_", "image", ".", "data", ",", " p", "ng", "_", "image", ".", "data", ".", "length", ")", "\n", "\n", "Of", " course", ",", " this", " is", " a", " bit", " wasteful", " because", " the", " PNG", " loader", " wouldn", "'t", " really", " need", " anything", " else", " but", " two", " latest", " scan", "lines", ".", " It", " could", " write", " into", " the", " scan", "line", " and", " the", " image", " simultaneously", " to", " load", " the", " image", " without", " ever", " holding", " the", " fully", " decomp", "ressed", " image", " in", " the", " memory", ".", "\n", "\n", "It", " was", " nice", " to", " start", " with", " the", " simple", " use", "case", " first", " though", ".", "\n", "\n", "Finally", " I", " checked", " the", " image", " in", " the", " G", "LS", "L", " output", ".", " It", " producing", " the", " effect", " by", " shifting", " the", " texture", " coordinates", " horizontally", " using", " output", " from", " a", " v", "or", "on", "oi", " noise", " generator", ":", "\n", "\n", "Extra", ":", " Lets", " try", " S", "SE", " &", " SIM", "D", " instructions", "!", "\n", "\n", "At", " first", " I", " thought", " I", " wouldn", "'t", " go", " this", " far", ",", " but", " I", " still", " had", " Sunday", " to", " go", " and", " everyone", " reading", " this", " post", " would", " expect", " me", " to", " get", " into", " SIM", "D", ".", " So", " let", "'s", " go", "!", "\n", "\n", "The", " feature", " detection", " is", " mandatory", " if", " you", " intend", " to", " use", " SIM", "D", ",", " but", " the", " first", " thing", " was", " to", " check", " what", " my", " CPU", " actually", " supports", ".", " So", " I", " ran", " the", " cat", " /", "proc", "/", "cpu", "info", ".", "\n", "\n", "v", "endor", "_", "id", " :", " Gen", "uine", "Intel", " cpu", " family", " :", " 6", " model", " :", " 23", " model", " name", " :", " Intel", "(", "R", ")", " Core", "(", "TM", ")", "2", " Quad", " CPU", " Q", "95", "50", " @", " 2", ".", "83", "GHz", " stepping", " :", " 7", " micro", "code", " :", " 0", "x", "70", "a", " cpu", " MHz", " :", " 2003", ".", "000", " cache", " size", " :", " 6", "144", " KB", " physical", " id", " :", " 0", " siblings", " :", " 4", " core", " id", " :", " 0", " cpu", " cores", " :", " 4", " ap", "ic", "id", " :", " 0", " initial", " ap", "ic", "id", " :", " 0", " f", "pu", " :", " yes", " f", "pu", "_", "ex", "ception", " :", " yes", " cpu", "id", " level", " :", " 10", " w", "p", " :", " yes", " flags", " :", " f", "pu", " v", "me", " de", " pse", " t", "sc", " ms", "r", " p", "ae", " m", "ce", " cx", "8", " ap", "ic", " sep", " m", "tr", "r", " p", "ge", " m", "ca", " cm", "ov", " pat", " pse", "36", " cl", "flush", " d", "ts", " ac", "pi", " mm", "x", " f", "x", "sr", " s", "se", " s", "se", "2", " ss", " h", "t", " t", "m", " p", "be", " sy", "sc", "all", " n", "x", " l", "m", " constant", "_", "ts", "c", " arch", "_", "per", "f", "mon", " pe", "bs", " b", "ts", " rep", "_", "good", " n", "opl", " a", "per", "fm", "per", "f", " p", "ni", " d", "tes", "64", " monitor", " d", "s", "_", "c", "pl", " v", "mx", " sm", "x", " est", " t", "m", "2", " ss", "se", "3", " cx", "16", " ", "xt", "pr", " p", "d", "cm", " s", "se", "4", "_", "1", " l", "ah", "f", "_", "l", "m", " t", "pr", "_", "shadow", " v", "n", "mi", " flex", "priority", " d", "ther", "m", " bugs", " :", " bog", "om", "ips", " :", " 5", "666", ".", "40", " cl", "flush", " size", " :", " 64", " cache", "_", "al", "ignment", " :", " 64", " address", " sizes", " :", " 36", " bits", " physical", ",", " 48", " bits", " virtual", " power", " management", ":", "\n", "\n", "It", " seems", " that", " I", " can", " use", " all", " the", " instructions", " up", " to", " S", "SE", "4", "_", "1", ".", " Unfortunately", " the", " use", " of", " the", " S", "SE", " doesn", "'t", " require", " the", " V", "EX", " prefix", " so", " I", " don", "'t", " have", " a", " way", " to", " test", " whether", " I", " would", " get", " the", " V", "EX", " encoding", " right", ".", "\n", "\n", "It", "'s", " no", " wonder", " that", " stereotypical", " g", "eeks", " are", " charismatic", " white", " males", " with", " fancy", " be", "ards", " and", " no", " girlfriends", "!", " You", " would", " need", " very", " big", " w", "ads", " of", " cash", " to", " stay", " updated", " on", " all", " the", " coolest", " hardware", " that", " pushes", " out", " of", " the", " factories", " at", " the", " constant", " feed", ".", "\n", "\n", "Quick", " look", " into", " the", " instruction", " table", " tells", " that", " I", " have", " 5", "65", " SIM", "D", " operations", " available", ".", " When", " I", " discard", " the", " operations", " that", " work", " on", " floating", " point", " values", ",", " I", " end", " up", " with", " 361", " operations", " to", " choose", " from", ".", "\n", "\n", "Vector", "izing", " the", " program", "\n", "\n", "The", " first", " step", " is", " to", " look", " at", " the", " original", " program", " and", " see", " what", " we", " could", " do", " for", " it", ".", " To", " make", " this", " easier", " we", " break", " it", " to", " break", " it", " into", " extended", " basic", " blocks", ":", "\n", "\n", "t", " =", " a", " +", " b", " p", " =", " t", " -", " c", " ta", " =", " p", " -", " a", " pa", " =", " abs", " ta", " t", "b", " =", " p", " -", " b", " p", "b", " =", " abs", " t", "b", " tc", " =", " p", " -", " c", " pc", " =", " abs", " tc", " c", "1", " =", " le", " pa", " p", "b", " c", "2", " =", " le", " pa", " pc", " c", "3", " =", " and", " c", "1", " c", "2", " return", " a", " if", " c", "3", " c", "4", " =", " le", " p", "b", " pc", " return", " b", " if", " c", "4", " return", " c", "\n", "\n", "It", " is", " surprisingly", " lot", " of", " operations", " after", " all", ".", " What", " we", " are", " about", " to", " do", " is", " called", " auto", " vector", "ization", " in", " comp", "ilers", ".", " I", " guess", " what", " we", " are", " specifically", " about", " to", " do", " is", " called", " loop", " vector", "ization", ".", "\n", "\n", "One", " important", " thing", " is", " to", " note", " that", " the", " algorithm", " has", " not", " been", " defined", " on", " bytes", ".", " This", " means", " that", " we", " might", " get", " the", " wrong", " result", " if", " we", " keep", " the", " bytes", " packed", " in", " our", " registers", ".", " We", " may", " have", " to", " un", "pack", " so", " we", " are", " going", " to", " need", " instructions", " for", " those", ".", " Also", " we", " are", " going", " to", " need", " the", " instructions", " to", " load", " values", " into", " the", " x", "mm", " registers", ".", " I", " think", " the", " following", " is", " sufficient", ":", "\n", "\n", "P", "ACK", "SS", "DW", " PACK", "SS", "DW", " PACK", "SS", "DW", " PACK", "SS", "DW", " PACK", "SS", "WB", " PACK", "SS", "WB", " PACK", "SS", "WB", " PACK", "SS", "WB", " PACK", "US", "WB", " PACK", "US", "WB", " PACK", "US", "WB", " PACK", "US", "WB", " P", "UN", "PC", "K", "HB", "W", " P", "UN", "PC", "K", "HB", "W", " P", "UN", "PC", "K", "HB", "W", " P", "UN", "PC", "K", "HB", "W", " P", "UN", "PC", "K", "HD", "Q", " P", "UN", "PC", "K", "HD", "Q", " P", "UN", "PC", "K", "HD", "Q", " P", "UN", "PC", "K", "HD", "Q", " P", "UN", "PC", "K", "HQ", "D", "Q", " P", "UN", "PC", "K", "HQ", "D", "Q", " P", "UN", "PC", "K", "H", "WD", " P", "UN", "PC", "K", "H", "WD", " P", "UN", "PC", "K", "H", "WD", " P", "UN", "PC", "K", "H", "WD", " P", "UN", "PC", "K", "LB", "W", " P", "UN", "PC", "K", "LB", "W", " P", "UN", "PC", "K", "LB", "W", " P", "UN", "PC", "K", "LB", "W", " P", "UN", "PC", "K", "LD", "Q", " P", "UN", "PC", "K", "LD", "Q", " P", "UN", "PC", "K", "LD", "Q", " P", "UN", "PC", "K", "LD", "Q", " P", "UN", "PC", "K", "L", "Q", "D", "Q", " P", "UN", "PC", "K", "L", "Q", "D", "Q", " P", "UN", "PC", "K", "L", "WD", " P", "UN", "PC", "K", "L", "WD", " P", "UN", "PC", "K", "L", "WD", " P", "UN", "PC", "K", "L", "WD", " MOV", "D", "Q", "A", " MOV", "D", "QU", "\n", "\n", "Second", " I", "'ve", " been", " looking", " up", " what", " I", " can", " find", " from", " our", " instruction", " table", " of", " valid", " operations", ".", " I", " found", " the", " following", ":", "\n", "\n", "t", " =", " a", " +", " b", " P", "AD", "DB", ",", " P", "AD", "DD", ",", " P", "ADD", "Q", ",", " P", "AD", "DS", "B", ",", " P", "AD", "DS", "W", ",", " P", "ADD", "USB", ",", " P", "ADD", "US", "W", ",", " P", "ADD", "W", ",", " P", "ADD", "W", ",", " PAL", "IGN", "R", " [", "m", "64", ",", " m", "128", "]", " p", " =", " t", " -", " c", " PS", "UB", "B", ",", " PS", "UB", "D", ",", " PS", "UB", "Q", ",", " PSU", "BS", "B", ",", " PSU", "BS", "W", ",", " PS", "UB", "USB", ",", " PS", "UB", "US", "W", ",", " PS", "UB", "W", " ta", " =", " p", " -", " a", " pa", " =", " abs", " ta", " PA", "BS", "B", ",", " PA", "BSD", " PA", "BS", "W", " [", "m", "64", ",", " m", "128", "]", " t", "b", " =", " p", " -", " b", " p", "b", " =", " abs", " t", "b", " tc", " =", " p", " -", " c", " pc", " =", " abs", " tc", " c", "1", " =", " le", " pa", " p", "b", " PC", "M", "PG", "TB", ",", " PC", "M", "PG", "TW", ",", " PC", "M", "PG", "TD", " [", "m", "64", ",", " m", "128", "]", " c", "2", " =", " le", " pa", " pc", " c", "3", " =", " and", " c", "1", " c", "2", " P", "AND", ",", " P", "AND", "N", " [", "m", "64", ",", " m", "128", "]", " return", " a", " if", " c", "3", " c", "4", " =", " le", " p", "b", " pc", " return", " b", " if", " c", "4", " return", " c", "\n", "\n", "It", " appears", " that", " we", " have", " m", "128", " for", " everything", " so", " we", " can", " use", " the", " S", "SE", "2", " instructions", " everywhere", " here", ".", " We", " would", " also", " have", " PH", "ADD", "W", " to", " add", " packed", " short", " integers", " horizontally", ".", "\n", "\n", "The", " SIM", "D", " instructions", " do", " not", " have", " conditional", " operations", ",", " so", " instead", " we", " have", " to", " use", " a", " trick", " on", " them", ".", "\n", "\n", "return", " a", " if", " c", "3", " P", "AND", ",", " P", "AND", "N", ",", " P", "OR", ",", " P", "X", "OR", " [", "m", "64", ",", " m", "128", "]", " c", "4", " =", " le", " p", "b", " pc", " return", " b", " if", " c", "4", " return", " c", "\n", "\n", "Here", " we", " have", " everything", " we", " need", " to", " carry", " this", " out", " now", ".", " The", " final", " program", ":", "\n", "\n", "result", " =", " 11", "68", " MOV", "D", "QU", " [", "input", " +", " i", " -", " offset", "]", " a", " =", " 11", "64", " MOV", "D", "QU", " [", "scan", "line", " +", " i", " -", " stride", "]", " b", " =", " 11", "68", " MOV", "D", "QU", " [", "pri", "or", " +", " i", "]", " c", " =", " 11", "64", " MOV", "D", "QU", " [", "pri", "or", " +", " i", " -", " stride", "]", " al", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " a", " bl", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " b", " cl", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " c", " ah", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " a", " b", "h", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " b", " ch", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " c", " pal", " =", " 11", "65", " MOV", "D", "Q", "A", " al", " p", "ah", " =", " 11", "65", " MOV", "D", "Q", "A", " ah", " pal", " +=", " 13", "95", " P", "AD", "DD", " bl", " p", "ah", " +=", " 13", "95", " P", "AD", "DD", " b", "h", " pal", " -=", " 17", "42", " PS", "UB", "D", " al", " p", "ah", " -=", " 17", "42", " PS", "UB", "D", " ah", " p", "bl", " =", " 11", "65", " MOV", "D", "Q", "A", " pal", " p", "bh", " =", " 11", "65", " MOV", "D", "Q", "A", " p", "ah", " p", "cl", " =", " 11", "65", " MOV", "D", "Q", "A", " pal", " p", "ch", " =", " 11", "65", " MOV", "D", "Q", "A", " p", "ah", " pal", " -=", " 17", "42", " PS", "UB", "D", " al", " p", "bl", " -=", " 17", "42", " PS", "UB", "D", " bl", " p", "cl", " -=", " 17", "42", " PS", "UB", "D", " cl", " p", "ah", " -=", " 17", "42", " PS", "UB", "D", " ah", " p", "bh", " -=", " 17", "42", " PS", "UB", "D", " b", "h", " p", "ch", " -=", " 17", "42", " PS", "UB", "D", " ch", " pal", " =", " 13", "69", " PA", "BSD", " pal", " p", "bl", " =", " 13", "69", " PA", "BSD", " p", "bl", " p", "cl", " =", " 13", "69", " PA", "BSD", " p", "cl", " p", "ah", " =", " 13", "69", " PA", "BSD", " p", "ah", " p", "bh", " =", " 13", "69", " PA", "BSD", " p", "bh", " p", "ch", " =", " 13", "69", " PA", "BSD", " p", "ch", " c", "1", "l", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "bl", " pal", " c", "2", "l", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "cl", " pal", " c", "4", "l", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "cl", " p", "bl", " c", "1", "h", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "bh", " p", "ah", " c", "2", "h", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "ch", " p", "ah", " c", "4", "h", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "ch", " p", "bh", " c", "3", "l", " =", " 14", "27", " P", "AND", " c", "1", "l", " c", "2", "l", " c", "3", "h", " =", " 14", "27", " P", "AND", " c", "1", "h", " c", "2", "h", " bl", " =", " 14", "27", " P", "AND", " bl", " c", "4", "l", " b", "h", " =", " 14", "27", " P", "AND", " b", "h", " c", "4", "h", " cl", " =", " 14", "31", " P", "AND", "N", " cl", ",", " c", "4", "l", " ch", " =", " 14", "31", " P", "AND", "N", " ch", ",", " c", "4", "h", " bl", " =", " 16", "50", " P", "OR", " bl", ",", " cl", " b", "h", " =", " 16", "50", " P", "OR", " b", "h", ",", " ch", " al", " =", " 14", "27", " P", "AND", " al", ",", " c", "3", "l", " ah", " =", " 14", "27", " P", "AND", " ah", ",", " c", "3", "h", " bl", " =", " 14", "31", " P", "AND", "N", " bl", ",", " c", "3", "l", " b", "h", " =", " 14", "31", " P", "AND", "N", " b", "h", ",", " c", "3", "h", " al", " =", " 16", "50", " P", "OR", " al", ",", " bl", " ah", " =", " 16", "50", " P", "OR", " ah", ",", " b", "h", " delta", " =", " 13", "87", " PACK", "US", "WB", " al", ",", " ah", " result", " +=", " 13", "91", " P", "AD", "DB", " delta", " 11", "67", " MOV", "D", "QU", " [", "scan", "line", "],", " result", "\n", "\n", "It", "'s", " ridiculous", "!", " 54", " operations", " that", " run", " on", " 16", " bytes", " of", " data", " at", " once", ".", " Next", " we", " should", " allocate", " registers", " and", " produce", " the", " program", ".", " On", " Linux", " we", " are", " free", " to", " use", " the", " whole", " range", " of", " X", "MM", " registers", " without", " having", " to", " store", " them", ",", " so", " we", " do", " so", ".", "\n", "\n", "sim", "d", "_", "pa", "eth", "_", "assembly", " =", " (", "em", "it", ",", " input", "_", "addr", ",", " a", "_", "addr", ",", " b", "_", "addr", ",", " c", "_", "addr", ",", " scan", "line", "_", "addr", "):", " x", "mm", "0", " =", " Register", "(", "m", "128", ",", " 0", ")", " x", "mm", "1", " =", " Register", "(", "m", "128", ",", " 1", ")", " x", "mm", "2", " =", " Register", "(", "m", "128", ",", " 2", ")", " x", "mm", "3", " =", " Register", "(", "m", "128", ",", " 3", ")", " x", "mm", "4", " =", " Register", "(", "m", "128", ",", " 4", ")", " x", "mm", "5", " =", " Register", "(", "m", "128", ",", " 5", ")", " x", "mm", "6", " =", " Register", "(", "m", "128", ",", " 6", ")", " x", "mm", "7", " =", " Register", "(", "m", "128", ",", " 7", ")", " x", "mm", "8", " =", " Register", "(", "m", "128", ",", " 8", ")", " x", "mm", "9", " =", " Register", "(", "m", "128", ",", " 9", ")", " x", "mm", "10", " =", " Register", "(", "m", "128", ",", " 10", ")", " x", "mm", "11", " =", " Register", "(", "m", "128", ",", " 11", ")", " x", "mm", "12", " =", " Register", "(", "m", "128", ",", " 12", ")", " x", "mm", "13", " =", " Register", "(", "m", "128", ",", " 13", ")", " x", "mm", "14", " =", " Register", "(", "m", "128", ",", " 14", ")", " x", "mm", "15", " =", " Register", "(", "m", "128", ",", " 15", ")", " #", " register", " allocation", " result", " =", " x", "mm", "0", " al", " =", " x", "mm", "1", " bl", " =", " x", "mm", "2", " cl", " =", " x", "mm", "3", " ah", " =", " x", "mm", "4", " b", "h", " =", " x", "mm", "5", " ch", " =", " x", "mm", "6", " pal", " =", " x", "mm", "7", " p", "bl", " =", " x", "mm", "8", " p", "cl", " =", " x", "mm", "9", " p", "ah", " =", " x", "mm", "10", " p", "bh", " =", " x", "mm", "11", " p", "ch", " =", " x", "mm", "12", " #", " result", " =", " 11", "64", " MOV", "D", "QU", " [", "input", " +", " i", " -", " offset", "]", " emit", "(", "11", "68", ",", " result", ",", " input", "_", "addr", ")", " #", " a", " =", " 11", "68", " MOV", "D", "QU", " [", "scan", "line", " +", " i", " -", " stride", "]", " emit", "(", "11", "64", ",", " al", ",", " a", "_", "addr", ")", " #", " b", " =", " 11", "68", " MOV", "D", "QU", " [", "pri", "or", " +", " i", "]", " emit", "(", "11", "68", ",", " bl", ",", " b", "_", "addr", ")", " #", " c", " =", " 11", "68", " MOV", "D", "QU", " [", "pri", "or", " +", " i", " -", " stride", "]", " emit", "(", "11", "64", ",", " cl", ",", " c", "_", "addr", ")", " #", " ah", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " a", " #", " b", "h", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " b", " #", " ch", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " c", " emit", "(", "17", "72", ",", " ah", ",", " al", ")", " emit", "(", "17", "72", ",", " b", "h", ",", " bl", ")", " emit", "(", "17", "72", ",", " ch", ",", " cl", ")", " #", " al", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " a", " #", " bl", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " b", " #", " cl", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " c", " emit", "(", "17", "86", ",", " al", ",", " al", ")", " emit", "(", "17", "86", ",", " bl", ",", " bl", ")", " emit", "(", "17", "86", ",", " cl", ",", " cl", ")", " #", " pal", " =", " 11", "65", " MOV", "D", "Q", "A", " al", " #", " p", "ah", " =", " 11", "65", " MOV", "D", "Q", "A", " ah", " emit", "(", "11", "65", ",", " pal", ",", " al", ")", " emit", "(", "11", "65", ",", " p", "ah", ",", " ah", ")", " #", " pal", " +=", " 13", "95", " P", "AD", "DD", " bl", " #", " p", "ah", " +=", " 13", "95", " P", "AD", "DD", " b", "h", " emit", "(", "13", "95", ",", " pal", ",", " bl", ")", " emit", "(", "13", "95", ",", " p", "ah", ",", " b", "h", ")", " #", " pal", " -=", " 17", "42", " PS", "UB", "D", " al", " #", " p", "ah", " -=", " 17", "42", " PS", "UB", "D", " ah", " emit", "(", "17", "42", ",", " pal", ",", " al", ")", " emit", "(", "17", "42", ",", " p", "ah", ",", " ah", ")", " #", " p", "bl", " =", " 11", "65", " MOV", "D", "Q", "A", " pal", " #", " p", "bh", " =", " 11", "65", " MOV", "D", "Q", "A", " p", "ah", " #", " p", "cl", " =", " 11", "65", " MOV", "D", "Q", "A", " pal", " #", " p", "ch", " =", " 11", "65", " MOV", "D", "Q", "A", " p", "ah", " emit", "(", "11", "65", ",", " p", "bl", ",", " pal", ")", " emit", "(", "11", "65", ",", " p", "bh", ",", " p", "ah", ")", " emit", "(", "11", "65", ",", " p", "cl", ",", " p", "cl", ")", " emit", "(", "11", "65", ",", " p", "ch", ",", " p", "ch", ")", " #", " pal", " -=", " 17", "42", " PS", "UB", "D", " al", " #", " p", "bl", " -=", " 17", "42", " PS", "UB", "D", " bl", " #", " p", "cl", " -=", " 17", "42", " PS", "UB", "D", " cl", " #", " p", "ah", " -=", " 17", "42", " PS", "UB", "D", " ah", " #", " p", "bh", " -=", " 17", "42", " PS", "UB", "D", " b", "h", " #", " p", "ch", " -=", " 17", "42", " PS", "UB", "D", " ch", " emit", "(", "17", "42", ",", " pal", ",", " al", ")", " emit", "(", "17", "42", ",", " p", "bl", ",", " bl", ")", " emit", "(", "17", "42", ",", " p", "cl", ",", " cl", ")", " emit", "(", "17", "42", ",", " p", "ah", ",", " ah", ")", " emit", "(", "17", "42", ",", " p", "bh", ",", " b", "h", ")", " emit", "(", "17", "42", ",", " p", "ch", ",", " ch", ")", " #", " pal", " =", " 13", "69", " PA", "BSD", " pal", " #", " p", "bl", " =", " 13", "69", " PA", "BSD", " p", "bl", " #", " p", "cl", " =", " 13", "69", " PA", "BSD", " p", "cl", " #", " p", "ah", " =", " 13", "69", " PA", "BSD", " p", "ah", " #", " p", "bh", " =", " 13", "69", " PA", "BSD", " p", "bh", " #", " p", "ch", " =", " 13", "69", " PA", "BSD", " p", "ch", " emit", "(", "13", "69", ",", " pal", ",", " pal", ")", " emit", "(", "13", "69", ",", " p", "bl", ",", " p", "bl", ")", " emit", "(", "13", "69", ",", " p", "cl", ",", " p", "cl", ")", " emit", "(", "13", "69", ",", " p", "ah", ",", " p", "ah", ")", " emit", "(", "13", "69", ",", " p", "bh", ",", " p", "bh", ")", " emit", "(", "13", "69", ",", " p", "ch", ",", " p", "ch", ")", " #", " We", " would", " need", " at", " least", " 4", " registers", " more", ",", " so", " #", " we", " need", " to", " figure", " out", " which", " ones", " we", " can", " reuse", ".", " c", "1", "l", " =", " x", "mm", "13", " c", "1", "h", " =", " x", "mm", "14", " c", "2", "l", " =", " x", "mm", "15", " #", " If", " we", " do", " some", " re", "ordering", " here", ",", " we", " can", " #", " reuse", " pal", " #", " c", "1", "l", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "bl", " pal", " #", " c", "1", "h", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "bh", " p", "ah", " #", " c", "2", "l", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "cl", " pal", " #", " c", "2", "h", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "ch", " p", "ah", " emit", "(", "11", "64", ",", " c", "1", "l", ",", " p", "bl", ")", " emit", "(", "14", "72", ",", " c", "1", "l", ",", " pal", ")", " emit", "(", "11", "64", ",", " c", "2", "l", ",", " p", "cl", ")", " emit", "(", "14", "72", ",", " c", "2", "l", ",", " pal", ")", " c", "2", "h", " =", " pal", " emit", "(", "11", "64", ",", " c", "2", "h", ",", " p", "ch", ")", " emit", "(", "14", "72", ",", " c", "2", "h", ",", " p", "ah", ")", " emit", "(", "11", "64", ",", " c", "1", "h", ",", " p", "bh", ")", " emit", "(", "14", "72", ",", " c", "1", "h", ",", " p", "ah", ")", " #", " c", "4", "l", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "cl", " p", "bl", " #", " c", "4", "h", " =", " 14", "72", " PC", "M", "PG", "TD", " p", "ch", " p", "bh", " #", " We", " can", " reuse", " p", "cl", "/", "p", "ch", " for", " c", "4", "l", ",", " c", "4", "h", " c", "4", "l", " =", " p", "cl", " #", " emit", "(", "11", "64", ",", " c", "4", "l", ",", " p", "cl", ")", " c", "4", "h", " =", " p", "ch", " #", " emit", "(", "11", "64", ",", " c", "4", "h", ",", " p", "ch", ")", " emit", "(", "14", "72", ",", " c", "4", "l", ",", " p", "bl", ")", " emit", "(", "14", "72", ",", " c", "4", "h", ",", " p", "bh", ")", " #", " c", "3", "l", " =", " 14", "27", " P", "AND", " c", "1", "l", " c", "2", "l", " #", " c", "3", "h", " =", " 14", "27", " P", "AND", " c", "1", "h", " c", "2", "h", " #", " We", " can", " reuse", " c", "1", "*", " for", " c", "3", "*", " c", "3", "l", " =", " c", "1", "l", " c", "3", "h", " =", " c", "1", "h", " emit", "(", "14", "27", ",", " c", "3", "l", ",", " c", "2", "l", ")", " emit", "(", "14", "27", ",", " c", "3", "h", ",", " c", "2", "h", ")", " #", " bl", " =", " 14", "27", " P", "AND", " bl", " c", "4", "l", " #", " b", "h", " =", " 14", "27", " P", "AND", " b", "h", " c", "4", "h", " emit", "(", "14", "27", ",", " bl", ",", " c", "4", "l", ")", " emit", "(", "14", "27", ",", " b", "h", ",", " c", "4", "h", ")", " #", " cl", " =", " 14", "31", " P", "AND", "N", " cl", ",", " c", "4", "l", " #", " ch", " =", " 14", "31", " P", "AND", "N", " ch", ",", " c", "4", "h", " emit", "(", "14", "31", ",", " cl", ",", " c", "4", "l", ")", " emit", "(", "14", "31", ",", " ch", ",", " c", "4", "h", ")", " #", " bl", " =", " 16", "50", " P", "OR", " bl", ",", " cl", " #", " b", "h", " =", " 16", "50", " P", "OR", " b", "h", ",", " ch", " emit", "(", "16", "50", ",", " bl", ",", " cl", ")", " emit", "(", "16", "50", ",", " b", "h", ",", " ch", ")", " #", " al", " =", " 14", "27", " P", "AND", " al", ",", " c", "3", "l", " #", " ah", " =", " 14", "27", " P", "AND", " ah", ",", " c", "3", "h", " emit", "(", "14", "27", ",", " al", ",", " c", "3", "l", ")", " emit", "(", "14", "27", ",", " ah", ",", " c", "3", "h", ")", " #", " bl", " =", " 14", "31", " P", "AND", "N", " bl", ",", " c", "3", "l", " #", " b", "h", " =", " 14", "31", " P", "AND", "N", " b", "h", ",", " c", "3", "h", " emit", "(", "14", "31", ",", " bl", ",", " c", "3", "l", ")", " emit", "(", "14", "31", ",", " b", "h", ",", " c", "3", "h", ")", " #", " al", " =", " 16", "50", " P", "OR", " al", ",", " bl", " #", " ah", " =", " 16", "50", " P", "OR", " ah", ",", " b", "h", " emit", "(", "16", "50", ",", " al", ",", " bl", ")", " emit", "(", "16", "50", ",", " ah", ",", " b", "h", ")", " #", " delta", " =", " 13", "87", " PACK", "US", "WB", " al", ",", " ah", " delta", " =", " al", " emit", "(", "13", "87", ",", " delta", ",", " ah", ")", " #", " result", " +=", " 13", "91", " P", "AD", "DB", " delta", " emit", "(", "13", "91", ",", " result", ",", " delta", ")", " #", " 11", "68", " MOV", "D", "QU", " [", "scan", "line", " +", " i", "],", " result", " emit", "(", "11", "67", ",", " scan", "line", "_", "addr", ",", " result", ")", " return", " result", "\n", "\n", "The", " dump", " of", " the", " above", " program", " is", " 288", " bytes", " long", ".", " A", " quick", " look", " with", " n", "dis", "asm", " revealed", " that", " the", " assemb", "ler", " works", ".", " Now", " we", " have", " to", " install", " the", " above", " thing", " into", " a", " loop", " to", " have", " it", " run", ".", " We", " can", " reuse", " most", " of", " our", " old", " loop", ":", "\n", "\n", "as", "semble", " =", " (", "):", " #", " 18", "11", " P", "USH", " r", "64", " [", "64", "]", " Push", " r", "64", ".", " #", " we", " no", " longer", " cl", "ob", "ber", " any", " registers", " we", " should", " save", ".", " #", " i", " =", " 0", ".", "r", "0", " #", " 59", "73", " X", "OR", " m", "64", " r", "64", " [", "64", "]", " r", "/", "m", "64", " X", "OR", " r", "64", ".", " emit", "(", "59", "73", ",", " Register", "(", "i", "64", ",", " 0", "),", " Register", "(", "i", "64", ",", " 0", "))", " #", " j", " =", " offset", ".", "arg", "_", "4", "(", "8", ")", " #", " 12", "89", " N", "EG", " r", "64", " [", "64", "]", " Two", "'s", " complement", " negate", " r", "/", "m", "64", ".", " #", " 74", " ADD", " r", "64", " r", "64", " [", "64", "]", " Add", " r", "64", " to", " r", "/", "m", "64", ".", " #", " k", " =", " j", " -", " stride", ".", "r", "1", " emit", "(", "12", "89", ",", " Register", "(", "i", "64", ",", " 1", "))", " emit", "(", " 74", ",", " Register", "(", "i", "64", ",", " 1", "),", " Register", "(", "i", "64", ",", " 8", "))", " #", " loop", ":", " loop", "_", "label", " :=", " output", ".", "length", " #", " 04", "75", " C", "MP", " m", "64", " r", "64", " [", "64", "]", " Compare", " r", "64", " with", " r", "/", "m", "64", ".", " #", " if", " i", " >=", " length", " goto", " exit", " emit", "(", " 475", ",", " Register", "(", "i", "64", ",", " 0", "),", " arg", "_", "5", ")", " #", " 0", "86", "2", " J", "AE", " rel", "32", " [", "64", "]", " [", "L", "]", " Jump", " short", " if", " above", " or", " equal", " (", "CF", "=", "0", ").", " emit", "(", " 8", "62", ",", " Im", "mediate", "(", "i", "32", ",", " exit", "_", "label", " -", " ja", "_", "label", "))", " ja", "_", "label", " :=", " output", ".", "length", " sim", "d", "_", "pa", "eth", "_", "assembly", "(", "em", "it", ",", " Address", "(", "m", "128", ",", " 0", ",", " 2", ",", " 0", "),", " #", " input", " =", " [", "input", ".", "r", "2", " +", " i", ".", "r", "0", "]", " Address", "(", "m", "128", ",", " 0", ",", " 6", ",", " 1", "),", " #", " a", " =", " [", "scan", "line", ".", "r", "6", " +", " k", ".", "r", "1", "]", " Address", "(", "m", "128", ",", " 0", ",", " 7", ",", " 8", "),", " #", " b", " =", " [", "pri", "or", ".", "r", "7", " +", " j", ".", "r", "8", "]", " Address", "(", "m", "128", ",", " 0", ",", " 7", ",", " 1", "),", " #", " c", " =", " [", "pri", "or", ".", "r", "7", " +", " k", ".", "r", "1", "]", " Address", "(", "m", "128", ",", " 0", ",", " 6", ",", " 8", "))", " #", " output", " =", " [", "scan", "line", ".", "r", "6", " +", " j", ".", "r", "8", "]", " #", " i", ",", " j", ",", " k", " +=", " 16", " emit", "(", " 72", ",", " Register", "(", "i", "64", ",", " 0", "),", " Im", "mediate", "(", "i", "8", ",", " 16", "))", " emit", "(", " 72", ",", " Register", "(", "i", "64", ",", " 8", "),", " Im", "mediate", "(", "i", "8", ",", " 16", "))", " emit", "(", " 72", ",", " Register", "(", "i", "64", ",", " 1", "),", " Im", "mediate", "(", "i", "8", ",", " 16", "))", " #", " jump", " loop", " #", " 0", "886", " J", "MP", " rel", "32", " [", "64", "]", " [", "L", "]", " Jump", " short", ",", " RIP", " =", " RIP", " +", " 8", "-", "bit", " displacement", " sign", " extended", " to", " 64", "-", "bits", " emit", "(", " 8", "86", ",", " Im", "mediate", "(", "i", "32", ",", " loop", "_", "label", " -", " exit", "_", "label", "))", " #", " exit", ":", " exit", "_", "label", " :=", " output", ".", "length", " #", " return", " emit", "(", "19", "01", ")", " #", " RET", " NE", "AR", "\n", "\n", "Now", ",", " unlike", " the", " original", " assembly", " program", ",", " we", " can", "'t", " use", " this", " new", " implementation", " in", " isolation", " because", " it", " only", " runs", " through", " 16", "-", "byte", " chunks", " at", " a", " time", ".", "\n", "\n", "We", " can", "'t", " use", " this", " new", " implementation", " just", " as", " it", " because", " it", " churn", "s", " through", " 16", "-", "byte", " chunks", " in", " one", " swoop", ".", " Therefore", " we", " need", " the", " J", "IT", " version", " to", " meet", " up", " the", " beginning", " and", " end", ",", " so", " these", " two", " have", " to", " be", " combined", ":", "\n", "\n", "make", "_", "new", "_", "filter", " =", " (", "optim", "ized", ",", " ordinary", "):", " return", " (", "pri", "or", ",", " scan", "line", ",", " input", ",", " stride", ",", " offset", ",", " length", "):", " #", " max", "(", "0", ",", " offset", " -", " stride", ")", " +", " 16", " must", " be", " filled", ".", " fast", "_", "offset", " =", " max", "(", "max", "(", "0", ",", " offset", "-", "str", "ide", ")", " +", " 16", ",", " offset", ")", " fast", "_", "index", " =", " fast", "_", "offset", " -", " offset", " remain", "_", "length", " =", " length", " -", " fast", "_", "index", " last", "_", "length", " =", " remain", "_", "length", " &", " 16", " fast", "_", "length", " =", " remain", "_", "length", " -", " last", "_", "length", " last", "_", "index", " =", " length", " -", " last", "_", "length", " last", "_", "offset", " =", " offset", " +", " last", "_", "index", " ordinary", "(", "pri", "or", ",", " scan", "line", ",", " input", ",", " stride", ",", " offset", ",", " fast", "_", "index", ")", " optimized", "(", "pri", "or", ",", " scan", "line", ",", " input", "[", "fast", "_", "index", ".", ":", "],", " stride", ",", " fast", "_", "offset", ",", " fast", "_", "length", ")", " ordinary", "(", "pri", "or", ",", " scan", "line", ",", " input", "[", "last", "_", "index", ".", ":", "],", " stride", ",", " last", "_", "offset", ",", " last", "_", "length", ")", "\n", "\n", "That", " was", " already", " a", " bit", " tricky", " to", " write", ".", "\n", "\n", "Debug", "ging", "\n", "\n", "When", " we", " run", " the", " code", " we", " notice", " it", " produces", " a", " wrong", " output", ".", " Here", "'s", " the", " first", " two", " scan", "lines", " of", " the", " J", "IT", "-", "only", " version", ":", "\n", "\n", "7", "f", " 83", " 82", " ff", " 7", "c", " 80", " 7", "f", " ff", " 7", "f", " 83", " 82", " ff", " 7", "b", " 7", "f", " 7", "e", " ff", "...", " 48", " 52", " 2", "f", " ff", " 4", "f", " 59", " 36", " ff", " 50", " 5", "a", " 37", " ff", " 4", "e", " 58", " 35", " ff", " 7", "e", " 82", " 81", " ff", " 7", "b", " 7", "f", " 7", "e", " ff", " 7", "e", " 82", " 81", " ff", " 7", "a", " 7", "e", " 7", "d", " ff", "...", " 50", " 5", "a", " 37", " ff", " 57", " 61", " 3", "e", " ff", " 57", " 61", " 3", "e", " ff", " 52", " 5", "c", " 39", " ff", "\n", "\n", "And", " here", "'s", " our", " J", "IT", "+", "SIM", "D", " version", ":", "\n", "\n", "7", "f", " 83", " 82", " ff", " 7", "c", " 80", " 7", "f", " ff", " 7", "f", " 83", " 82", " ff", " 7", "b", " 7", "f", " 7", "e", " ff", "...", " 48", " 52", " 2", "f", " ff", " 4", "f", " 59", " 36", " ff", " 50", " 5", "a", " 37", " ff", " 4", "e", " 58", " 35", " ff", " 7", "e", " 82", " 81", " ff", " 7", "b", " 7", "f", " 7", "e", " ff", " 7", "e", " 82", " 81", " ff", " 7", "a", " 7", "e", " 7", "d", " ff", "...", " 07", " 07", " 07", " 00", " 0", "e", " 0", "e", " 0", "e", " 00", " 0", "e", " 0", "e", " 0", "e", " 00", " 09", " 09", " 09", " 00", "\n", "\n", "It", " looks", " a", " lot", " like", " we", " would", " have", " something", " in", " our", " pa", "eth", ".", " The", " first", " line", " looks", " okay", ",", " but", " actually", " it", "'s", " running", " a", " different", " filter", " there", ".", " Our", " filter", " runs", " on", " the", " second", " row", ".", " Fortunately", " we", " can", " define", " a", " software", " break", "point", ".", "\n", "\n", "#", " 8", "52", " INT", " 3", " [", "64", "]", " [", "L", "]", " Inter", "rupt", " 3", "-", "trap", " to", " debugger", ".", " emit", "(", " 8", "52", ",", " null", ")", "\n", "\n", "But", " maybe", " I", " haste", " here", " because", " my", " display", " shows", " only", " 16", " bytes", " from", " the", " beginning", " and", " the", " end", "!", " This", " means", " that", " on", " the", " left", " side", " our", " optimized", " program", " hasn", "'t", " been", " running", " at", " all", ".", "\n", "\n", "So", " our", " filter", " is", " supposed", " to", " fill", " the", " first", " 16", " bytes", " so", " that", " the", " actual", " program", " can", " start", " there", " like", " this", ":", "\n", "\n", "pre", "-", "fill", ":", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " scan", "line", "+", "k", ":", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " scan", "line", "+", "j", ":", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", "\n", "\n", "But", " then", " we", " actually", " start", " the", " optimized", " routine", " like", " this", ":", "\n", "\n", "pre", "-", "fill", ":", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " AA", " scan", "line", "+", "k", ":", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " scan", "line", "+", "j", ":", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", " 00", "\n", "\n", "O", "ops", ".", " Here", "'s", " the", " fixed", " version", ".", "\n", "\n", "make", "_", "new", "_", "filter", " =", " (", "optim", "ized", ",", " ordinary", "):", " return", " (", "pri", "or", ",", " scan", "line", ",", " input", ",", " stride", ",", " offset", ",", " length", "):", " if", " length", " <", " 32", " #", " if", " it", "'s", " so", " small", " chunk", " that", " our", " thing", " breaks", " return", " ordinary", "(", "pri", "or", ",", " scan", "line", ",", " input", ",", " stride", ",", " offset", ",", " length", ")", " #", " max", "(", "0", ",", " offset", " -", " stride", ")", " +", " 16", " must", " be", " filled", ".", " fill", "_", "offset", " =", " max", "(", "max", "(", "0", ",", " offset", "-", "str", "ide", ")", " +", " 16", ",", " offset", ")", " fast", "_", "offset", " =", " max", "(", "offset", ",", " stride", ")", " fast", "_", "index", " =", " fast", "_", "offset", " -", " offset", " remain", "_", "length", " =", " length", " -", " fast", "_", "index", " last", "_", "length", " =", " remain", "_", "length", " &", " 15", " fast", "_", "length", " =", " remain", "_", "length", " -", " last", "_", "length", " last", "_", "index", " =", " length", " -", " last", "_", "length", " last", "_", "offset", " =", " offset", " +", " last", "_", "index", " ordinary", "(", "pri", "or", ",", " scan", "line", ",", " input", ",", " stride", ",", " offset", ",", " fill", "_", "offset", " -", " offset", ")", " optimized", "(", "pri", "or", ",", " scan", "line", ",", " input", "[", "fast", "_", "index", ".", ":", "],", " stride", ",", " fast", "_", "offset", ",", " fast", "_", "length", ")", " ordinary", "(", "pri", "or", ",", " scan", "line", ",", " input", "[", "last", "_", "index", ".", ":", "],", " stride", ",", " last", "_", "offset", ",", " last", "_", "length", ")", "\n", "\n", "It", " still", " gives", " the", " wrong", " results", " but", " they", " are", " more", " apparent", " now", ".", " Next", " we", " use", " that", " trap", " instruction", " I", " shown", " and", " run", " the", " following", " in", " the", " G", "DB", ":", "\n", "\n", "display", " /", "x", " $", "x", "mm", "0", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "1", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "2", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "3", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "4", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "5", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "6", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "7", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "8", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "8", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "9", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "10", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "11", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "12", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "13", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "14", ".", "uint", "128", " display", " /", "x", " $", "x", "mm", "15", ".", "uint", "128", " layout", " as", "m", "\n", "\n", "After", " the", " MOV", "D", "QU", " instructions", " the", " x", "mm", "0", "-", "x", "mm", "3", " looks", " like", " this", ".", "\n", "\n", "1", ":", " /", "x", " $", "x", "mm", "0", ".", "uint", "128", " =", " 0", "x", "00", "f", "ef", "efe", "00", "ffff", "ff", "00", "ffff", "ff", "00", "ffff", "ff", " 2", ":", " /", "x", " $", "x", "mm", "1", ".", "uint", "128", " =", " 0", "xff", "7", "d", "7", "e", "7", "aff", "8", "18", "27", "eff", "7", "e", "7", "f", "7", "b", "ff", "8", "18", "27", "e", " 3", ":", " /", "x", " $", "x", "mm", "2", ".", "uint", "128", " =", " 0", "xff", "7", "d", "7", "e", "7", "aff", "7", "e", "7", "f", "7", "b", "ff", "8", "28", "37", "fff", "7", "f", "807", "c", " 4", ":", " /", "x", " $", "x", "mm", "3", ".", "uint", "128", " =", " 0", "xff", "7", "e", "7", "f", "7", "b", "ff", "8", "28", "37", "fff", "7", "f", "807", "c", "ff", "8", "28", "37", "f", "\n", "\n", "The", " x", "mm", "0", " looks", " very", " familiar", ".", " I", " think", " it", "'ll", " be", " apparent", " very", " soon", " why", " this", " code", " produces", " the", " wrong", " results", ".", "\n", "\n", "After", " the", " pun", "p", "ck", "{", "lb", "w", ",", "h", "b", "w", "}", " have", " run", ",", " the", " register", " dump", " looks", " like", " the", " following", ":", "\n", "\n", "1", ":", " /", "x", " $", "x", "mm", "0", ".", "uint", "128", " =", " 0", "x", "00", "f", "ef", "efe", "00", "ffff", "ff", "00", "ffff", "ff", "00", "ffff", "ff", " 2", ":", " /", "x", " $", "x", "mm", "1", ".", "uint", "128", " =", " 0", "x", "ffff", "7", "e", "7", "e", "7", "f", "7", "f", "7", "b", "7", "b", "ffff", "8", "18", "18", "28", "27", "e", "7", "e", " 3", ":", " /", "x", " $", "x", "mm", "2", ".", "uint", "128", " =", " 0", "x", "ffff", "8", "28", "28", "38", "37", "f", "7", "ffff", "f", "7", "f", "7", "f", "80", "807", "c", "7", "c", " 4", ":", " /", "x", " $", "x", "mm", "3", ".", "uint", "128", " =", " 0", "x", "ffff", "7", "f", "7", "f", "80", "807", "c", "7", "cffff", "8", "28", "28", "38", "37", "f", "7", "f", " 5", ":", " /", "x", " $", "x", "mm", "4", ".", "uint", "128", " =", " 0", "xff", "007", "d", "007", "e", "007", "a", "00", "ff", "008", "100", "8", "2007", "e", "00", " 6", ":", " /", "x", " $", "x", "mm", "5", ".", "uint", "128", " =", " 0", "xff", "007", "d", "007", "e", "007", "a", "00", "ff", "007", "e", "007", "f", "007", "b", "00", " 7", ":", " /", "x", " $", "x", "mm", "6", ".", "uint", "128", " =", " 0", "xff", "007", "e", "007", "f", "007", "b", "00", "ff", "008", "200", "83", "007", "f", "00", "\n", "\n", "It", " is", " suddenly", " painfully", " apparent", " that", " the", " destination", " and", " source", " register", " in", " the", " un", "pack", " operation", " cannot", " be", " the", " same", ".", " So", " we", " have", " to", " fix", " those", " lines", " like", " this", ":", "\n", "\n", "#", " ah", " =", " 18", "17", " P", "X", "OR", " ah", " #", " b", "h", " =", " 18", "17", " P", "X", "OR", " b", "h", " #", " ch", " =", " 18", "17", " P", "X", "OR", " ch", " #", " al", " =", " 18", "17", " P", "X", "OR", " al", " #", " bl", " =", " 18", "17", " P", "X", "OR", " bl", " #", " cl", " =", " 18", "17", " P", "X", "OR", " cl", " emit", "(", "18", "17", ",", " al", ",", " al", ")", " emit", "(", "18", "17", ",", " bl", ",", " bl", ")", " emit", "(", "18", "17", ",", " cl", ",", " cl", ")", " emit", "(", "18", "17", ",", " ah", ",", " ah", ")", " emit", "(", "18", "17", ",", " b", "h", ",", " b", "h", ")", " emit", "(", "18", "17", ",", " ch", ",", " ch", ")", " #", " ah", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " a", " #", " b", "h", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " b", " #", " ch", " =", " 17", "72", " P", "UN", "PC", "K", "HB", "W", " c", " emit", "(", "17", "72", ",", " ah", ",", " pal", ")", " emit", "(", "17", "72", ",", " b", "h", ",", " p", "bl", ")", " emit", "(", "17", "72", ",", " ch", ",", " p", "cl", ")", " #", " al", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " a", " #", " bl", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " b", " #", " cl", " =", " 17", "86", " P", "UN", "PC", "K", "LB", "W", " c", " emit", "(", "17", "86", ",", " al", ",", " pal", ")", " emit", "(", "17", "86", ",", " bl", ",", " p", "bl", ")", " emit", "(", "17", "86", ",", " cl", ",", " p", "cl", ")", "\n", "\n", "Another", " iteration", " of", " the", " first", " entry", " with", " a", " debugger", " reveals", " that", " we", " calculate", " a", " +", " b", " -", " a", " rather", " than", " a", " +", " b", " -", " c", " like", " we", " should", ".", " This", " fixes", " that", ":", "\n", "\n", "#", " pal", " -=", " 17", "42", " PS", "UB", "D", " cl", " #", " p", "ah", " -=", " 17", "42", " PS", "UB", "D", " ch", " emit", "(", "17", "42", ",", " pal", ",", " cl", ")", " emit", "(", "17", "42", ",", " p", "ah", ",", " ch", ")", "\n", "\n", "It", " seems", " that", " at", " the", " end", " we", " end", " up", " adding", " with", " zero", ",", " so", " that", " we", " are", " actually", " doing", " nothing", " in", " this", " program", ".", " The", " only", " reasonable", " explanation", " here", " is", " that", " we", " mess", " up", " the", " condition", "als", " somehow", ".", "\n", "\n", "After", " the", " end", " of", " the", " conditional", " block", ",", " the", " result", " looks", " like", " this", ":", "\n", "\n", "1", ":", " /", "x", " $", "x", "mm", "0", ".", "uint", "128", " =", " 0", "x", "00", "f", "ef", "efe", "00", "ffff", "ff", "00", "ffff", "ff", "00", "ffff", "ff", " (", "result", ")", " 2", ":", " /", "x", " $", "x", "mm", "1", ".", "uint", "128", " =", " 0", "xff", "007", "e", "007", "f", "007", "b", "00", "ff", "008", "100", "8", "2007", "e", "00", " (", "al", ")", " 3", ":", " /", "x", " $", "x", "mm", "2", ".", "uint", "128", " =", " 0", "xff", "008", "200", "83", "007", "f", "00", "ff", "007", "f", "008", "000", "7", "c", "00", " (", "bl", ")", " 4", ":", " /", "x", " $", "x", "mm", "3", ".", "uint", "128", " =", " 0", "xff", "007", "f", "008", "000", "7", "c", "00", "ff", "008", "200", "83", "007", "f", "00", " (", "cl", ")", " 5", ":", " /", "x", " $", "x", "mm", "4", ".", "uint", "128", " =", " 0", "xff", "007", "d", "007", "e", "007", "a", "00", "ff", "008", "100", "8", "2007", "e", "00", " (", "ah", ")", " 6", ":", " /", "x", " $", "x", "mm", "5", ".", "uint", "128", " =", " 0", "xff", "007", "d", "007", "e", "007", "a", "00", "ff", "007", "e", "007", "f", "007", "b", "00", " (", "bh", ")", " 7", ":", " /", "x", " $", "x", "mm", "6", ".", "uint", "128", " =", " 0", "xff", "007", "e", "007", "f", "007", "b", "00", "ff", "008", "200", "83", "007", "f", "00", " (", "ch", ")", " 8", ":", " /", "x", " $", "x", "mm", "7", ".", "uint", "128", " =", " 0", "x", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", " (", "c", "2", "h", ")", " 10", ":", " /", "x", " $", "x", "mm", "8", ".", "uint", "128", " =", " 0", "x", "0000", "01", "0001", "0001", "000000", "01", "0001", "0001", "00", " (", "p", "bl", ")", " 11", ":", " /", "x", " $", "x", "mm", "9", ".", "uint", "128", " =", " 0", "x", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", " (", "c", "4", "l", ")", " 12", ":", " /", "x", " $", "x", "mm", "10", ".", "uint", "128", " =", " 0", "x", "0000", "01", "0001", "0001", "0000000", "4000", "4000", "400", " (", "p", "ah", ")", " 13", ":", " /", "x", " $", "x", "mm", "11", ".", "uint", "128", " =", " 0", "x", "0000", "01", "0001", "0001", "000000", "01", "0001", "0001", "00", " (", "p", "bh", ")", " 14", ":", " /", "x", " $", "x", "mm", "12", ".", "uint", "128", " =", " 0", "x", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", " (", "c", "4", "h", ")", " 15", ":", " /", "x", " $", "x", "mm", "13", ".", "uint", "128", " =", " 0", "x", "0000000000000000", "0000000000000000", " (", "c", "3", "l", ")", " 16", ":", " /", "x", " $", "x", "mm", "14", ".", "uint", "128", " =", " 0", "x", "0000000000000000", "0000000000000000", " (", "c", "3", "h", ")", " 17", ":", " /", "x", " $", "x", "mm", "15", ".", "uint", "128", " =", " 0", "x", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", "ffff", " (", "c", "2", "l", ")", "\n", "\n", "The", " labels", " reveal", " that", " we", " have", " the", " following", " state", ":", "\n", "\n", "al", ",", " bl", ",", " cl", ",", " ah", ",", " b", "h", ",", " ch", " c", "3", " =", " false", " c", "4", " =", " true", "\n", "\n", "This", " should", " mean", " that", " the", " result", " b", " is", " selected", ".", " The", " following", " instructions", " should", " correctly", " preserve", " the", " result", ".", "\n", "\n", "#", " bl", " =", " 14", "27", " P", "AND", " bl", " c", "4", "l", " #", " b", "h", " =", " 14", "27", " P", "AND", " b", "h", " c", "4", "h", " emit", "(", "14", "27", ",", " bl", ",", " c", "4", "l", ")", " emit", "(", "14", "27", ",", " b", "h", ",", " c", "4", "h", ")", "\n", "\n", "They", " did", " so", ".", " Respect", "ively", " these", " next", " ones", " should", " zero", " the", " cl", " and", " ch", ".", "\n", "\n", "#", " cl", " =", " 14", "31", " P", "AND", "N", " cl", ",", " c", "4", "l", " #", " ch", " =", " 14", "31", " P", "AND", "N", " ch", ",", " c", "4", "h", " emit", "(", "14", "31", ",", " cl", ",", " c", "4", "l", ")", " emit", "(", "14", "31", ",", " ch", ",", " c", "4", "h", ")", "\n", "\n", "I", " think", " I", " messed", " up", " something", " again", "..", " Reading", " out", " on", " this", " reveals", " that", " the", " P", "AND", "N", " in", "verts", " the", " destination", " and", " then", " does", " AND", ".", " It", "'s", " not", " exactly", " what", " we", " expected", ".", " We", " have", " to", " flip", " them", " over", " and", " merge", " with", " the", " c", "3", " and", " c", "4", ".", "\n", "\n", "The", " result", " is", " still", " completely", " wrong", ":", "\n", "\n", "7", "f", " 83", " 82", " ff", " 7", "c", " 80", " 7", "f", " ff", " 7", "f", " 83", " 82", " ff", " 7", "b", " 7", "f", " 7", "e", " ff", "...", " 48", " 52", " 2", "f", " ff", " 4", "f", " 59", " 36", " ff", " 50", " 5", "a", " 37", " ff", " 4", "e", " 58", " 35", " ff", " 7", "e", " 82", " 81", " ff", " fe", " ff", " fe", " 00", " fe", " ff", " ff", " 00", " fe", " fe", " fe", " 00", "...", " 06", " 06", " 06", " 00", " 0", "d", " 0", "d", " 0", "d", " 00", " 0", "d", " 0", "d", " 0", "d", " 00", " 08", " 08", " 08", " 00", "\n", "\n", "One", " of", " the", " culprit", "s", " could", " be", " the", " PC", "M", "PG", "TD", ".", " We", " use", " it", " like", " this", ":", "\n", "\n", "c", "1", " =", " PC", "M", "PG", "TD", " p", "b", " pa", "\n", "\n", "If", " this", " actually", " means", " '", "great", "er", " than", "',", " then", " the", " code", " is", ":", "\n", "\n", "c", "1", " =", " p", "b", " >", " pa", "\n", "\n", "And", " the", " condition", " was", ":", "\n", "\n", "if", " pa", " <=", " p", "b", " and", " pa", " <=", " pc", " return", " a", " el", "if", " p", "b", " <=", " pc", " return", " b", " else", " return", " c", "\n", "\n", "So", " there", " we", " have", " our", " problem", ".", " I", " had", " to", " think", " about", " this", " a", " bit", " and", " transform", " it", " into", " the", " correct", " form", ".", "\n", "\n", "if", " not", " (", "pa", " >", " p", "b", " or", " pa", " >", " pc", ")", " return", " a", " el", "if", " not", " p", "b", " >", " pc", " return", " b", " else", " return", " c", "\n", "\n", "Even", " then", " the", " code", " is", " not", " correct", " yet", ".", " Let", "'s", " look", " at", " the", " input", " next", ".", " It", " looks", " weird", " because", " it", "'s", " upside", " down", ".", " Let", "'s", " label", " them", " and", " compare", " them", " with", " what", " we", " know", ".", "\n", "\n", "input", ":", " /", "x", " $", "x", "mm", "0", ".", "uint", "128", " =", " 0", "x", " 00", " fe", " fe", " fe", " 00", " ff", " ff", " ff", " 00", " ff", " ff", " ff", " 00", " ff", " ff", " ff", " a", ":", " /", "x", " $", "x", "mm", "7", ".", "uint", "128", " =", " 0", "x", " ff", " 7", "d", " 7", "e", " 7", "a", " ff", " 81", " 82", " 7", "e", " ff", " 7", "e", " 7", "f", " 7", "b", " ff", " 81", " 82", " 7", "e", " b", ":", " /", "x", " $", "x", "mm", "8", ".", "uint", "128", " =", " 0", "x", " ff", " 7", "d", " 7", "e", " 7", "a", " ff", " 7", "e", " 7", "f", " 7", "b", " ff", " 82", " 83", " 7", "f", " ff", " 7", "f", " 80", " 7", "c", " c", ":", " /", "x", " $", "x", "mm", "9", ".", "uint", "128", " =", " 0", "x", " ff", " 7", "e", " 7", "f", " 7", "b", " ff", " 82", " 83", " 7", "f", " ff", " 7", "f", " 80", " 7", "c", " ff", " 82", " 83", " 7", "f", " prior", ":", " 7", "f", " 83", " 82", " ff", " 7", "c", " 80", " 7", "f", " ff", " 7", "f", " 83", " 82", " ff", " 7", "b", " 7", "f", " 7", "e", " ff", "...", " 48", " 52", " 2", "f", " ff", " 4", "f", " 59", " 36", " ff", " 50", " 5", "a", " 37", " ff", " 4", "e", " 58", " 35", " ff", " scan", "line", ":", " 7", "e", " 82", " 81", " ff", " 7", "b", " 7", "f", " 7", "e", " ff", " 7", "e", " 82", " 81", " ff", " 7", "a", " 7", "e", " 7", "d", " ff", "...", " 50", " 5", "a", " 37", " ff", " 57", " 61", " 3", "e", " ff", " 57", " 61", " 3", "e", " ff", " 52", " 5", "c", " 39", " ff", "\n", "\n", "This", " is", " precise", ".", " Next", " the", " data", " is", " packed", " into", " the", " 6", " registers", ".", " We", " see", " them", " being", " cleaned", ":", "\n", "\n", "al", ":", " /", "x", " $", "x", "mm", "1", ".", "uint", "128", " =", " 0", "x", "0000000000000000", "0000000000000000", " bl", ":", " /", "x", " $", "x", "mm", "2", ".", "uint", "128", " =", " 0", "x", "0000000000000000", "0000000000000000", " cl", ":", " /", "x", " $", "x", "mm", "3", ".", "uint", "128", " =", " 0", "x", "0000000000000000", "0000000000000000", " ah", ":", " /", "x", " $", "x", "mm", "4", ".", "uint", "128", " =", " 0", "x", "0000000000000000", "0000000000000000", " b", "h", ":", " /", "x", " $", "x", "mm", "5", ".", "uint", "128", " =", " 0", "x", "0000000000000000", "0000000000000000", " ch", ":", " /", "x", " $", "x", "mm", "6", ".", "uint", "128", " =", " 0", "x", "0000000000000000", "0000000000000000", "\n", "\n", "Then", " they", " get", " filled", " up", " with", " data", ":", "\n", "\n", "al", ":", " /", "x", " $", "x", "mm", "1", ".", "uint", "128", " =", " 0", "xff", "00", " 7", "e", "00", " 7", "f", "00", " 7", "b", "00", " ff", "00", " 8", "100", " 8", "200", " 7", "e", "00", " bl", ":", " /", "x", " $", "x", "mm", "2", ".", "uint", "128", " =", " 0", "xff", "00", " 8", "200", " 8", "300", " 7", "f", "00", " ff", "00", " 7", "f", "00", " 8000", " 7", "c", "00", " cl", ":", " /", "x", " $", "x", "mm", "3", ".", "uint", "128", " =", " 0", "xff", "00", " 7", "f", "00", " 8000", " 7", "c", "00", " ff", "00", " 8", "200", " 8", "300", " 7", "f", "00", " ah", ":", " /", "x", " $", "x", "mm", "4", ".", "uint", "128", " =", " 0", "xff", "00", " 7", "d", "00", " 7", "e", "00", " 7", "a", "00", " ff", "00", " 8", "100", " 8", "200", " 7", "e", "00", " b", "h", ":", " /", "x", " $", "x", "mm", "5", ".", "uint", "128", " =", " 0", "xff", "00", " 7", "d", "00", " 7", "e", "00", " 7", "a", "00", " ff", "00", " 7", "e", "00", " 7", "f", "00", " 7", "b", "00", " ch", ":", " /", "x", " $", "x", "mm", "6", ".", "uint", "128", " =", " 0", "xff", "00", " 7", "e", "00", " 7", "f", "00", " 7", "b", "00", " ff", "00", " 8", "200", " 8", "300", " 7", "f", "00", "\n", "\n", "So", " the", " problem", " appears", " to", " be", " that", " we", " do", " the", " wrong", " kind", " of", " unp", "acking", " operation", " here", ".", " We", " can", " fix", " it", " with", " PS", "RL", "W", " which", " shifts", " bytes", " right", ".", "\n", "\n", "The", " beginning", " of", " the", " seq", "un", "ce", " started", " to", " look", " right", " at", " this", " point", ",", " but", " it", " got", " the", " rest", " wrong", ".", " I", " started", " to", " realise", " there", " is", " something", " fairly", " wrong", " here", ".", "\n", "\n", "Ok", ".", " So", " we", " fill", " our", " first", " run", " like", " this", ":", "\n", "\n", "7", "e", " 82", " 81", " ff", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "\n", "\n", "Then", " we", " jump", " ahead", " by", " 16", " bytes", " and", " we", " start", " reading", " the", " input", " from", " here", ":", "\n", "\n", "7", "e", " 82", " 81", " ff", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "..", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", " ^", "^", "\n", "\n", "You", " know", " what", "?", " At", " this", " point", " I", " realised", " I", " cannot", " do", " it", " this", " way", ".", " I", " can", " only", " compute", " contents", " on", " one", " pixel", " parallel", " using", " this", " parallel", "ization", " technique", ".", " And", " it", "'s", " messy", " considering", " what", " it", " does", ".", "\n", "\n", "I", " found", " yet", " some", " more", " things", " I", " did", " wrong", ",", " such", " as", " the", " use", " of", " double", " word", " operations", " when", " I", " should", " have", " used", " operations", " on", " words", ".", " After", " finding", " those", " I", " started", " getting", " results", " that", " started", " to", " seem", " plausible", " but", " compared", " to", " the", " correct", " output", " they", " were", " still", " incorrect", ".", "\n", "\n", "L", "ets", " leave", " it", " to", " the", " back", "burn", "er", "\n", "\n", "This", " was", " the", " first", " time", " when", " I", "'ve", " studied", " the", " SIM", "D", " instructions", " in", " detail", ".", " The", " outcome", " was", " a", " complete", " mess", " but", " I", " learned", " so", " much", " in", " the", " process", " that", " I", "'m", " not", " even", " frustrated", ".", "\n", "\n", "The", " techniques", " presented", " here", " obviously", " work", ",", " but", " I", " need", " to", " write", " a", " compiler", " to", " make", " the", " machine", " code", " solution", " more", " practical", " as", " a", " choice", "."]