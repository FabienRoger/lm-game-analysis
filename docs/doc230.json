["Have", " you", " seen", " the", " MJ", "IT", " benchmark", " results", "?", " Amazing", ",", " aren", "\ufffd", "\ufffd", "t", " they", "?", " MJ", "IT", " basically", " blows", " the", " other", " implementations", " out", " of", " the", " water", "!", " What", " were", " they", " doing", " all", " these", " years", "?", " That", "\ufffd", "\ufffd", "s", " it", ",", " we", "\ufffd", "\ufffd", "re", " done", " here", " right", "?", "\n", "\n", "Well", ",", " not", " so", " fast", " as", " you", " can", " infer", " from", " the", " title", ".", " But", " before", " we", " can", " get", " to", " what", " I", " take", " issue", " with", " in", " these", " particular", " benchmarks", " (", "you", " can", " of", " course", " jump", " ahead", " to", " the", " nice", " diagrams", ")", " we", " gotta", " get", " some", " introdu", "ctions", " and", " some", " important", " benchmark", "ing", " basics", " out", " of", " the", " way", ".", "\n", "\n", "MJ", "IT", "?", " Tru", "ff", "le", " Ruby", "?", " W", "TF", " is", " this", "?", "\n", "\n", "MJ", "IT", " currently", " is", " a", " branch", " of", " ruby", " on", " github", " by", " Vladimir", " Mak", "arov", ",", " GCC", " developer", ",", " that", " implements", " a", " J", "IT", " (", "Just", " In", " Time", " Comp", "ilation", ")", " on", " the", " most", " commonly", " used", " Ruby", " interpreter", "/", "CR", "ub", "y", ".", " It", "\ufffd", "\ufffd", "s", " by", " no", " means", " final", ",", " in", " fact", " it", "\ufffd", "\ufffd", "s", " in", " a", " very", " early", " stage", ".", " Very", " promising", " benchmark", "ing", " results", " were", " published", " on", " the", " 15", "th", " of", " June", " 2017", ",", " which", " are", " in", " major", " parts", " the", " subject", " of", " this", " blog", " post", ".", "\n", "\n", "T", "ruff", "le", "Ruby", " is", " an", " implementation", " of", " Ruby", " on", " the", " Gra", "al", "VM", " by", " Oracle", " Labs", ".", " It", " poses", " impressive", " performance", " numbers", " as", " you", " can", " see", " in", " my", " latest", " great", " \ufffd", "\ufffd", "Ruby", " plays", " Go", " Rumble", "\ufffd", "\ufffd", ".", " It", " also", " implements", " a", " J", "IT", ",", " is", " known", " to", " take", " a", " bit", " of", " a", " warm", "up", " but", " comes", " out", " being", " ~", "8", " times", " faster", " than", " Ruby", " 2", ".", "0", " in", " the", " previously", " mentioned", " benchmark", ".", "\n", "\n", "Before", " we", " go", " further", "\u2026", "\n", "\n", "I", " have", " enormous", " respect", " for", " Vladimir", " and", " think", " that", " MJ", "IT", " is", " an", " incredibly", " valuable", " project", ".", " Real", "istically", " it", " might", " be", " one", " of", " our", " few", " shots", " to", " get", " a", " J", "IT", " into", " mainstream", " ruby", ".", " J", "Ruby", " had", " a", " J", "IT", " and", " great", " performance", " for", " years", ",", " but", " never", " got", " picked", " up", " by", " the", " masses", " (", "topic", " for", " another", " day", ").", "\n", "\n", "I", "\ufffd", "\ufffd", "m", " gonna", " critique", " the", " way", " the", " benchmarks", " were", " done", ",", " but", " there", " might", " be", " reasons", " for", " that", ",", " that", " I", "\ufffd", "\ufffd", "m", " missing", " (", "g", "onna", " point", " out", " the", " ones", " I", " know", ").", " After", " all", ",", " Vladimir", " has", " been", " programming", " for", " way", " longer", " than", " I", "\ufffd", "\ufffd", "m", " even", " alive", " and", " also", " knows", " more", " about", " language", " implementations", " than", " I", " do", " obviously", ".", "\n", "\n", "Plus", ",", " to", " repeat", ",", " this", " is", " not", " about", " the", " person", " or", " the", " project", ",", " just", " the", " way", " we", " do", " benchmarks", ".", " Vladimir", ",", " in", " case", " you", " are", " reading", " this", " \ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\ufffd", "\n", "\n", "What", " are", " we", " measuring", "?", "\n", "\n", "When", " you", " see", " a", " benchmark", " in", " the", " wild", ",", " first", " you", " gotta", " ask", " \ufffd", "\ufffd", "What", " was", " measured", "?", "\ufffd", "\ufffd", " \u2013", " the", " what", " here", " comes", " in", " to", " flavors", ":", " code", " and", " time", ".", "\n", "\n", "What", " code", " are", " we", " benchmark", "ing", "?", "\n", "\n", "It", " is", " important", " to", " know", " what", " code", " is", " actually", " being", " benchmark", "ed", ",", " to", " see", " if", " that", " code", " is", " actually", " relevant", " to", " us", " or", " a", " good", " representation", " of", " a", " real", " life", " Ruby", " program", ".", " This", " is", " especially", " important", " if", " we", " want", " to", " use", " benchmarks", " as", " an", " indication", " of", " the", " performance", " of", " a", " particular", " ruby", " implementation", ".", "\n", "\n", "When", " you", " look", " at", " the", " list", " of", " benchmarks", " provided", " in", " the", " READ", "ME", " (", "and", " scroll", " up", " to", " the", " list", " what", " they", " mean", " or", " look", " at", " them", ")", " you", " can", " see", " that", " basically", " the", " top", " half", " are", " extremely", " micro", " benchmarks", ":", "\n", "\n", "What", "\ufffd", "\ufffd", "s", " benchmark", "ed", " here", " are", " writes", " to", " instance", " variables", ",", " reading", " constants", ",", " empty", " method", " calls", ",", " while", " loops", " and", " the", " like", ".", " This", " is", " extremely", " micro", ",", " maybe", " interesting", " from", " a", " language", " implement", "ors", " point", " of", " view", " but", " not", " very", " indicative", " of", " real", " world", " ruby", " performance", ".", " The", " day", " looking", " up", " a", " constant", " will", " be", " the", " performance", " bottle", " neck", " in", " Ruby", " will", " be", " a", " happy", " day", ".", " Also", ",", " how", " much", " of", " your", " code", " uses", " while", " loops", "?", "\n", "\n", "A", " lot", " of", " the", " code", " (", "om", "itting", " the", " super", " micro", " ones", ")", " there", " isn", "\ufffd", "\ufffd", "t", " exactly", " what", " I", "\ufffd", "\ufffd", "d", " call", " typical", " ruby", " code", ".", " A", " lot", " of", " it", " is", " more", " a", " mixture", " of", " a", " script", " and", " C", "-", "code", ".", " Lots", " of", " them", " don", "\ufffd", "\ufffd", "t", " define", " classes", ",", " use", " a", " lot", " of", " while", " and", " for", " loops", " instead", " of", " the", " more", " typical", " En", "umerable", " methods", " and", " sometimes", " there", "\ufffd", "\ufffd", "s", " even", " bit", "mas", "ks", ".", "\n", "\n", "Some", " of", " those", " constructs", " might", " have", " originated", " in", " optimizations", ",", " as", " they", " are", " apparently", " used", " in", " the", " general", " language", " benchmarks", ".", " That", "\ufffd", "\ufffd", "s", " dangerous", " as", " well", " though", ",", " mostly", " they", " are", " optimized", " for", " one", " specific", " platform", ",", " in", " this", " case", " CR", "ub", "y", ".", " What", "\ufffd", "\ufffd", "s", " the", " fastest", " Ruby", " code", " on", " one", " platform", " can", " be", " way", " slower", " on", " the", " other", " platforms", " as", " it", "\ufffd", "\ufffd", "s", " an", " implementation", " detail", " (", "for", " instance", " Tru", "ff", "le", "Ruby", " uses", " a", " different", " String", " implementation", ").", " This", " puts", " the", " other", " implementations", " at", " an", " inherent", " disadvantage", ".", "\n", "\n", "The", " problem", " here", " goes", " a", " bit", " deeper", ",", " whatever", " is", " in", " a", " popular", " benchmark", " will", " inevitably", " be", " what", " implementations", " optimize", " for", " and", " that", " should", " be", " as", " close", " to", " reality", " as", " possible", ".", " Hence", ",", " I", "\ufffd", "\ufffd", "m", " excited", " what", " benchmarks", " the", " Ruby", " 3", "\u00d7", "3", " project", " comes", " up", " with", " so", " that", " we", " have", " some", " new", " more", " relevant", " benchmarks", ".", "\n", "\n", "What", " time", " are", " we", " measuring", "?", "\n", "\n", "This", " is", " truly", " my", " favorite", " part", " of", " this", " blog", " post", " and", " arguably", " most", " important", ".", " For", " all", " that", " I", " know", " the", " time", " measurements", " in", " the", " original", " benchmarks", " were", " done", " like", " this", ":", " /", "usr", "/", "bin", "/", "time", " -", "v", " ruby", " $", "script", " which", " is", " one", " of", " my", " favorite", " benchmark", "ing", " mistakes", " for", " programming", " languages", " commonly", " used", " for", " web", " applications", ".", " You", " can", " watch", " me", " go", " on", " about", " it", " for", " a", " bit", " here", ".", "\n", "\n", "What", "\ufffd", "\ufffd", "s", " the", " problem", "?", " Well", ",", " let", "\ufffd", "\ufffd", "s", " analyze", " the", " times", " that", " make", " up", " the", " total", " time", " you", " measure", " when", " you", " just", " time", " the", " execution", " of", " a", " script", ":", " Startup", ",", " Warm", "up", " and", " Runtime", ".", "\n", "\n", "Start", "up", " \u2013", " the", " time", " until", " we", " get", " to", " do", " anything", " \ufffd", "\ufffd", "use", "ful", "\ufffd", "\ufffd", " aka", " the", " Ruby", " Inter", "pre", "ter", " has", " started", " up", " and", " has", " parsed", " all", " the", " code", ".", " For", " reference", ",", " executing", " an", " empty", " ruby", " file", " with", " standard", " ruby", " takes", " 0", ".", "02", " seconds", " for", " me", ",", " MJ", "IT", " 0", ".", "17", " seconds", " and", " for", " Tru", "ff", "le", "Ruby", " it", " takes", " 2", ".", "5", " seconds", " (", "there", " are", " plans", " to", " significantly", " reduce", " it", " though", " with", " the", " help", " of", " Sub", "strate", " VM", ").", " This", " time", " is", " inherently", " present", " in", " every", " measured", " benchmark", " if", " you", " just", " time", " script", " execution", ".", "\n", "\n", "\u2013", " the", " time", " until", " we", " get", " to", " do", " anything", " \ufffd", "\ufffd", "use", "ful", "\ufffd", "\ufffd", " aka", " the", " Ruby", " Inter", "pre", "ter", " has", " started", " up", " and", " has", " parsed", " all", " the", " code", ".", " For", " reference", ",", " executing", " an", " empty", " ruby", " file", " with", " standard", " ruby", " takes", " 0", ".", "02", " seconds", " for", " me", ",", " MJ", "IT", " 0", ".", "17", " seconds", " and", " (", "there", " are", " plans", " to", " significantly", " reduce", " it", " though", " with", " the", " help", " of", " Sub", "strate", " VM", ").", " This", " time", " is", " inherently", " present", " in", " every", " measured", " benchmark", " if", " you", " just", " time", " script", " execution", ".", " Warm", "up", " \u2013", " the", " time", " it", " takes", " until", " the", " program", " can", " operate", " at", " full", " speed", ".", " This", " is", " especially", " important", " for", " implementations", " with", " a", " J", "IT", ".", " On", " a", " high", " level", " what", " happens", " is", " they", " see", " which", " code", " gets", " called", " a", " lot", " and", " they", " try", " to", " optimize", " this", " code", " further", ".", " This", " process", " takes", " a", " lot", " of", " time", " and", " only", " after", " it", " is", " completed", " can", " we", " truly", " speak", " of", " \ufffd", "\ufffd", "peak", " performance", "\ufffd", "\ufffd", ".", " Warm", "up", " can", " be", " significantly", " slower", " than", " runtime", ".", " We", "\ufffd", "\ufffd", "ll", " analyze", " the", " warm", "up", " times", " more", " further", " down", ".", "\n", "\n", "\u2013", " the", " time", " it", " takes", " until", " the", " program", " can", " operate", " at", " full", " speed", ".", " This", " is", " especially", " important", " for", " implementations", " with", " a", " J", "IT", ".", " On", " a", " high", " level", " what", " happens", " is", " they", " see", " which", " code", " gets", " called", " a", " lot", " and", " they", " try", " to", " optimize", " this", " code", " further", ".", " This", " process", " takes", " a", " lot", " of", " time", " and", " only", " after", " it", " is", " completed", " can", " we", " truly", " speak", " of", " \ufffd", "\ufffd", "peak", " performance", "\ufffd", "\ufffd", ".", " We", "\ufffd", "\ufffd", "ll", " analyze", " the", " warm", "up", " times", " more", " further", " down", ".", " Runtime", " \u2013", " what", " I", "\ufffd", "\ufffd", "d", " call", " \ufffd", "\ufffd", "peak", " performance", "\ufffd", "\ufffd", " \u2013", " run", " times", " have", " stabilized", ".", " Most", "/", "all", " code", " has", " already", " been", " optimized", " by", " the", " runtime", ".", " This", " is", " the", " performance", " level", " that", " the", " code", " will", " run", " at", " for", " now", " and", " the", " future", ".", " Ideally", ",", " we", " want", " to", " measure", " this", " as", " 99", ".", "99", "%", "+", " of", " the", " time", " our", " code", " will", " run", " in", " a", " warmed", " up", " already", " started", " state", ".", "\n", "\n", "Interestingly", ",", " the", " startup", "/", "warm", "up", " times", " are", " acknowledged", " in", " the", " original", " benchmark", " but", " the", " way", " that", " they", " are", " dealt", " with", " simply", " less", "ens", " their", " effect", " but", " is", " far", " from", " getting", " rid", " of", " them", ":", " \ufffd", "\ufffd", "MJ", "IT", " has", " a", " very", " fast", " startup", " which", " is", " not", " true", " for", " J", "Ruby", " and", " Gra", "al", " Ruby", ".", " To", " give", " a", " better", " chance", " to", " J", "Ruby", " and", " Gra", "al", " Ruby", " the", " benchmarks", " were", " modified", " in", " a", " way", " that", " Ruby", " MRI", " v", "2", ".", "0", " runs", " about", " 20", "s", "-", "70", "s", " on", " each", " benchmark", "\ufffd", "\ufffd", ".", "\n", "\n", "I", " argue", " that", " in", " the", " greater", " scheme", " of", " things", ",", " startup", " and", " warm", "up", " don", "\ufffd", "\ufffd", "t", " really", " matter", " when", " we", " are", " talking", " about", " benchmarks", " when", " our", " purpose", " is", " to", " see", " how", " they", " perform", " in", " a", " long", " lived", " process", ".", "\n", "\n", "Why", " is", " that", ",", " though", "?", " Web", " applications", " for", " instance", " are", " usually", " long", " lived", ",", " we", " start", " our", " web", " server", " once", " and", " then", " it", " runs", " for", " hours", ",", " days", ",", " weeks", ".", " We", " only", " pay", " the", " cost", " of", " startup", " and", " warm", "up", " once", " in", " the", " beginning", ",", " but", " run", " it", " for", " a", " much", " longer", " time", " until", " we", " shut", " the", " server", " down", " again", ".", " Normally", " servers", " should", " spend", " 99", ".", "99", "%", "+", " of", " their", " time", " in", " the", " warmed", " up", " runtime", " \ufffd", "\ufffd", "state", "\ufffd", "\ufffd", ".", " This", " is", " a", " fact", ",", " that", " our", " benchmarks", " should", " reflect", " as", " we", " should", " look", " for", " what", " gives", " us", " the", " best", " performance", " for", " our", " hours", "/", "days", "/", "we", "eks", " of", " run", " time", ",", " not", " for", " the", " first", " seconds", " or", " minutes", " of", " starting", " up", ".", "\n", "\n", "A", " little", " analogy", " here", " is", " a", " car", ".", " You", " wanna", " go", " 300", " kilometers", " as", " fast", " as", " possible", " (", "straight", " line", ").", " Me", "asuring", " as", " shown", " above", " is", " the", " equivalent", " of", " measuring", " maybe", " the", " first", " ~", "500", " meters", ".", " Getting", " in", " the", " car", ",", " accelerating", " to", " top", " speed", " and", " maybe", " a", " bit", " of", " time", " on", " top", " speed", ".", " Is", " the", " car", " that", "\ufffd", "\ufffd", "s", " fastest", " on", " the", " first", " 500", " meters", " truly", " the", " best", " for", " going", " 300", " kilometers", " at", " top", " speed", "?", " Probably", " not", ".", " (", "Note", ":", " I", " know", " little", " about", " cars", ")", "\n", "\n", "What", " does", " this", " mean", " for", " our", " benchmark", "?", " Ideally", " we", " should", " eliminate", " startup", " and", " warm", "up", " time", ".", " We", " can", " do", " this", " by", " using", " a", " benchmark", "ing", " library", " written", " in", " ruby", " that", " also", " runs", " the", " benchmark", " for", " a", " couple", " of", " times", " before", " actually", " taking", " measurements", " (", "warm", "up", " time", ").", " We", "\ufffd", "\ufffd", "ll", " use", " my", " own", " little", " library", " as", " it", " means", " no", " gem", " required", " and", " it", "\ufffd", "\ufffd", "s", " well", " equipped", " for", " the", " rather", " long", " run", " times", ".", "\n", "\n", "But", " does", " startup", " and", " warm", "up", " truly", " never", " matter", "?", " It", " does", " matter", ".", " Most", " prominently", " it", " matters", " during", " development", " time", " \u2013", " starting", " the", " server", ",", " reload", "ing", " code", ",", " running", " tests", ".", " For", " all", " of", " those", " you", " gotta", " \ufffd", "\ufffd", "pay", "\ufffd", "\ufffd", " startup", " and", " warm", "up", " time", ".", " Also", ",", " if", " you", " develop", " a", " UI", " application", " or", " a", " CLI", " tool", " for", " end", " users", " startup", " and", " warm", "up", " might", " be", " a", " bigger", " problem", ",", " as", " startup", " happens", " way", " more", " often", ".", " You", " can", "\ufffd", "\ufffd", "t", " just", " warm", " it", " up", " before", " you", " take", " it", " into", " the", " load", " bal", "ancer", ".", " Also", ",", " running", " tasks", " periodically", " as", " a", " cr", "on", "job", " on", " your", " server", " will", " have", " to", " pay", " the", "ses", " costs", ".", "\n", "\n", "So", " are", " there", " benefits", " to", " measuring", " with", " startup", " and", " warm", "up", " included", "?", " Yes", ",", " for", " one", " for", " the", " use", " cases", " mentioned", " above", " it", " is", " important", ".", " Secondly", ",", " measuring", " with", " time", " -", "v", " gives", " you", " a", " lot", " more", " data", ":", "\n", "\n", "t", "obi", "@", "spe", "edy", " $", " /", "usr", "/", "bin", "/", "time", " -", "v", " ~/", "dev", "/", "gra", "al", "vm", "-", "0", ".", "25", "/", "bin", "/", "ruby", " pent", ".", "rb", " Command", " being", " timed", ":", " \"/", "home", "/", "t", "obi", "/", "dev", "/", "gra", "al", "vm", "-", "0", ".", "25", "/", "bin", "/", "ruby", " pent", ".", "rb", "\"", " User", " time", " (", "seconds", "):", " 83", ".", "07", " System", " time", " (", "seconds", "):", " 0", ".", "99", " Percent", " of", " CPU", " this", " job", " got", ":", " 555", "%", " El", "apsed", " (", "wall", " clock", ")", " time", " (", "h", ":", "mm", ":", "ss", " or", " m", ":", "ss", "):", " 0", ":", "15", ".", "12", " Average", " shared", " text", " size", " (", "k", "bytes", "):", " 0", " Average", " un", "shared", " data", " size", " (", "k", "bytes", "):", " 0", " Average", " stack", " size", " (", "k", "bytes", "):", " 0", " Average", " total", " size", " (", "k", "bytes", "):", " 0", " Maximum", " resident", " set", " size", " (", "k", "bytes", "):", " 13", "117", "68", " Average", " resident", " set", " size", " (", "k", "bytes", "):", " 0", " Major", " (", "requ", "iring", " I", "/", "O", ")", " page", " faults", ":", " 57", " Minor", " (", "re", "claim", "ing", " a", " frame", ")", " page", " faults", ":", " 7", "26", "82", " Vol", "untary", " context", " switches", ":", " 167", "18", " Inv", "ol", "untary", " context", " switches", ":", " 13", "697", " Sw", "aps", ":", " 0", " File", " system", " inputs", ":", " 255", "20", " File", " system", " outputs", ":", " 312", " Socket", " messages", " sent", ":", " 0", " Socket", " messages", " received", ":", " 0", " Sign", "als", " delivered", ":", " 0", " Page", " size", " (", "bytes", "):", " 4096", " Exit", " status", ":", " 0", "\n", "\n", "You", " get", " lots", " of", " data", ",", " among", " which", " there", "\ufffd", "\ufffd", "s", " memory", " usage", ",", " CPU", " usage", ",", " wall", " clock", " time", " and", " others", " which", " are", " also", " important", " for", " evaluating", " language", " implementations", " which", " is", " why", " they", " are", " also", " included", " in", " the", " original", " benchmarks", ".", "\n", "\n", "Setup", "\n", "\n", "Before", " we", " (", "f", "inally", "!)", " get", " to", " the", " benchmarks", ",", " the", " obligatory", " \ufffd", "\ufffd", "This", " is", " the", " system", " I", "\ufffd", "\ufffd", "m", " running", " this", " on", "\ufffd", "\ufffd", ":", "\n", "\n", "The", " ruby", " versions", " in", " use", " are", " MJ", "IT", " as", " of", " this", " commit", " from", " 25", "th", " of", " August", " compiled", " with", " no", " special", " settings", ",", " gra", "al", "vm", " 25", " and", " 27", " (", "more", " on", " that", " in", " a", " bit", ")", " as", " well", " as", " CR", "ub", "y", " 2", ".", "0", ".", "0", "-", "p", "648", " as", " a", " baseline", ".", "\n", "\n", "All", " of", " this", " is", " run", " on", " my", " Desktop", " PC", " running", " Linux", " Mint", " 18", ".", "2", " (", "based", " on", " Ubuntu", " 16", ".", "04", " L", "TS", ")", " with", " 16", " GB", " of", " memory", " and", " an", " i", "7", "-", "47", "90", " (", "3", ".", "6", " GHz", ",", " 4", " GHz", " boost", ").", "\n", "\n", "t", "obi", "@", "spe", "edy", " ~", " $", " un", "ame", " -", "a", " Linux", " speedy", " 4", ".", "10", ".", "0", "-", "33", "-", "generic", " #", "37", "~", "16", ".", "04", ".", "1", "-", "Ub", "untu", " S", "MP", " Fri", " Aug", " 11", " 14", ":", "07", ":", "24", " UTC", " 2017", " x", "86", "_", "64", " x", "86", "_", "64", " x", "86", "_", "64", " GNU", "/", "Linux", "\n", "\n", "I", " feel", " it", "\ufffd", "\ufffd", "s", " especially", " important", " to", " mention", " the", " setup", " in", " here", ",", " as", " when", " I", " first", " did", " these", " benchmarks", " for", " Poly", "conf", " on", " my", " dual", " core", " notebook", " Tru", "ff", "le", "Ruby", " had", " significantly", " worse", " results", ".", " I", " think", " gra", "al", "vm", " benefits", " from", " the", " 2", " extra", " cores", " for", " warm", "up", " etc", ",", " as", " the", " CPU", " usage", " across", " cores", " is", " also", " quite", " high", ".", "\n", "\n", "You", " can", " check", " out", " the", " benchmark", "ing", " script", " used", " etc", ".", " as", " part", " of", " this", " repo", ".", "\n", "\n", "But", "\u2026", " you", " promised", " benchmarks", ",", " where", " are", " they", "?", "\n", "\n", "Sorry", ",", " I", " think", " the", " theory", " is", " more", " important", " than", " the", " benchmarks", " themselves", ",", " although", " they", " undoubtedly", " help", " illustrate", " the", " point", ".", " We", "\ufffd", "\ufffd", "ll", " first", " get", " into", " why", " I", " chose", " the", " pent", ".", "rb", " benchmark", " as", " a", " subject", " and", " why", " I", " run", " it", " with", " a", " slightly", " old", " versions", " of", " gra", "al", "vm", " (", "no", " worries", ",", " current", " version", " coming", " in", " later", " on", ").", " Then", ",", " finally", ",", " graphs", " and", " numbers", ".", "\n", "\n", "Why", " this", " benchmark", "?", "\n", "\n", "First", " of", " all", ",", " the", " original", " benchmarks", " were", " done", " with", " gra", "al", "vm", "-", "0", ".", "22", ".", " Attempt", "ing", " to", " reproduce", " the", " results", " with", " the", " (", "at", " the", " time", " current", ")", " gra", "al", "vm", "-", "0", ".", "25", " proved", " difficult", " as", " a", " lot", " of", " them", " had", " already", " been", " optimized", " (", "and", " 0", ".", "22", " contained", " some", " genuine", " performance", " bugs", ").", "\n", "\n", "One", " that", " I", " could", " still", " reproduce", " the", " performance", " problems", " with", " was", " pent", ".", "rb", " and", " it", " also", " seemed", " like", " a", " great", " candidate", " to", " show", " that", " something", " is", " flawed", ".", " In", " the", " original", " benchmarks", " it", " is", " noted", " down", " as", " 0", ".", "33", " times", " the", " performance", " of", " Ruby", " 2", ".", "0", " (", "or", " well", ",", " 3", " times", " slower", ").", " All", " my", " experience", " with", " Tru", "ff", "le", "Ruby", " told", " me", " that", " this", " is", " most", " likely", " wrong", ".", " So", ",", " I", " didn", "\ufffd", "\ufffd", "t", " choose", " it", " because", " it", " was", " the", " fastest", " one", " on", " Tru", "ff", "le", "Ruby", ",", " but", " rather", " the", " opposite", " \u2013", " it", " was", " the", " slow", "est", " one", ".", "\n", "\n", "Moreover", ",", " while", " a", " lot", " of", " it", " isn", "\ufffd", "\ufffd", "t", " exactly", " idi", "omatic", " ruby", " code", " to", " my", " mind", " (", "no", " classes", ",", " lots", " of", " global", " variables", ")", " it", " uses", " quite", " a", " lot", " En", "umerable", " methods", " such", " as", " each", ",", " collect", ",", " sort", " and", " un", "iq", " while", " ref", "raining", " from", " bit", "mask", "es", " and", " the", " like", ".", " So", " I", " also", " felt", " that", " it", "\ufffd", "\ufffd", "d", " make", " a", " comparatively", " good", " candidate", " from", " here", ".", "\n", "\n", "The", " way", " the", " benchmark", " is", " run", " is", " basically", " the", " original", " benchmark", " put", " into", " a", " loop", " so", " it", " is", " repeated", " a", " bunch", " of", " times", " so", " we", " can", " measure", " the", " times", " during", " warm", "up", " and", " later", " runtime", " to", " get", " an", " average", " of", " the", " runtime", " performance", ".", "\n", "\n", "So", ",", " why", " am", " I", " running", " it", " on", " the", " old", " gra", "al", "vm", "-", "0", ".", "25", " version", "?", " Well", ",", " whatever", " is", " in", " a", " benchmark", " is", " gonna", " get", " optimized", " making", " the", " difference", " here", " less", " apparent", ".", "\n", "\n", "But", " seriously", " though", ",", " who", " uses", " a", " global", " variable", " instead", " of", " an", " argument", " to", " pass", " a", " value", " to", " a", " method", "?", " https", "://", "t", ".", "co", "/", "TL", "UG", "r", "8", "K", "V", "U", "Y", " \u2014", " Ben", "oit", " D", "alo", "ze", " (@", "ere", "g", "ont", "p", ")", " July", " 10", ",", " 2017", "\n", "\n", "We", "\ufffd", "\ufffd", "ll", " run", " the", " new", " improved", " version", " later", ".", "\n", "\n", "MJ", "IT", " vs", ".", " gra", "al", "vm", "-", "0", ".", "25", "\n", "\n", "So", " on", " my", " machine", " the", " initial", " execution", " of", " the", " pent", ".", "rb", " benchmark", " (", "tim", "ing", " startup", ",", " warm", "up", " and", " runtime", ")", " on", " Tru", "ff", "le", "Ruby", " 0", ".", "25", " took", " 15", ".", "05", " seconds", " while", " it", " just", " took", " 7", ".", "26", " seconds", " with", " MJ", "IT", ".", " Which", " has", " MJ", "IT", " being", " 2", ".", "1", " times", " faster", ".", " Imp", "ressive", "!", "\n", "\n", "What", "\ufffd", "\ufffd", "s", " when", " we", " account", " for", " startup", " and", " warm", "up", " though", "?", " If", " we", " benchmark", " just", " in", " ruby", " startup", " time", " already", " goes", " away", ",", " as", " we", " can", " only", " start", " measuring", " inside", " ruby", " once", " the", " interpreter", " has", " started", ".", " Now", " for", " warm", "up", ",", " we", " run", " the", " code", " to", " benchmark", " in", " a", " loop", " for", " 60", " seconds", " of", " warm", "up", " time", " and", " 60", " seconds", " for", " measuring", " the", " actual", " runtime", ".", " I", " plotted", " the", " execution", " times", " of", " the", " first", " 15", " iterations", " below", " (", "that", "\ufffd", "\ufffd", "s", " about", " when", " Tru", "ff", "le", "Ruby", " stabil", "izes", "):", "\n", "\n", "As", " you", " can", " clearly", " see", ",", " Tru", "ff", "le", "Ruby", " starts", " out", " a", " lot", " slower", " but", " picks", " up", " speed", " quickly", " while", " MJ", "IT", " stay", " more", " or", " less", " consistent", ".", " What", "\ufffd", "\ufffd", "s", " interesting", " to", " see", " is", " that", " iteration", " 6", " and", " 7", " of", " Tru", "fle", "Ruby", " are", " slower", " again", ".", " Either", " it", " found", " a", " new", " optimization", " that", " took", " significant", " time", " to", " complete", " or", " a", " de", "optim", "ization", " had", " to", " happen", " as", " the", " constraints", " of", " a", " previous", " optimization", " were", " no", " longer", " valid", ".", " Tru", "ff", "le", "Ruby", " stabil", "izes", " from", " there", " and", " reaches", " peak", " performance", ".", "\n", "\n", "Running", " the", " benchmarks", " we", " get", " an", " average", " (", "warm", ")", " time", " for", " Tru", "ff", "le", "Ruby", " of", " 1", ".", "75", " seconds", " and", " for", " MJ", "IT", " we", " get", " 7", ".", "33", " seconds", ".", " Which", " means", " that", " with", " this", " way", " of", " measuring", ",", " Tru", "ff", "le", "Ruby", " is", " suddenly", " 4", ".", "2", " times", " faster", " than", " MJ", "IT", ".", "\n", "\n", "We", " went", " from", " 2", ".", "1", " times", " slower", " to", " 4", ".", "2", " times", " faster", " and", " we", " only", " changed", " the", " measuring", " method", ".", "\n", "\n", "I", " like", " to", " present", " benchmark", "ing", " numbers", " in", " iterations", " per", " second", "/", "minute", " (", "ips", "/", "ip", "m", ")", " as", " here", " \ufffd", "\ufffd", "higher", " is", " better", "\ufffd", "\ufffd", " so", " graphs", " are", " far", " more", " intuitive", ",", " our", " execution", " times", " converted", " are", " 34", ".", "25", " iterations", " per", " minute", " for", " Tru", "ff", "le", "Ruby", " and", " 8", ".", "18", " iterations", " per", " minute", " for", " MJ", "IT", ".", " So", " now", " have", " a", " look", " at", " our", " numbers", " converted", " to", " iterations", " per", " minute", " compared", " for", " the", " initial", " measuring", " method", " and", " our", " new", " measuring", " method", ":", "\n", "\n", "You", " can", " see", " the", " stark", " contrast", " for", " Tru", "ff", "le", "Ruby", " caused", " by", " the", " hefty", " warm", "up", "/", "long", " execution", " time", " during", " the", " first", " couple", " of", " iterations", ".", " MJ", "IT", " on", " the", " other", " hand", ",", " is", " very", " stable", ".", " The", " difference", " is", " well", " within", " the", " margin", " of", " error", ".", "\n", "\n", "Ruby", " 2", ".", "0", " vs", " MJ", "IT", " vs", ".", " gra", "al", "vm", "-", "0", ".", "25", " vs", ".", " gra", "al", "vm", "-", "0", ".", "27", "\n", "\n", "Well", ",", " I", " promised", " you", " more", " data", " and", " here", " is", " more", " data", "!", " This", " data", " set", " also", " includes", " CR", "ub", "y", " 2", ".", "0", " as", " the", " base", " line", " as", " well", " as", " the", " new", " gra", "al", "vm", ".", "\n", "\n", "initial", " time", " (", "seconds", ")", " ip", "m", " of", " initial", " time", " average", " (", "seconds", ")", " ip", "m", " of", " average", " after", " warm", "up", " Standard", " Dev", "iation", " as", " part", " of", " total", " CR", "ub", "y", " 2", ".", "0", " 12", ".", "3", " 4", ".", "87", " 12", ".", "34", " 4", ".", "86", " 0", ".", "43", "%", " Tru", "ff", "le", "Ruby", " 0", ".", "25", " 15", ".", "05", " 3", ".", "98", " 1", ".", "75", " 34", ".", "25", " 0", ".", "21", "%", " Tru", "ff", "le", "Ruby", " 0", ".", "27", " 8", ".", "81", " 6", ".", "81", " 1", ".", "22", " 49", ".", "36", " 0", ".", "44", "%", " MJ", "IT", " 7", ".", "26", " 8", ".", "26", " 7", ".", "33", " 8", ".", "18", " 2", ".", "39", "%", "\n", "\n", "We", " can", " see", " that", " Tru", "ff", "le", "Ruby", " 0", ".", "27", " is", " already", " faster", " than", " MJ", "IT", " in", " the", " first", " iteration", ",", " which", " is", " quite", " impressive", ".", " It", "\ufffd", "\ufffd", "s", " also", " lacking", " the", " weird", " \ufffd", "\ufffd", "getting", " slower", "\ufffd", "\ufffd", " around", " the", " 6", "th", " iteration", " and", " as", " such", " reaches", " peak", " performance", " much", " faster", " than", " Tru", "ff", "le", "Ruby", " 0", ".", "25", ".", " It", " also", " gets", " faster", " overall", " as", " we", " can", " see", " if", " we", " compare", " the", " \ufffd", "\ufffd", "warm", "\ufffd", "\ufffd", " performance", " of", " all", " 4", " competitors", ":", "\n", "\n", "So", " not", " only", " did", " the", " warm", "up", " get", " much", " faster", " in", " Tru", "ff", "le", "Ruby", " 0", ".", "27", " the", " overall", " performance", " also", " increased", " quite", " a", " bit", ".", " It", " is", " now", " more", " than", " 6", " times", " faster", " than", " MJ", "IT", ".", " Of", " course", ",", " some", " of", " it", " is", " probably", " the", " Tru", "ff", "le", "Ruby", " team", " tuning", " it", " to", " the", " existing", " benchmark", ",", " which", " reiter", "ates", " my", " point", " that", " we", " do", " need", " better", " benchmarks", ".", "\n", "\n", "As", " a", " last", " fancy", " graph", " for", " you", " I", " have", " the", " comparison", " of", " measuring", " the", " runtime", " through", " time", " versus", " giving", " it", " warm", "up", " time", ",", " then", " benchmark", "ing", " multiple", " iterations", ":", "\n", "\n", "CR", "ub", "y", " 2", " is", " quite", " consistent", " as", " expected", ",", " Tru", "ff", "le", "Ruby", " already", " manages", " a", " respectable", " out", " of", " the", " box", " performance", " but", " gets", " even", " faster", ".", " I", " hope", " this", " helps", " you", " see", " how", " the", " method", " of", " measuring", " can", " achieve", " drastically", " different", " results", ".", "\n", "\n", "Conclusion", "\n", "\n", "So", ",", " what", " can", " we", " take", " away", "?", " Startup", " time", " and", " warm", "up", " are", " a", " thing", " and", " you", " should", " think", " hard", " about", " whether", " those", " times", " are", " important", " for", " you", " and", " if", " you", " want", " to", " measure", " them", ".", " For", " web", " applications", ",", " most", " of", " the", " time", " startup", " and", " warm", "up", " aren", "\ufffd", "\ufffd", "t", " that", " important", " as", " 99", ".", "99", "%", "+", " you", "\ufffd", "\ufffd", "ll", " run", " with", " a", " warm", " \ufffd", "\ufffd", "runtime", "\ufffd", "\ufffd", " performance", ".", "\n", "\n", "Not", " only", " what", " time", " we", " measure", " is", " important", ",", " but", " also", " what", " code", " we", " measure", ".", " Bench", "marks", " should", " be", " as", " realistic", " as", " possible", " so", " that", " they", " are", " as", " significant", " as", " possible", ".", " What", " a", " benchmark", " on", " the", " Internet", " check", " most", " likely", " isn", "\ufffd", "\ufffd", "t", " directly", " related", " to", " what", " your", " application", " does", ".", "\n", "\n", "AL", "WAYS", " RUN", " YOUR", " OWN", " BEN", "CH", "M", "ARK", "S", " AND", " QUEST", "ION", " B", "OTH", " WHAT", " CODE", " IS", " BEN", "CH", "M", "ARK", "ED", ",", " HOW", " IT", " IS", " BEN", "CH", "M", "ARK", "ED", " AND", " WHAT", " TIM", "ES", " ARE", " T", "AK", "EN", "\n", "\n", "(", "I", " had", " this", " in", " my", " initial", " draft", ",", " but", " I", " ended", " up", " quite", " liking", " it", " so", " I", " kept", " it", " around", ")", "\n", "\n", "edit", "1", ":", " Added", " CLI", " tool", " specifically", " to", " where", " startup", " &", " warm", "up", " counts", " as", " well", " as", " a", " reference", " to", " Sub", "strate", " VM", " for", " how", " Tru", "ff", "le", "Ruby", " tries", " to", " combat", " it", " \ud83d\ude42", "\n", "\n", "edit", "2", ":", " Just", " scroll", " down", " a", " little", " to", " read", " an", " interesting", " comment", " by", " Vladimir", "\n", "\n", "Advertisements"]