["Supp", "ose", " that", " I", " give", " you", " a", " stream", " of", " values", " and", " you", " want", " to", " maintain", " the", " top", "-", "k", " smallest", " or", " largest", " values", ".", " You", " could", " accumulate", " all", " these", " values", ",", " sort", " them", " all", " and", " keep", " the", " smallest", " k", " values", ".", "\n", "\n", "You", " can", " do", " somewhat", " better", " by", " using", " a", " binary", " heap", " to", " construct", " a", " priority", " queue", ".", " And", " you", " can", " also", " use", " the", " Quick", "Select", " algorithm", ".", " I", " compared", " naive", " implementations", " of", " both", " the", " approach", " based", " on", " a", " binary", " heap", " and", " on", " Quick", "Select", " in", " a", " previous", " blog", " post", ".", "\n", "\n", "Let", " us", " review", " the", " code", " of", " these", " techniques", ".", " I", " use", " JavaScript", " because", " it", " is", " supported", " everywhere", ".", "\n", "\n", "We", " can", " sort", " and", " slice", "\u2026", "\n", "\n", "var", " a", " =", " new", " Array", " (", " )", " ;", " for", " (", " var", " i", " =", " 0", " ;", " i", " <", " stream", "size", " ;", " i", " ++", " )", " {", " a", ".", " push", " (", " rand", " (", " i", " )", " )", " ;", " }", " a", ".", " sort", " (", " function", " (", " a", ",", " b", " )", " {", " return", " a", " -", " b", " }", " )", " ;", " var", " answer", " =", " a", ".", " slice", " (", " 0", ",", " k", " )", " ;", "\n", "\n", "We", " can", " dump", " everything", " na", "ively", " into", " a", " priority", " queue", " (", "backed", " by", " a", " binary", " heap", ")", "\u2026", "\n", "\n", "var", " reversed", "default", "com", "par", "ator", " =", " function", "(", "a", ",", " b", ")", " {", " return", " a", " >", " b", " ;", " }", " ;", "\n", "\n", "var", " b", " =", " new", " Fast", "Prior", "ity", "Queue", " (", " reversed", "default", "com", "par", "ator", " )", " ;", " for", " (", " var", " i", " =", " 0", " ;", " i", " <", " k", " ;", " i", " ++", " )", " {", " b", ".", " add", " (", " rand", " (", " i", " )", " )", " ;", " }", " for", " (", " i", " =", " k", " ;", " i", " <", " stream", "size", " ;", " i", " ++", " )", " {", " b", ".", " add", " (", " rand", " (", " i", " )", " )", " ;", " b", ".", " poll", " (", " )", " ;", " }", " var", " answer", " =", " b", ".", " array", ".", " slice", " (", " 0", ",", " k", " )", ".", " sort", " (", " function", " (", " a", ",", " b", " )", " {", " return", " a", " -", " b", " }", " )", " ;", "\n", "\n", "Each", " time", " we", " call", " poll", " in", " the", " priority", " queue", ",", " we", " remove", " the", " largest", " element", ".", " Thus", " we", " maintain", " a", " list", " of", " k", " smallest", " elements", ".", "\n", "\n", "I", " now", " want", " to", " consider", " less", " naive", " implementations", " of", " these", " ideas", ".", "\n", "\n", "At", " all", " time", ",", " we", " have", " access", " to", " the", " largest", " element", " in", " the", " priority", " queue", " through", " the", " peek", " function", ".", " Long", "-", "time", " reader", " Kendall", " Wil", "lets", " pointed", " out", " to", " me", " that", " we", " can", " make", " good", " use", " of", " the", " peek", " function", " as", " follows", ".", "\n", "\n", "var", " b", " =", " new", " Fast", "Prior", "ity", "Queue", " (", " reversed", "default", "com", "par", "ator", " )", " ;", " for", " (", " var", " i", " =", " 0", " ;", " i", " <", " k", " ;", " i", " ++", " )", " {", " b", ".", " add", " (", " rand", " (", " i", " )", " )", " ;", " }", " for", " (", " i", " =", " k", " ;", " i", " <", " stream", "size", " ;", " i", " ++", " )", " {", " var", " x", " =", " rand", " (", " i", " )", " ;", " if", " (", " x", " <", " b", ".", " peek", " (", " )", " )", " {", " b", ".", " add", " (", " x", " )", " ;", " b", ".", " poll", " (", " )", " ;", " }", " }", " var", " answer", " =", " b", ".", " array", ".", " slice", " (", " 0", ",", " k", " )", ".", " sort", " (", " function", " (", " a", ",", " b", " )", " {", " return", " a", " -", " b", " }", " )", " ;", "\n", "\n", "This", " has", " the", " potential", " of", " reducing", " substantially", " the", " amount", " of", " work", " that", " the", " priority", " queue", " has", " to", " do", ".", "\n", "\n", "What", " about", " the", " Quick", "Select", " algorithm", "?", "\n", "\n", "Mic", "hel", " Lem", "ay", " pointed", " out", " to", " me", " what", " the", " Google", " Gu", "ava", " library", " does", ",", " which", " is", " to", " use", " a", " small", " buffer", " (", "of", " size", " k", ")", " and", " to", " run", " Quick", "Select", " on", " this", " small", " buffer", " instead", " of", " the", " whole", " stream", " of", " data", ".", "\n", "\n", "var", " a", " =", " new", " Array", " (", " )", " ;", " for", " (", " var", " i", " =", " 0", " ;", " i", " <", " 2", " *", " k", " ;", " i", " ++", " )", " {", " a", ".", " push", " (", " rand", " (", " i", " )", " )", " ;", " }", " Quick", "Select", " (", " a", ",", " k", ",", " default", "com", "par", "ator", " )", " ;", " var", " eaten", " =", " 2", " *", " k", " ;", " while", " (", " eaten", " <", " stream", "size", " )", " {", " for", " (", " var", " i", " =", " 0", " ;", " i", " <", " k", " ;", " i", " ++", " )", " {", " a", " [", " k", " +", " i", " ]", " =", " rand", " (", " i", " +", " eaten", " )", " ;", " }", " Quick", "Select", " (", " a", ",", " k", ",", " default", "com", "par", "ator", " )", " ;", " eaten", " +=", " k", " ;", " }", " var", " answer", " =", " a", ".", " slice", " (", " 0", ",", " k", " )", ".", " sort", " (", " function", " (", " a", ",", " b", " )", " {", " return", " a", " -", " b", " }", " )", " ;", "\n", "\n", "David", " E", "pp", "stein", " described", " to", " me", " something", " slightly", " more", " complex", " where", " we", " use", " our", " knowledge", " of", " the", " pivot", " in", " the", " Quick", "Select", " algorithm", " to", " only", " merge", " potential", " candidates", ".", "\n", "\n", "var", " a", " =", " new", " Array", " (", " )", " ;", " var", " i", " =", " 0", " ;", " for", " (", " ;", " i", " <", " 2", " *", " k", " ;", " i", " ++", " )", " {", " a", ".", " push", " (", " rand", " (", " i", " )", " )", " ;", " }", " Quick", "Select", " (", " a", ",", " k", ",", " default", "com", "par", "ator", " )", " ;", " var", " pivot", "value", " =", " a", " [", " k", " ]", " ;", " var", " location", "in", "buffer", " =", " k", " ;", " for", " (", " ;", " i", " <", " stream", "size", " ;", " i", " +=", " 1", " )", " {", " var", " new", "value", " =", " rand", " (", " i", " )", " ;", " if", " (", " new", "value", " <", " pivot", "value", " )", " {", " a", " [", " location", "in", "buffer", " ++", " ]", " =", " new", "value", " ;", " }", " if", " (", " location", "in", "buffer", " ==", " 2", " *", " k", " )", " {", " Quick", "Select", " (", " a", ",", " k", ",", " default", "com", "par", "ator", " )", " ;", " location", "in", "buffer", " =", " k", " ;", " }", " }", " if", " (", " location", "in", "buffer", "!=", " k", " )", " {", " Quick", "Select", " (", " a", ",", " k", ",", " default", "com", "par", "ator", " )", " ;", " }", " var", " answer", " =", " a", ".", " slice", " (", " 0", ",", " k", " )", ".", " sort", " (", " function", " (", " a", ",", " b", " )", " {", " return", " a", " -", " b", " }", " )", " ;", "\n", "\n", "It", " is", " not", " exactly", " what", " David", " described", ",", " but", " I", " believe", " that", " it", " captures", " the", " essence", " of", " his", " idea", ".", "\n", "\n", "So", " how", " do", " these", " techniques", " fare", "?", "\n", "\n", "I", " have", " implemented", " a", " benchmark", " that", " you", " can", " run", " yourself", ",", " here", " are", " my", " raw", " results", ":", "\n", "\n", "$", " node", " test", ".", " js", " Platform", " :", " linux", " 4", ".", " 4", ".", " 0", " -", " 38", " -", "generic", " x", "64", " Intel", " (", " R", " )", " Core", " (", " TM", " )", " i", "7", "-", " 67", "00", " CPU", " @", " 3", ".", " 40", "GHz", " Node", " version", " 4", ".", " 5", ".", " 0", ",", " v", "8", " version", " 4", ".", " 5", ".", " 103", ".", " 37", " starting", " dynamic", " queue", "/", "en", "queue", " benchmark", " Fast", "Prior", "ity", "Queue", " x", " 3", ",", " 0", "95", " ops", "/", "sec", " \u00b1", " 0", ".", " 15", " %", " (", " 97", " runs", " sampled", " )", " Fast", "Prior", "ity", "Queue", "-", "K", "Wil", "lets", " x", " 18", ",", " 8", "75", " ops", "/", "sec", " \u00b1", " 0", ".", " 59", " %", " (", " 93", " runs", " sampled", " )", " sort", " x", " 490", " ops", "/", "sec", " \u00b1", " 0", ".", " 37", " %", " (", " 94", " runs", " sampled", " )", " Quick", "Select", " x", " 8", ",", " 5", "76", " ops", "/", "sec", " \u00b1", " 0", ".", " 31", " %", " (", " 97", " runs", " sampled", " )", " Quick", "Select", "-", "na", "ive", "Google", "Gu", "ava", " x", " 6", ",", " 00", "3", " ops", "/", "sec", " \u00b1", " 0", ".", " 20", " %", " (", " 98", " runs", " sampled", " )", " Quick", "Select", "-", "na", "ive", "David", "E", "pp", "stein", " x", " 7", ",", " 317", " ops", "/", "sec", " \u00b1", " 0", ".", " 22", " %", " (", " 98", " runs", " sampled", " )", "\n", "\n", "So", " in", " my", " particular", " test", ",", " the", " approach", " proposed", " by", " Kendall", " Wil", "lets", ",", " using", " a", " priority", " queue", " with", " pr", "uning", " based", " on", " the", " peek", " value", ",", " is", " a", " net", " winner", ".", " Your", " results", " might", " vary", ",", " but", " I", " think", " that", " the", " Wil", "lets", " approach", " is", " attractive", ".", " It", " is", " simple", ",", " it", " uses", " little", " memory", " and", " it", " should", " provide", " consistent", " performance", ".", "\n", "\n", "Ex", "ercise", " for", " the", " reader", ":", " I", " am", " using", " a", " random", " input", " in", " my", " benchmark", ".", " As", " pointed", " out", " by", " David", " E", "pp", "stein", ",", " this", " means", " that", " we", " can", " bound", " the", " probability", " that", " the", " it", "h", " value", " is", " in", " the", " top", "-", "k", " by", " min", "(", "1", ",", " k", "/", "i", "),", " so", " that", " the", " Wil", "lets", " check", " only", " fails", " O", "(", "k", " log", " n", ")", " times", ".", " How", " well", " would", " the", " different", " techniques", " do", " for", " nearly", " sorted", " data", "?", "\n", "\n", "Update", ":", " As", " pointed", " out", " in", " the", " comments", ",", " we", " can", " further", " improve", " the", " Wil", "lets", " approach", " by", " merging", " the", " add", " and", " poll", " functions", " into", " a", " single", " function", ".", " The", " code", " is", " similar", "\u2026", "\n", "\n", "var", " b", " =", " new", " Fast", "Prior", "ity", "Queue", " (", " reversed", "default", "com", "par", "ator", " )", " ;", " for", " (", " var", " i", " =", " 0", " ;", " i", " <", " k", " ;", " i", " ++", " )", " {", " b", ".", " add", " (", " rand", " (", " i", " )", " )", " ;", " }", " for", " (", " i", " =", " k", " ;", " i", " <", " stream", "size", " ;", " i", " ++", " )", " {", " var", " x", " =", " rand", " (", " i", " )", " ;", " if", " (", " x", " <", " b", ".", " peek", " (", " )", " )", " {", " b", ".", " replace", "Top", " (", " x", " )", " ;", " }", " }", " var", " answer", " =", " b", ".", " array", ".", " slice", " (", " 0", ",", " k", " )", ".", " sort", " (", " function", " (", " a", ",", " b", " )", " {", " return", " a", " -", " b", " }", " )", " ;", "\n", "\n", "So", " what", " is", " the", " performance", " this", " time", "?", "\n", "\n", "$", " node", " test", ".", " js", " Platform", " :", " linux", " 4", ".", " 4", ".", " 0", " -", " 38", " -", "generic", " x", "64", " Intel", " (", " R", " )", " Core", " (", " TM", " )", " i", "7", "-", " 67", "00", " CPU", " @", " 3", ".", " 40", "GHz", " Node", " version", " 4", ".", " 5", ".", " 0", ",", " v", "8", " version", " 4", ".", " 5", ".", " 103", ".", " 37", " starting", " dynamic", " queue", "/", "en", "queue", " benchmark", " Fast", "Prior", "ity", "Queue", " x", " 3", ",", " 137", " ops", "/", "sec", " \u00b1", " 0", ".", " 13", " %", " (", " 97", " runs", " sampled", " )", " Fast", "Prior", "ity", "Queue", "-", "K", "Wil", "lets", " x", " 19", ",", " 0", "27", " ops", "/", "sec", " \u00b1", " 0", ".", " 37", " %", " (", " 94", " runs", " sampled", " )", " Fast", "Prior", "ity", "Queue", "-", "K", "Wil", "lets", "-", "replace", "Top", " x", " 22", ",", " 200", " ops", "/", "sec", " \u00b1", " 0", ".", " 46", " %", " (", " 95", " runs", " sampled", " )", " sort", " x", " 4", "79", " ops", "/", "sec", " \u00b1", " 0", ".", " 42", " %", " (", " 92", " runs", " sampled", " )", " Quick", "Select", " x", " 8", ",", " 5", "89", " ops", "/", "sec", " \u00b1", " 0", ".", " 31", " %", " (", " 98", " runs", " sampled", " )", " Quick", "Select", "-", "na", "ive", "Google", "Gu", "ava", " x", " 5", ",", " 6", "61", " ops", "/", "sec", " \u00b1", " 0", ".", " 22", " %", " (", " 97", " runs", " sampled", " )", " Quick", "Select", "-", "na", "ive", "David", "E", "pp", "stein", " x", " 7", ",", " 320", " ops", "/", "sec", " \u00b1", " 0", ".", " 25", " %", " (", " 98", " runs", " sampled", " )", "\n", "\n", "So", " we", " improve", " the", " performance", " once", " more", "!", "\n", "\n", "Update", " 2", ":", " You", " can", " combine", " a", " binary", " heap", " and", " Quick", "Select", " using", " int", "rose", "lect", "."]