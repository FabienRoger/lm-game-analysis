["CPU", " profiles", ",", " which", " can", " be", " visual", "ized", " as", " a", " CPU", " flame", " graph", ",", " can", " solve", " a", " wide", " range", " of", " CPU", " usage", " issues", ".", " Off", "-", "CPU", " analysis", ",", " which", " can", " be", " visual", "ized", " as", " Off", "-", "CPU", " time", " flame", " graphs", ",", " can", " begin", " to", " solve", " the", " rest", ".", " As", " I", " recently", " hacked", " stack", " traces", " for", " e", "BP", "F", ",", " I", " can", " now", " start", " to", " explore", " off", "-", "CPU", " profiling", " using", " core", " Linux", " capabilities", ".", "\n", "\n", "Off", "-", "CPU", " Time", " Flame", " Graph", "\n", "\n", "This", " is", " for", " a", " Linux", " kernel", " build", ",", " followed", " by", " a", " CPU", " profile", " flame", " graph", ":", "\n", "\n", "Click", " to", " zoom", ",", " or", " browse", " the", " Off", "-", "CPU", " and", " CPU", " flame", " graph", " SV", "Gs", " directly", ".", " To", " keep", " these", " examples", " simple", ",", " I", "'m", " only", " showing", " kernel", " time", ".", "\n", "\n", "Seeing", " both", " on", "-", "CPU", " and", " off", "-", "CPU", " flame", " graphs", " shows", " you", " the", " full", " picture", ":", " what", "'s", " consuming", " CPUs", ",", " what", "'s", " blocked", ",", " and", " by", " how", " much", ".", " The", " x", "-", "axis", " for", " the", " CPU", " flame", " graph", " shows", " the", " sample", " population", ".", " The", " x", "-", "axis", " for", " the", " off", "-", "CPU", " time", " flame", " graph", " shows", " the", " time", " threads", " were", " blocked", ".", "\n", "\n", "This", " example", " off", "-", "CPU", " time", " flame", " graph", " has", " the", " thread", " names", " at", " the", " bottom", ",", " then", " the", " stack", " traces", ".", " During", " the", " Linux", " kernel", " compile", ",", " we", " can", " see", " \"", "as", "\"", " and", " \"", "make", "\"", " were", " blocked", " in", " v", "fs", "_", "read", "(),", " likely", " reading", " from", " the", " filesystem", ".", " \"", "g", "cc", "\"", " and", " \"", "sh", "\"", " were", " waiting", " on", " child", " processes", ",", " as", " we", "'d", " expect", ".", " Plus", " there", " are", " many", " other", " threads", " waiting", " for", " work", " in", " poll", " routines", ".", " Since", " many", " threads", " can", " be", " blocked", " in", " parallel", ",", " they", " can", " add", " up", " to", " hundreds", " of", " seconds", " of", " blocked", " time", " for", " this", " 30", " second", " profile", ".", "\n", "\n", "Why", " e", "BP", "F", " Is", " So", " Important", "\n", "\n", "Off", "-", "CPU", " profiling", " has", " been", " a", " prick", "ly", " problem", " that", " can", " be", " explained", " with", " some", " math", ":", "\n", "\n", "A", " typical", " CPU", " profile", " using", " a", " system", " prof", "iler", " may", " involve", " 99", " stack", " trace", " samples", " per", " second", ",", " on", " all", " CPUs", ".", " If", " this", " were", " a", " 16", " CPU", " instance", ",", " that", "'s", " 1", ",", "584", " samples", " per", " second", ".", " Linux", " perf", "_", "events", " writes", " every", " sample", " to", " a", " perf", ".", "data", " file", " (", "in", " groups", " for", " efficiency", "),", " and", " usually", " handles", " this", " rate", " with", " low", " overhead", ".", "\n", "\n", "An", " off", "-", "CPU", " profile", " may", " involve", " tracing", " the", " sched", "uler", " task", " switch", " routine", ",", " and", " recording", " tim", "est", "amps", ",", " calculating", " off", "-", "CPU", " time", ",", " and", " saving", " this", " with", " stack", " traces", ".", " Sched", "uler", " events", " scale", " with", " load", ",", " so", " instead", " of", " maybe", " 1", ",", "584", " stack", " samples", " per", " second", ",", " this", " can", " be", " over", " 100", ",", "000", " or", " 1", " million", " per", " second", ".", " Over", "head", " can", " become", " a", " big", " problem", " fast", ",", " which", " can", " make", " this", " prohib", "itive", " for", " production", " use", ".", "\n", "\n", "This", " is", " where", " the", " new", " e", "BP", "F", " functionality", " comes", " in", ":", " my", " off", "c", "put", "ime", " script", " uses", " e", "BP", "F", " to", " sum", " off", "-", "CPU", " time", " by", " kernel", " stack", " trace", " in", " kernel", " context", " for", " efficiency", ".", " Only", " the", " summary", " is", " passed", " to", " user", "-", "level", ".", "\n", "\n", "D", "umping", " every", " event", " to", " a", " file", " (", "eg", ",", " perf", "_", "event", "'s", " perf", ".", "data", ")", " will", " become", " problematic", " before", " it", " reaches", " 100", ",", "000", " events", " per", " second", ",", " as", " it", " will", " likely", " cost", " noticeable", " CPU", " resources", " and", " start", " dropping", " events", ".", " By", " summar", "izing", " in", " kernel", " using", " e", "BP", "F", ",", " we", " can", " keep", " going", ",", " making", " this", " and", " a", " whole", " lot", " more", " practical", ".", " There", "'s", " still", " overhead", ",", " and", " you", " should", " test", " and", " quantify", " before", " production", " use", ",", " but", " it", " should", " be", " the", " least", " possible", ".", "\n", "\n", "With", " my", " e", "BP", "F", " stack", " hack", ",", " I", "'m", " able", " to", " try", " out", " off", "-", "CPU", " flame", " graphs", " now", ",", " at", " least", " for", " kernel", " stacks", ",", " on", " x", "86", "_", "64", ",", " and", " up", " to", " 20", " frames", " deep", ".", " In", " a", " future", " Linux", " version", " (", "4", ".", "5", "?),", " e", "BP", "F", " stack", " tracing", " should", " be", " supported", " properly", ",", " and", " not", " have", " these", " limitations", ".", "\n", "\n", "off", "c", "put", "ime", "\n", "\n", "The", " off", "-", "CPU", " flame", " graph", " was", " generated", " using", " off", "c", "put", "ime", " from", " b", "cc", " tools", ".", " It", " can", " emit", " folded", " output", " suitable", " for", " flame", " graph", " generation", ".", " Eg", ",", " for", " a", " 30", " second", " profile", ":", "\n", "\n", "#", "./", "off", "c", "put", "ime", " -", "f", " 30", " >", " out", ".", "off", "cp", "ust", "acks", "01", "\n", "\n", "A", " -", "u", " option", " will", " print", " only", " user", "-", "mode", " stacks", ".", " For", " example", ",", " this", " off", "-", "CPU", " flame", " graph", " is", " for", " an", " idle", " system", ",", " where", " I", " ran", " \"", "sleep", " 3", "\"", " in", " one", " window", ",", " and", " \"", "vm", "stat", " 1", "\"", " in", " another", " SVG", ":", "\n", "\n", "Can", " you", " find", " the", " sleep", " command", "?", " (", "Try", " the", " Search", " button", " in", " the", " top", " right", ".)", " The", " blocked", " time", " for", " \"", "vm", "stat", " 1", "\"", " can", " be", " seen", " on", " the", " right", ",", " which", " adds", " to", " 5", " seconds", " (", "I", " stopped", " the", " profile", " between", " 5", " and", " 6", " seconds", ").", " Both", " sleep", " and", " vm", "stat", " are", " blocked", " on", " a", " timer", ",", " which", " makes", " sense", ".", "\n", "\n", "The", " commands", " I", " used", " to", " create", " this", " were", ":", "\n", "\n", "#", "./", "off", "c", "put", "ime", " -", "uf", " >", " out", ".", "off", "cp", "ust", "acks", "02", " ^", "C", " #", "./", "flame", "graph", ".", "pl", " --", "color", "=", "io", " --", "count", "name", "=", "us", " --", "width", "=", "900", " \\", " --", "title", "=\"", "Off", "-", "CPU", " Time", " Flame", " Graph", ":", " idle", " system", "\"", " <", " out", ".", "off", "cp", "ust", "acks", "02", " >", " off", "cpu", ".", "sv", "g", "\n", "\n", "flame", "graph", ".", "pl", " is", " from", " Flame", "Graph", ".", "\n", "\n", "Other", " Tr", "acers", "\n", "\n", "I", " previously", " posted", " about", " using", " perf", "_", "events", " for", " off", "-", "CPU", " flame", " graphs", ",", " along", " with", " a", " warning", " about", " the", " prohib", "itive", " overhead", ",", " and", " a", " suggestion", " that", " this", " should", " be", " done", " using", " e", "BP", "F", ".", "\n", "\n", "D", "Tr", "ace", " and", " System", "Tap", " can", " also", " summarize", " in", " kernel", ",", " and", " can", " be", " used", " for", " off", "-", "CPU", " analysis", ".", " Y", "ich", "un", " Zhang", " first", " published", " off", "-", "CPU", " time", " flame", " graphs", " in", " his", " Introduction", " to", " off", "-", "CPU", " Time", " Flame", " Graph", "s", " (", "PDF", ")", " talk", ",", " and", " has", " the", " System", "Tap", " scripts", " in", " his", " n", "ginx", "-", "system", "tap", "-", "tool", "kit", ".", " F", "rit", "s", " Ho", "og", "land", " more", " recently", " published", " st", "ap", "flame", " as", " a", " proof", " of", " concept", ",", " which", " uses", " perf", "_", "events", " for", " CPU", " profiling", " and", " System", "Tap", " for", " off", "-", "CPU", " time", " with", " Oracle", " context", ".", "\n", "\n", "Future", " Work", "\n", "\n", "e", "BP", "F", " needs", " stack", " trace", " support", ",", " for", " both", " kernel", " and", " user", " stacks", ",", " for", " generating", " complete", " off", "-", "CPU", " time", " flame", " graphs", ".", " Perhaps", " by", " the", " time", " you", "'re", " reading", " this", ",", " it", " already", " exists", " (", "check", " the", " implementation", " of", " off", "c", "put", "ime", ").", " Other", " e", "BP", "F", " features", " will", " help", " as", " well", ":", " once", " profiling", " (", "tim", "ed", " sampling", ")", " is", " available", ",", " e", "BP", "F", " could", " do", " in", " kernel", " aggreg", "ations", " of", " the", " CPU", " profile", " as", " well", ".", " It", "'ll", " be", " great", " to", " have", " this", " in", " the", " core", " Linux", " kernel", ".", "\n", "\n", "Update", " 2017", ":", " e", "BP", "F", " stack", " support", " arrived", " in", " Linux", " 4", ".", "8", ",", " and", " off", "c", "put", "ime", " in", " b", "cc", " has", " been", " updated", " to", " use", " it", ".", "\n", "\n", "More", " information", " about", " blocked", " stacks", " should", " also", " be", " included", ".", " Sometimes", " the", " off", "-", "CPU", " stack", " is", " a", " sufficient", " clue", " as", " to", " the", " source", " of", " latency", ",", " but", " in", " many", " cases", " it", " isn", "'t", ":", " you", "'re", " blocked", " on", " a", " file", " descriptor", " (", "sys", "_", "poll", "),", " a", " mut", "ex", ",", " or", " a", " conditional", " variable", ".", " I", "'ll", " explore", " this", " in", " an", " upcoming", " post", ".", "\n", "\n", "Another", " area", " of", " future", " work", " is", " how", " to", " best", " show", " CPU", " and", " off", "-", "CPU", " flame", " graphs", " together", ".", " See", " my", " hot", "/", "cold", " flame", " graphs", " page", " for", " a", " summary", " of", " this", " work", "."]