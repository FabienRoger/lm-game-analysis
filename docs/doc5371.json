["Are", " you", " familiar", " with", " Mem", "o", "ization", "?", " Maybe", " you", "\ufffd", "\ufffd", "ve", " heard", " of", " it", ",", " but", " are", " uncertain", " how", " you", " can", " use", " it", " in", " your", " code", "?", " In", " this", " post", " you", "\ufffd", "\ufffd", "ll", " get", " an", " introductory", " look", " into", " memo", "ization", ".", " You", "\ufffd", "\ufffd", "ll", " learn", " what", " it", " is", ",", " how", " you", " can", " use", " it", " to", " speed", " up", " your", " code", ",", " and", " where", " memo", "ization", " can", " bite", " you", " in", " the", " butt", "!", "\n", "\n", "First", " off", " a", " simple", " definition", ":", "\n", "\n", "Mem", "o", "ization", " is", " the", " process", " of", " storing", " a", " computed", " value", " to", " avoid", " dupl", "icated", " work", " by", " future", " calls", ".", "\n", "\n", "Bro", "ken", " down", " into", " basics", " memo", "ization", " is", " always", " going", " to", " fit", " into", " the", " following", " pattern", ":", "\n", "\n", "Per", "form", " some", " work", " Store", " the", " work", " result", " Use", " stored", " results", " in", " future", " calls", "\n", "\n", "In", " Ruby", " the", " most", " common", " pattern", " for", " memo", "izing", " a", " call", " is", " using", " the", " conditional", " assignment", " operator", ":", " ||", "=", ".", " If", " you", "\ufffd", "\ufffd", "re", " not", " familiar", " with", " this", " operator", " I", "\ufffd", "\ufffd", "d", " suggest", " reading", " Peter", " Cooper", "\ufffd", "\ufffd", "s", " excellent", " explanation", " on", " it", ".", "\n", "\n", "Let", "\ufffd", "\ufffd", "s", " look", " at", " a", " common", " piece", " of", " code", " that", " occurs", " in", " many", " Rails", " applications", " and", " apply", " memo", "ization", " to", " it", ".", "\n", "\n", "If", " you", "\ufffd", "\ufffd", "ve", " ever", " worked", " with", " a", " user", " login", " system", ",", " you", "\ufffd", "\ufffd", "re", " likely", " familiar", " with", " the", " pattern", " of", " loading", " the", " current", "_", "user", " from", " the", " application", "_", "controller", " :", "\n", "\n", "1", " 2", " 3", " def", " current", "_", "user", " User", ".", " find", " (", " session", " [", " :", "user", "_", "id", " ]", " )", " end", "\n", "\n", "Within", " any", " one", " request", " in", " a", " Rails", " app", " you", "\ufffd", "\ufffd", "ll", " usually", " see", " multiple", " calls", " to", " current", "_", "user", " which", " means", " User", ".", "find", " is", " run", " multiple", " times", ".", " Here", "\ufffd", "\ufffd", "s", " an", " example", " console", " output", " from", " a", " request", " without", " memo", "ization", " in", " place", " for", " current", "_", "user", " :", "\n", "\n", "In", " this", " image", " that", " there", " is", " 1", " call", " to", " current", "_", "user", " that", " performs", " the", " initial", " query", ",", " then", " 5", " more", " calls", " (", "represented", " by", " C", "AC", "HE", " ).", " Those", " cache", " calls", " mean", " Rails", " is", " returning", " the", " cached", " result", " of", " the", " SQL", " query", ",", " but", " it", " doesn", "\ufffd", "\ufffd", "t", " include", " the", " cost", " of", " building", " the", " User", " object", ".", " And", " because", " Rails", " hides", " the", " cost", " of", " object", " creation", " these", " queries", " cost", " more", " than", " the", " 0", ".", "0", "ms", " and", " 0", ".", "1", "ms", " reported", "!", "\n", "\n", "As", " a", " rule", " of", " thumb", ",", " if", " you", " see", " C", "AC", "HE", " (", "X", ".", "X", "ms", ")", " you", " should", " investigate", " for", " in", "effic", "iencies", " in", " your", " code", " base", "!", "\n", "\n", "In", " our", " case", ",", " we", " know", " the", " problem", " is", " because", " there", " are", " multiple", " calls", " to", " current", "_", "user", " occurring", ".", " Let", "\ufffd", "\ufffd", "s", " fix", " this", " code", " by", " introducing", " memo", "ization", " into", " the", " current", "_", "user", " method", " and", " storing", " the", " result", " of", " User", ".", "find", " using", " conditional", " assignment", " to", " an", " instance", " variable", ":", "\n", "\n", "1", " 2", " 3", " def", " current", "_", "user", " @", "current", "_", "user", " ||", "=", " User", ".", " find", " (", " session", " [", " :", "user", "_", "id", " ]", " )", " end", "\n", "\n", "It", "\ufffd", "\ufffd", "s", " important", " to", " notice", " that", " the", " result", " of", " find", " is", " assigned", " to", " an", " instance", " variable", " instead", " of", " a", " local", " variable", ".", " If", " you", " were", " to", " use", " a", " local", " variable", " (", "a", " variable", " without", " the", " @", " symbol", ")", " then", " user", " wouldn", "\ufffd", "\ufffd", "t", " be", " stored", " and", " the", " find", " query", " would", " occur", " on", " every", " call", " to", " current", "_", "user", ".", " Nothing", " would", " have", " improved", ".", "\n", "\n", "Re", "-", "running", " the", " request", " with", " memo", "ized", " current", "_", "user", " the", " console", " output", " looks", " like", " this", ":", "\n", "\n", "All", " the", " C", "AC", "HE", " lines", " are", " gone", ",", " which", " means", " there", " are", " no", " more", " calls", " to", " rebuild", " the", " User", " object", " each", " time", " current", "_", "user", " is", " called", "!", " And", " if", " you", " look", " closely", " at", " the", " last", " line", " in", " each", " image", ",", " the", " total", " time", " drops", " 50", "ms", " by", " introducing", " memo", "ization", "!", "\n", "\n", "Like", " all", " programming", " techniques", " and", " tools", " memo", "ization", " has", " its", " place", ".", " In", " our", " case", " we", "\ufffd", "\ufffd", "re", " trading", " space", " (", "storage", " of", " the", " User", " object", ")", " for", " faster", " query", " time", ".", " The", " trick", " is", " knowing", " when", " to", " use", " it", " and", " when", " not", " to", " use", " it", ".", "\n", "\n", "When", " should", " you", " memo", "ize", "?", "\n", "\n", "When", " you", "\ufffd", "\ufffd", "ve", " got", " dupl", "icated", " database", " calls", " (", "like", " current", "_", "user", " above", ")", "\n", "\n", "above", ")", " When", " you", "\ufffd", "\ufffd", "ve", " got", " expensive", " calculations", "\n", "\n", "When", " you", "\ufffd", "\ufffd", "ve", " got", " repeated", " calculations", " that", " don", "\ufffd", "\ufffd", "t", " change", "\n", "\n", "When", " shouldn", "\ufffd", "\ufffd", "t", " you", " memo", "ize", "?", "\n", "\n", "Mem", "o", "ize", " can", " introduce", " some", " very", " subtle", " bugs", " that", " are", " hard", " to", " track", " down", ".", " Mem", "o", "ization", " shouldn", "\ufffd", "\ufffd", "t", " be", " used", " with", " methods", " that", " take", " parameters", ":", "\n", "\n", "1", " 2", " 3", " 4", " 5", " 6", " 7", " 8", " 9", " 10", " #", " incorrect", " memo", "ization", " def", " full", "_", "name", " (", " first", "_", "name", ",", " last", "_", "name", " )", " @", "full", "_", "name", " ||", "=", " \"", " #", "{", " first", "_", "name", " }", " #", "{", " last", "_", "name", " }", " \"", " end", " puts", " full", "_", "name", " (", " '", "Billy", "'", ",", " '", "Bob", "'", " )", " #", " =>", " \"", "Billy", " Bob", "\"", " puts", " full", "_", "name", " (", " '", "S", "ally", "'", ",", " '", "S", "ue", "'", " )", " #", " =>", " \"", "Billy", " Bob", "\"", "\n", "\n", "Or", " with", " methods", " that", " use", " instance", " variables", ":", "\n", "\n", "1", " 2", " 3", " 4", " 5", " 6", " 7", " 8", " 9", " 10", " 11", " 12", " 13", " 14", " 15", " 16", " #", " incorrect", " memo", "ization", " def", " full", "_", "name", " @", "full", "_", "name", " ||", "=", " \"", " #", "{", " @", "first", "_", "name", " }", " #", "{", " @", "last", "_", "name", " }", " \"", " end", " @", "first", "_", "name", " =", " '", "Billy", "'", " @", "last", "_", "name", " =", " '", "Bob", "'", " puts", " full", "_", "name", " #", " =>", " \"", "Billy", " Bob", "\"", " @", "first", "_", "name", " =", " '", "S", "ally", "'", " @", "last", "_", "name", " =", " '", "S", "ue", "'", " puts", " full", "_", "name", " #", " =>", " \"", "Billy", " Bob", "\"", "\n", "\n", "In", " both", " cases", " we", " see", " full", "_", "name", " is", " memo", "ized", " on", " the", " first", " call", " for", " '", "Billy", " Bob", "'", " and", " as", " a", " result", " the", " second", " call", " produces", " '", "Billy", " Bob", "'", " even", " though", " different", " values", " ought", " to", " be", " applied", ".", " Don", "\ufffd", "\ufffd", "t", " let", " these", " cont", "rived", " examples", " fool", " you", ",", " hitting", " problems", " like", " this", " in", " production", " code", " is", " a", " total", " pain", "!", "\n", "\n", "Be", " sure", " to", " check", " out", " the", " follow", " up", " post", " on", " advanced", " memo", "ization", " that", " shows", " you", " how", " to", " get", " around", " the", " pitfalls", " noted", " above", "!"]